const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ServiceDetailView-cq1kZPKg.js","assets/vendor-CVE7zuiC.js","assets/utils-CG2kLDjF.js","assets/ServiceDetailView-DO_sopbG.css","assets/InvoiceDetailView-6VX8o2RO.js","assets/InvoiceDetailView-oG9dMU0-.css","assets/TicketDetailView-6k66qKkC.js","assets/TicketDetailView-GH8e5TaN.css"])))=>i.map(i=>d[i]);
var e=Object.defineProperty;import{a as t,c as s}from"./utils-CG2kLDjF.js";import{d as n,r as i,c as a,a as r,u as o,w as c,o as l,b as u,e as d,f as h,g as p,h as f,i as g,n as v,t as m,T as y,j as b,F as w,k as _,l as k,m as S,p as R,q as C,s as O,v as E,x as A,y as T,z as I,A as M,B as P,C as L,D as N,E as D,G as U,H as x,I as B,J as H,K as q,L as G}from"./vendor-CVE7zuiC.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const V=t.create({baseURL:"",headers:{"Content-Type":"application/json",Accept:"application/json"},timeout:3e4});V.defaults.withCredentials=!0;const j={auth:{login:(e,t,s=!1)=>V.post("/api/v1/client/auth/login",{email:e,password:t,remember:s}),register:e=>V.post("/api/v1/client/auth/register",e),logout:()=>V.post("/api/v1/client/auth/logout"),me:()=>V.get("/api/v1/client/auth/me"),forgotPassword:e=>V.post("/api/v1/client/auth/forgot-password",{email:e}),resetPassword:(e,t,s)=>V.post("/api/v1/client/auth/reset-password",{token:e,password:t,password_confirmation:s})},realtime:{getToken:()=>V.get("/api/v1/realtime/token")},client:{dashboard:{getStats:()=>V.get("/api/v1/client/dashboard/stats"),getOverview:()=>V.get("/api/v1/client/dashboard/overview")},service:{list:e=>V.get("/api/v1/client/services",{params:e}),get:e=>V.get(`/api/v1/client/services/${e}`),getById:e=>V.get(`/api/v1/client/services/${e}`),getHistory:e=>V.get(`/api/v1/client/services/${e}/history`),getUsage:e=>V.get(`/api/v1/client/services/${e}/usage`),getRecent:()=>V.get("/api/v1/client/services/recent")},invoice:{list:e=>V.get("/api/v1/client/invoices",{params:e}),get:e=>V.get(`/api/v1/client/invoices/${e}`),getById:e=>V.get(`/api/v1/client/invoices/${e}`),downloadPdf:e=>V.get(`/api/v1/client/invoices/${e}/pdf`,{responseType:"blob"}),getRecent:()=>V.get("/api/v1/client/invoices/recent"),getUnpaid:()=>V.get("/api/v1/client/invoices/unpaid")},ticket:{list:e=>V.get("/api/v1/client/tickets",{params:e}),get:e=>V.get(`/api/v1/client/tickets/${e}`),getById:e=>V.get(`/api/v1/client/tickets/${e}`),getMessages:(e,t)=>V.get(`/api/v1/client/tickets/${e}/messages`,{params:t}),create:e=>V.post("/api/v1/client/tickets",e),addReply:(e,t)=>V.post(`/api/v1/client/tickets/${e}/messages`,t),close:e=>V.put(`/api/v1/client/tickets/${e}/close`),reopen:e=>V.put(`/api/v1/client/tickets/${e}/reopen`),getRecent:()=>V.get("/api/v1/client/tickets/recent"),getOpen:()=>V.get("/api/v1/client/tickets/open")},profile:{get:()=>V.get("/api/v1/client/profile"),update:e=>V.put("/api/v1/client/profile",e),changePassword:e=>V.post("/api/v1/client/profile/password",e)},getRealtimeToken:()=>V.get("/api/v1/client/realtime/token"),department:{list:()=>V.get("/api/v1/client/departments")},logging:{log:(e,t,s)=>V.post("/api/v1/client/log",{level:e,message:t,context:s})}}};class F{static get client(){return V}static setAuthToken(e){e?V.defaults.headers.common.Authorization=`Bearer ${e}`:delete V.defaults.headers.common.Authorization}static setupInterceptors(){V.interceptors.response.use(e=>e,e=>{var t;return 401===(null==(t=e.response)?void 0:t.status)&&(window.location.href="/client/login"),Promise.reject(e)})}}var $;async function W(e,t,s={}){try{await F.routes.client.logging.log(e,t,{...s,url:window.location.href})}catch(n){}}((t,s,n)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n})(F,"symbol"!=typeof($="routes")?$+"":$,j),F.setupInterceptors();const z={info:(e,t)=>{W("info",e,t)},debug:(e,t)=>{},warn:(e,t)=>{W("warning",e,t)},error:(e,t)=>{W("error",e,t)}},J=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,K=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,Y=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/;function Q(e,t){if(!("__proto__"===e||"constructor"===e&&t&&"object"==typeof t&&"prototype"in t))return t}function X(e,t){if(null==e)return;let s=e;for(let n=0;n<t.length;n++){if(null==s||null==s[t[n]])return;s=s[t[n]]}return s}function Z(e,t,s){if(0===s.length)return t;const n=s[0];return s.length>1&&(t=Z("object"==typeof e&&null!==e&&Object.prototype.hasOwnProperty.call(e,n)?e[n]:Number.isInteger(Number(s[1]))?[]:{},t,Array.prototype.slice.call(s,1))),Number.isInteger(Number(n))&&Array.isArray(e)?e.slice()[n]:Object.assign({},e,{[n]:t})}function ee(e,t){if(null==e||0===t.length)return e;if(1===t.length){if(null==e)return e;if(Number.isInteger(t[0])&&Array.isArray(e))return Array.prototype.slice.call(e,0).splice(t[0],1);const s={};for(const t in e)s[t]=e[t];return delete s[t[0]],s}if(null==e[t[0]]){if(Number.isInteger(t[0])&&Array.isArray(e))return Array.prototype.concat.call([],e);const s={};for(const t in e)s[t]=e[t];return s}return Z(e,ee(e[t[0]],Array.prototype.slice.call(t,1)),[t[0]])}function te(e,t){return t.map(e=>e.split(".")).map(t=>[t,X(e,t)]).filter(e=>void 0!==e[1]).reduce((e,t)=>Z(e,t[1],t[0]),{})}function se(e,t){return t.map(e=>e.split(".")).reduce((e,t)=>ee(e,t),e)}function ne(e,{storage:t,serializer:s,key:n,debug:i,pick:a,omit:r,beforeHydrate:o,afterHydrate:c},l,u=!0){try{u&&(null==o||o(l));const i=t.getItem(n);if(i){const t=s.deserialize(i),n=a?te(t,a):t,o=r?se(n,r):n;e.$patch(o)}u&&(null==c||c(l))}catch(d){}}function ie(e,{storage:t,serializer:s,key:n,debug:i,pick:a,omit:r}){try{const i=a?te(e,a):e,o=r?se(i,r):i,c=s.serialize(o);t.setItem(n,c)}catch(o){}}var ae=function(e={}){return function(t){!function(e,t,s){const{pinia:n,store:i,options:{persist:a=s}}=e;if(!a)return;if(!(i.$id in n.state.value)){const e=n._s.get(i.$id.replace("__hot:",""));return void(e&&Promise.resolve().then(()=>e.$persist()))}const r=(Array.isArray(a)?a:!0===a?[{}]:[a]).map(t);i.$hydrate=({runHooks:t=!0}={})=>{r.forEach(s=>{ne(i,s,e,t)})},i.$persist=()=>{r.forEach(e=>{ie(i.$state,e)})},r.forEach(t=>{ne(i,t,e),i.$subscribe((e,s)=>ie(s,t),{detached:!0})})}(t,s=>({key:(e.key?e.key:e=>e)(s.key??t.store.$id),debug:s.debug??e.debug??!1,serializer:s.serializer??e.serializer??{serialize:e=>JSON.stringify(e),deserialize:e=>function(e,t={}){if("string"!=typeof e)return e;if('"'===e[0]&&'"'===e[e.length-1]&&-1===e.indexOf("\\"))return e.slice(1,-1);const s=e.trim();if(s.length<=9)switch(s.toLowerCase()){case"true":return!0;case"false":return!1;case"undefined":return;case"null":return null;case"nan":return Number.NaN;case"infinity":return Number.POSITIVE_INFINITY;case"-infinity":return Number.NEGATIVE_INFINITY}if(!Y.test(e)){if(t.strict)throw new SyntaxError("[destr] Invalid JSON");return e}try{if(J.test(e)||K.test(e)){if(t.strict)throw new Error("[destr] Possible prototype pollution");return JSON.parse(e,Q)}return JSON.parse(e)}catch(n){if(t.strict)throw n;return e}}(e)},storage:s.storage??e.storage??window.localStorage,beforeHydrate:s.beforeHydrate,afterHydrate:s.afterHydrate,pick:s.pick,omit:s.omit}),e.auto??!1)}}();const re=n("clientAuth",()=>{const e=i(null),t=i(!1),s=i(null),n=i(!1),r=a(()=>!!e.value),o=a(()=>e.value?`${e.value.firstName} ${e.value.lastName}`:""),c=async()=>{var s;if(n.value)return r.value;t.value=!0;try{const t=await F.routes.auth.me();return!!(null==(s=t.data)?void 0:s.user)&&(e.value=t.data.user,!0)}catch(i){return e.value=null,!1}finally{t.value=!1,n.value=!0}};return{user:e,loading:t,error:s,initialized:n,isAuthenticated:r,userFullName:o,login:async(n,i,a=!1)=>{var r,o,c;t.value=!0,s.value=null;try{const t=await F.routes.auth.login(n,i,a);if(null==(r=t.data)?void 0:r.user)return e.value=t.data.user,!0;throw new Error("RÃ©ponse invalide du serveur")}catch(l){throw s.value=(null==(c=null==(o=l.response)?void 0:o.data)?void 0:c.message)||l.message||"Erreur de connexion",l}finally{t.value=!1}},register:async e=>{var n,i;t.value=!0,s.value=null;try{return(await F.routes.auth.register({firstname:e.firstname,lastname:e.lastname,email:e.email,company:e.company,phone:e.phone,address:e.address,postal_code:e.postal_code,city:e.city,country:e.country,password:e.password})).data}catch(a){throw s.value=(null==(i=null==(n=a.response)?void 0:n.data)?void 0:i.message)||a.message||"Erreur d'inscription",a}finally{t.value=!1}},logout:async()=>{t.value=!0;try{await F.routes.auth.logout()}catch(n){}finally{e.value=null,s.value=null,t.value=!1}},checkAuth:c,initialize:async()=>{n.value||await c()},clearError:()=>{s.value=null},updateUser:t=>{e.value&&(e.value={...e.value,...t})}}},{persist:{key:"techcms-client-auth",storage:localStorage}});var oe,ce={exports:{}};
/*@license Copyright 2015-2022 Ably Real-time Ltd (ably.com)

Ably JavaScript Library v2.9.0
https://github.com/ably/ably-js

Released under the Apache Licence v2.0*/var le,ue=oe?ce.exports:(oe=1,le=()=>{var e,t={},n={exports:t},i=Object.defineProperty,a=Object.defineProperties,r=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyDescriptors,c=Object.getOwnPropertyNames,l=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,h=(e,t,s)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,p=(e,t)=>{for(var s in t||(t={}))u.call(t,s)&&h(e,s,t[s]);if(l)for(var s of l(t))d.call(t,s)&&h(e,s,t[s]);return e},f=(e,t)=>a(e,o(t)),g=(e,t)=>{for(var s in t)i(e,s,{get:t[s],enumerable:!0})},v={};g(v,{ErrorInfo:()=>C,Realtime:()=>sn,Rest:()=>Cs,default:()=>ei,makeProtocolMessageFromDeserialized:()=>hs,msgpack:()=>Qn}),n.exports=(e=v,((e,t,s,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let a of c(t))u.call(e,a)||a===s||i(e,a,{get:()=>t[a],enumerable:!(n=r(t,a))||n.enumerable});return e})(i({},"__esModule",{value:!0}),e));var m=class{},y=void 0!==s?s:"undefined"!=typeof window?window:self;function b(e,t){return`${e}`.padStart(t?3:2,"0")}function w(e){return m.Config.logTimestamps?function(t){const s=new Date;e(b(s.getHours())+":"+b(s.getMinutes())+":"+b(s.getSeconds())+"."+b(s.getMilliseconds(),1)+" "+t)}:function(t){e(t)}}var _=class e{constructor(){this.deprecated=(e,t)=>{this.deprecationWarning(`${e} is deprecated and will be removed in a future version. ${t}`)},this.shouldLog=e=>e<=this.logLevel,this.setLog=(e,t)=>{void 0!==e&&(this.logLevel=e),void 0!==t&&(this.logHandler=this.logErrorHandler=t)},this.logLevel=e.defaultLogLevel,this.logHandler=e.defaultLogHandler,this.logErrorHandler=e.defaultLogErrorHandler}static initLogHandlers(){const[t,s]=(()=>{var e;let t,s;return"function"==typeof(null==(e=null==y?void 0:y.console)?void 0:e.log)?(t=function(...e){},s=console.warn?function(...e){}:t):t=s=function(){},[t,s].map(w)})();this.defaultLogHandler=t,this.defaultLogErrorHandler=s,this.defaultLogger=new e}static logActionNoStrip(e,t,s,n){e.logAction(t,s,n)}logAction(e,t,s){this.shouldLog(e)&&(1===e?this.logErrorHandler:this.logHandler)("Ably: "+t+": "+s,e)}renamedClientOption(e,t){this.deprecationWarning(`The \`${e}\` client option has been renamed to \`${t}\`. Please update your code to use \`${t}\` instead. \`${e}\` will be removed in a future version.`)}renamedMethod(e,t,s){this.deprecationWarning(`\`${e}\`âs \`${t}\` method has been renamed to \`${s}\`. Please update your code to use \`${s}\` instead. \`${t}\` will be removed in a future version.`)}deprecationWarning(e){this.shouldLog(1)&&this.logErrorHandler(`Ably: Deprecation warning - ${e}`,1)}};_.defaultLogLevel=1,_.LOG_NONE=0,_.LOG_ERROR=1,_.LOG_MAJOR=2,_.LOG_MINOR=3,_.LOG_MICRO=4,_.logAction=(e,t,s,n)=>{_.logActionNoStrip(e,t,s,n)};var k=_,S={};function R(e){let t="["+e.constructor.name;return e.message&&(t+=": "+e.message),e.statusCode&&(t+="; statusCode="+e.statusCode),e.code&&(t+="; code="+e.code),e.cause&&(t+="; cause="+Q(e.cause)),!e.href||e.message&&e.message.indexOf("help.ably.io")>-1||(t+="; see "+e.href+" "),t+="]",t}g(S,{Format:()=>W,allSame:()=>$,allToLowerCase:()=>re,allToUpperCase:()=>oe,arrChooseN:()=>se,arrDeleteValue:()=>q,arrEquals:()=>ge,arrIntersect:()=>B,arrIntersectOb:()=>H,arrPopRandomElement:()=>z,arrWithoutValue:()=>G,cheapRandStr:()=>ee,containsValue:()=>U,copy:()=>A,createMissingPluginError:()=>ve,dataSizeBytes:()=>Z,decodeBody:()=>ie,encodeBody:()=>ae,ensureArray:()=>T,forInOwnNonNullProperties:()=>F,getBackoffCoefficient:()=>ce,getGlobalObject:()=>de,getJitterCoefficient:()=>le,getRetryTime:()=>ue,inherits:()=>D,inspectBody:()=>X,inspectError:()=>Q,intersect:()=>x,isEmpty:()=>M,isErrorInfoOrPartialErrorInfo:()=>Y,isNil:()=>P,isObject:()=>I,keysArray:()=>V,matchDerivedChannel:()=>pe,mixin:()=>E,parseQueryString:()=>K,prototypicalClone:()=>N,randomString:()=>te,shallowClone:()=>L,shallowEquals:()=>he,throwMissingPluginError:()=>me,toBase64:()=>fe,toQueryString:()=>J,valuesArray:()=>j,whenPromiseSettles:()=>ne,withTimeoutAsync:()=>ye});var C=class e extends Error{constructor(t,s,n,i){super(t),void 0!==Object.setPrototypeOf&&Object.setPrototypeOf(this,e.prototype),this.code=s,this.statusCode=n,this.cause=i}toString(){return R(this)}static fromValues(t){const{message:s,code:n,statusCode:i}=t;if("string"!=typeof s||"number"!=typeof n||"number"!=typeof i)throw new Error("ErrorInfo.fromValues(): invalid values: "+m.Config.inspect(t));const a=Object.assign(new e(s,n,i),t);return a.code&&!a.href&&(a.href="https://help.ably.io/error/"+a.code),a}},O=class e extends Error{constructor(t,s,n,i){super(t),void 0!==Object.setPrototypeOf&&Object.setPrototypeOf(this,e.prototype),this.code=s,this.statusCode=n,this.cause=i}toString(){return R(this)}static fromValues(t){const{message:s,code:n,statusCode:i}=t;if("string"!=typeof s||!P(n)&&"number"!=typeof n||!P(i)&&"number"!=typeof i)throw new Error("PartialErrorInfo.fromValues(): invalid values: "+m.Config.inspect(t));const a=Object.assign(new e(s,n,i),t);return a.code&&!a.href&&(a.href="https://help.ably.io/error/"+a.code),a}};function E(e,...t){for(let s=0;s<t.length;s++){const n=t[s];if(!n)break;for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e}function A(e){return E({},e)}function T(e){return P(e)?[]:Array.isArray(e)?e:[e]}function I(e){return"[object Object]"==Object.prototype.toString.call(e)}function M(e){for(const t in e)return!1;return!0}function P(e){return null==e}function L(e){const t=new Object;for(const s in e)t[s]=e[s];return t}function N(e,t){class s{}s.prototype=e;const n=new s;return t&&E(n,t),n}var D=function(e,t){m.Config.inherits?m.Config.inherits(e,t):(e.super_=t,e.prototype=N(t.prototype,{constructor:e}))};function U(e,t){for(const s in e)if(e[s]==t)return!0;return!1}function x(e,t){return Array.isArray(t)?B(e,t):H(e,t)}function B(e,t){const s=[];for(let n=0;n<e.length;n++){const i=e[n];-1!=t.indexOf(i)&&s.push(i)}return s}function H(e,t){const s=[];for(let n=0;n<e.length;n++){const i=e[n];i in t&&s.push(i)}return s}function q(e,t){const s=e.indexOf(t),n=-1!=s;return n&&e.splice(s,1),n}function G(e,t){const s=e.slice();return q(s,t),s}function V(e,t){const s=[];for(const n in e)t&&!Object.prototype.hasOwnProperty.call(e,n)||s.push(n);return s}function j(e,t){const s=[];for(const n in e)t&&!Object.prototype.hasOwnProperty.call(e,n)||s.push(e[n]);return s}function F(e,t){for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&e[s]&&t(s)}function $(e,t){if(0===e.length)return!0;const s=e[0][t];return e.every(function(e){return e[t]===s})}var W=(e=>(e.msgpack="msgpack",e.json="json",e))(W||{});function z(e){return e.splice((t=e,Math.floor(Math.random()*t.length)),1)[0];var t}function J(e){const t=[];if(e)for(const s in e)t.push(encodeURIComponent(s)+"="+encodeURIComponent(e[s]));return t.length?"?"+t.join("&"):""}function K(e){let t;const s=/([^?&=]+)=?([^&]*)/g,n={};for(;t=s.exec(e);)n[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return n}function Y(e){return"object"==typeof e&&null!==e&&(e instanceof C||e instanceof O)}function Q(e){var t,s;return e instanceof Error||"ErrorInfo"===(null==(t=null==e?void 0:e.constructor)?void 0:t.name)||"PartialErrorInfo"===(null==(s=null==e?void 0:e.constructor)?void 0:s.name)?e.toString():m.Config.inspect(e)}function X(e){return m.BufferUtils.isBuffer(e)?e.toString():"string"==typeof e?e:m.Config.inspect(e)}function Z(e){if(m.BufferUtils.isBuffer(e))return m.BufferUtils.byteLength(e);if("string"==typeof e)return m.Config.stringByteSize(e);if("number"==typeof e)return 8;if("boolean"==typeof e)return 1;throw new Error("Expected input of Utils.dataSizeBytes to be a string, a number, a boolean or a buffer, but was: "+typeof e)}function ee(){return String(Math.random()).substr(2)}var te=async e=>{const t=await m.Config.getRandomArrayBuffer(e);return m.BufferUtils.base64Encode(t)};function se(e,t){const s=Math.min(t,e.length),n=e.slice(),i=[];for(let a=0;a<s;a++)i.push(z(n));return i}function ne(e,t){e.then(e=>{null==t||t(null,e)}).catch(e=>{null==t||t(e)})}function ie(e,t,s){return"msgpack"==s?(t||me("MsgPack"),t.decode(e)):JSON.parse(String(e))}function ae(e,t,s){return"msgpack"==s?(t||me("MsgPack"),t.encode(e,!0)):JSON.stringify(e)}function re(e){return e.map(function(e){return e&&e.toLowerCase()})}function oe(e){return e.map(function(e){return e&&e.toUpperCase()})}function ce(e){return Math.min((e+2)/3,2)}function le(){return 1-.2*Math.random()}function ue(e,t){return e*ce(t)*le()}function de(){return void 0!==s?s:"undefined"!=typeof window?window:self}function he(e,t){return Object.keys(e).every(s=>e[s]===t[s])&&Object.keys(t).every(s=>t[s]===e[s])}function pe(e){const t=e.match(/^(\[([^?]*)(?:(.*))\])?(.+)$/);if(!t||!t.length||t.length<5)throw new C("regex match failed",400,40010);if(t[2])throw new C(`cannot use a derived option with a ${t[2]} channel`,400,40010);return{qualifierParam:t[3]||"",channelName:t[4]}}function fe(e){const t=m.BufferUtils,s=t.utf8Encode(e);return t.base64Encode(s)}function ge(e,t){return e.length===t.length&&e.every(function(e,s){return e===t[s]})}function ve(e){return new C(`${e} plugin not provided`,40019,400)}function me(e){throw ve(e)}async function ye(e,t=5e3,s="Timeout expired"){const n=new C(s,5e4,500);return Promise.race([e,new Promise((e,s)=>setTimeout(()=>s(n),t))])}var be="2.9.0",we={ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:1e4,httpMaxRetryDuration:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,webSocketConnectTimeout:1e4,webSocketSlowTimeout:4e3},httpMaxRetryCount:3,maxMessageSize:65536,version:be,protocolVersion:3,agent:"ably-js/"+be,getHost:_e,getPort:function(e,t){return t||e.tls?e.tlsPort:e.port},getHttpScheme:function(e){return e.tls?"https://":"http://"},environmentFallbackHosts:ke,getFallbackHosts:Se,getHosts:function(e,t){const s=[e.restHost].concat(Se(e));return t?s.map(t=>_e(e,t,!0)):s},checkHost:Re,objectifyOptions:function(e,t,s,n,i){if(void 0===e){const e=t?`${s} must be initialized with either a client options object, an Ably API key, or an Ably Token`:`${s} must be initialized with a client options object`;throw k.logAction(n,k.LOG_ERROR,`${s}()`,e),new Error(e)}let a;if("string"==typeof e)if(-1==e.indexOf(":")){if(!t){const e=`${s} cannot be initialized with just an Ably Token; you must provide a client options object with a \`plugins\` property. (Set this Ably Token as the objectâs \`token\` property.)`;throw k.logAction(n,k.LOG_ERROR,`${s}()`,e),new Error(e)}a={token:e}}else{if(!t){const e=`${s} cannot be initialized with just an Ably API key; you must provide a client options object with a \`plugins\` property. (Set this Ably API key as the objectâs \`key\` property.)`;throw k.logAction(n,k.LOG_ERROR,`${s}()`,e),new Error(e)}a={key:e}}else a=e;return i&&(a=f(p({},a),{plugins:p(p({},i),a.plugins)})),a},normaliseOptions:function(e,t,s){const n=null!=s?s:k.defaultLogger;"function"==typeof e.recover&&!0===e.closeOnUnload&&(k.logAction(n,k.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),e.recover=void 0),"closeOnUnload"in e||(e.closeOnUnload=!e.recover),"queueMessages"in e||(e.queueMessages=!0);const i=e.environment&&String(e.environment).toLowerCase()||we.ENVIRONMENT,a=!i||"production"===i;e.fallbackHosts||e.restHost||e.realtimeHost||e.port||e.tlsPort||(e.fallbackHosts=a?we.FALLBACK_HOSTS:ke(i));const r=e.restHost||(a?we.REST_HOST:i+"-"+we.REST_HOST),o=function(e,t,s,n){return e.realtimeHost?e.realtimeHost:e.restHost?(k.logAction(n,k.LOG_MINOR,"Defaults.normaliseOptions",'restHost is set to "'+e.restHost+'" but realtimeHost is not set, so setting realtimeHost to "'+e.restHost+'" too. If this is not what you want, please set realtimeHost explicitly.'),e.restHost):t?we.REALTIME_HOST:s+"-"+we.REALTIME_HOST}(e,a,i,n);(e.fallbackHosts||[]).concat(r,o).forEach(Re),e.port=e.port||we.PORT,e.tlsPort=e.tlsPort||we.TLS_PORT,"tls"in e||(e.tls=!0);const c=function(e){const t={};for(const s in we.TIMEOUTS)t[s]=e[s]||we.TIMEOUTS[s];return t}(e);e.useBinaryProtocol=!!t&&("useBinaryProtocol"in e?m.Config.supportsBinary&&e.useBinaryProtocol:m.Config.preferBinary);const l={};e.clientId&&(l["X-Ably-ClientId"]=m.BufferUtils.base64Encode(m.BufferUtils.utf8Encode(e.clientId))),"idempotentRestPublishing"in e||(e.idempotentRestPublishing=!0);let u=null,d=e.connectivityCheckUrl;if(e.connectivityCheckUrl){let[t,s]=e.connectivityCheckUrl.split("?");u=s?K(s):{},-1===t.indexOf("://")&&(t="https://"+t),d=t}let h=e.wsConnectivityCheckUrl;return h&&-1===h.indexOf("://")&&(h="wss://"+h),f(p({},e),{realtimeHost:o,restHost:r,maxMessageSize:e.maxMessageSize||we.maxMessageSize,timeouts:c,connectivityCheckParams:u,connectivityCheckUrl:d,wsConnectivityCheckUrl:h,headers:l})},defaultGetHeaders:function(e,{format:t=Ae.format,protocolVersion:s=Ae.protocolVersion}={}){return{accept:Ee[t],"X-Ably-Version":s.toString(),"Ably-Agent":Ce(e)}},defaultPostHeaders:function(e,{format:t=Ae.format,protocolVersion:s=Ae.protocolVersion}={}){let n;return{accept:n=Ee[t],"content-type":n,"X-Ably-Version":s.toString(),"Ably-Agent":Ce(e)}}};function _e(e,t,s){return t=s?t==e.restHost&&e.realtimeHost||t||e.realtimeHost:t||e.restHost}function ke(e){return[e+"-a-fallback.ably-realtime.com",e+"-b-fallback.ably-realtime.com",e+"-c-fallback.ably-realtime.com",e+"-d-fallback.ably-realtime.com",e+"-e-fallback.ably-realtime.com"]}function Se(e){const t=e.fallbackHosts,s=void 0!==e.httpMaxRetryCount?e.httpMaxRetryCount:we.httpMaxRetryCount;return t?se(t,s):[]}function Re(e){if("string"!=typeof e)throw new C("host must be a string; was a "+typeof e,4e4,400);if(!e.length)throw new C("host must not be zero-length",4e4,400)}function Ce(e){let t=we.agent;if(e.agents)for(var s in e.agents)t+=" "+s+"/"+e.agents[s];return t}function Oe(e,t,s){const n=s||{};if(n.cipher){e||me("Crypto");const s=e.getCipher(n.cipher,t);n.cipher=s.cipherParams,n.channelCipher=s.cipher}else"cipher"in n&&(n.cipher=void 0,n.channelCipher=null);return n}var Ee={json:"application/json",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack",text:"text/plain"},Ae={format:"json",protocolVersion:we.protocolVersion},Te=we,Ie=class e{constructor(e,t){this.logger=e,this.members=t||[]}call(e,t){for(const n of this.members)if(n)try{n(e,t)}catch(s){k.logAction(this.logger,k.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+s+"; stack = "+s.stack)}}push(...e){this.members.push(...e)}createPromise(){return new Promise((e,t)=>{this.push((s,n)=>{s?t(s):e(n)})})}resolveAll(e){this.call(null,e)}rejectAll(e){this.call(e)}static create(t,s){const n=new e(t,s);return Object.assign((e,t)=>n.call(e,t),{push:e=>n.push(e),createPromise:()=>n.createPromise(),resolveAll:e=>n.resolveAll(e),rejectAll:e=>n.rejectAll(e)})}},Me=(e=>(e.Get="get",e.Delete="delete",e.Post="post",e.Put="put",e.Patch="patch",e))(Me||{}),Pe=Me,Le=(e=>(e[e.Success=200]="Success",e[e.NoContent=204]="NoContent",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.Forbidden=403]="Forbidden",e[e.RequestTimeout=408]="RequestTimeout",e[e.InternalServerError=500]="InternalServerError",e))(Le||{}),Ne=Le,De=Math.pow(2,17);function Ue(e){return Y(e)?(e.code||(403===e.statusCode?e.code=40300:(e.code=40170,e.statusCode=401)),e):new C(Q(e),e.code||40170,e.statusCode||401)}function xe(e){if(!e)return"";"string"==typeof e&&(e=JSON.parse(e));const t=Object.create(null),s=V(e,!0);if(!s)return"";s.sort();for(let n=0;n<s.length;n++)t[s[n]]=e[s[n]].sort();return JSON.stringify(t)}function Be(e,t){if(e.authCallback)k.logAction(t,k.LOG_MINOR,"Auth()","using token auth with authCallback");else if(e.authUrl)k.logAction(t,k.LOG_MINOR,"Auth()","using token auth with authUrl");else if(e.key)k.logAction(t,k.LOG_MINOR,"Auth()","using token auth with client-side signing");else{if(!e.tokenDetails){const e="authOptions must include valid authentication parameters";throw k.logAction(t,k.LOG_ERROR,"Auth()",e),new Error(e)}k.logAction(t,k.LOG_MINOR,"Auth()","using token auth with supplied token only")}}function He(e){return e.useTokenAuth||!function(e){return"useTokenAuth"in e&&!e.useTokenAuth}(e)&&(e.authCallback||e.authUrl||e.token||e.tokenDetails)}var qe=0,Ge=class{constructor(e,t){if(this.authOptions={},this.client=e,this.tokenParams=t.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,He(t))(function(e){return!e.key&&!e.authCallback&&!e.authUrl})(t)&&k.logAction(this.logger,k.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(t.defaultTokenParams,t),Be(this.authOptions,this.logger);else{if(!t.key){const e="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw k.logAction(this.logger,k.LOG_ERROR,"Auth()",e),new C(e,40160,401)}k.logAction(this.logger,k.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(t)}}get logger(){return this.client.logger}async authorize(e,t){if(t&&t.key&&this.authOptions.key!==t.key)throw new C("Unable to update auth options with incompatible key",40102,401);try{let s=await this._forceNewToken(null!=e?e:null,null!=t?t:null);return this.client.connection?new Promise((e,t)=>{this.client.connection.connectionManager.onAuthUpdated(s,(s,n)=>s?t(s):e(n))}):s}catch(s){throw this.client.connection&&s.statusCode===Ne.Forbidden&&this.client.connection.connectionManager.actOnErrorFromAuthorize(s),s}}async _forceNewToken(e,t){this.tokenDetails=null,this._saveTokenOptions(e,t),Be(this.authOptions,this.logger);try{return this._ensureValidAuthCredentials(!0)}finally{delete this.tokenParams.timestamp,delete this.authOptions.queryTime}}async requestToken(e,t){const s=t||this.authOptions,n=e||A(this.tokenParams);let i,a=this.client;if(s.authCallback)k.logAction(this.logger,k.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),i=s.authCallback;else if(s.authUrl)k.logAction(this.logger,k.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),i=(e,t)=>{const n=E({accept:"application/json, text/plain"},s.authHeaders),i=s.authMethod&&"post"===s.authMethod.toLowerCase();let a;const r=s.authUrl.indexOf("?");r>-1&&(a=K(s.authUrl.slice(r)),s.authUrl=s.authUrl.slice(0,r),i||(s.authParams=E(a,s.authParams)));const o=E({},s.authParams||{},e),c=e=>{var s,n;let i=null!=(s=e.body)?s:null,a=null;if(e.error)k.logAction(this.logger,k.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+Q(e.error));else{const t=null!=(n=e.headers["content-type"])?n:null;a=Array.isArray(t)?t.join(", "):t,k.logAction(this.logger,k.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+a+"; body: "+X(i))}if(e.error)return void t(e.error,null);if(e.unpacked)return void t(null,i);if(m.BufferUtils.isBuffer(i)&&(i=i.toString()),!a)return void t(new C("authUrl response is missing a content-type header",40170,401),null);const r=a.indexOf("application/json")>-1,o=a.indexOf("text/plain")>-1||a.indexOf("application/jwt")>-1;if(r||o){if(r){if(i.length>De)return void t(new C("authUrl response exceeded max permitted length",40170,401),null);try{i=JSON.parse(i)}catch(c){return void t(new C("Unexpected error processing authURL response; err = "+c.message,40170,401),null)}}t(null,i,a)}else t(new C("authUrl responded with unacceptable content-type "+a+", should be either text/plain, application/jwt or application/json",40170,401),null)};if(k.logAction(this.logger,k.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+s.authUrl+"; Params: "+JSON.stringify(o)+"; method: "+(i?"POST":"GET")),i){const e=n||{};e["content-type"]="application/x-www-form-urlencoded";const t=J(o).slice(1);ne(this.client.http.doUri(Pe.Post,s.authUrl,e,t,a),(e,t)=>c(e||t))}else ne(this.client.http.doUri(Pe.Get,s.authUrl,n||{},null,o),(e,t)=>c(e||t))};else{if(!s.key){const e="Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)";throw k.logAction(this.logger,k.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),new C(e,40171,403)}k.logAction(this.logger,k.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),i=(e,t)=>{ne(this.createTokenRequest(e,s),(e,s)=>t(e,null!=s?s:null))}}"capability"in n&&(n.capability=xe(n.capability));const r=(e,t)=>{const n="/keys/"+e.keyName+"/requestToken",i=Te.defaultPostHeaders(this.client.options);s.requestHeaders&&E(i,s.requestHeaders),k.logAction(this.logger,k.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+n+"; Token params: "+JSON.stringify(e)),ne(this.client.http.do(Pe.Post,function(e){return a.baseUri(e)+n},i,JSON.stringify(e),null),(e,s)=>e?t(e):t(s.error,s.body,s.unpacked))};return new Promise((e,t)=>{let a=!1,o=this.client.options.timeouts.realtimeRequestTimeout,c=setTimeout(()=>{a=!0;const e="Token request callback timed out after "+o/1e3+" seconds";k.logAction(this.logger,k.LOG_ERROR,"Auth.requestToken()",e),t(new C(e,40170,401))},o);i(n,(n,i,o)=>{if(a)return;if(clearTimeout(c),n)return k.logAction(this.logger,k.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+Q(n)),void t(Ue(n));if("string"==typeof i)return void(0===i.length?t(new C("Token string is empty",40170,401)):i.length>De?t(new C("Token string exceeded max permitted length (was "+i.length+" bytes)",40170,401)):"undefined"===i||"null"===i?t(new C("Token string was literal null/undefined",40170,401)):"{"!==i[0]||o&&o.indexOf("application/jwt")>-1?e({token:i}):t(new C("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401)));if("object"!=typeof i||null===i){const e="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof i;return k.logAction(this.logger,k.LOG_ERROR,"Auth.requestToken()",e),void t(new C(e,40170,401))}const l=JSON.stringify(i).length;if(l>De&&!s.suppressMaxLengthCheck)t(new C("Token request/details object exceeded max permitted stringified size (was "+l+" bytes)",40170,401));else if("issued"in i)e(i);else{if(!("keyName"in i)){const e="Expected token request callback to call back with a token string, token request object, or token details object";return k.logAction(this.logger,k.LOG_ERROR,"Auth.requestToken()",e),void t(new C(e,40170,401))}r(i,(s,n,i)=>{if(s)return k.logAction(this.logger,k.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+Q(s)),void t(Ue(s));i||(n=JSON.parse(n)),k.logAction(this.logger,k.LOG_MINOR,"Auth.getToken()","token received"),e(n)})}})})}async createTokenRequest(e,t){t=t||this.authOptions,e=e||A(this.tokenParams);const s=t.key;if(!s)throw new C("No key specified",40101,403);const n=s.split(":"),i=n[0],a=n[1];if(!a)throw new C("Invalid key specified",40101,403);if(""===e.clientId)throw new C("clientId canât be an empty string",40012,400);"capability"in e&&(e.capability=xe(e.capability));const r=E({keyName:i},e),o=e.clientId||"",c=e.ttl||"",l=e.capability||"";r.timestamp||(r.timestamp=await this._getTimestamp(t&&t.queryTime));const u=r.nonce||(r.nonce=("000000"+Math.floor(1e16*Math.random())).slice(-16)),d=r.timestamp,h=r.keyName+"\n"+c+"\n"+l+"\n"+o+"\n"+d+"\n"+u+"\n";return r.mac=r.mac||((e,t)=>{const s=m.BufferUtils,n=s.utf8Encode(e),i=s.utf8Encode(t),a=s.hmacSha256(n,i);return s.base64Encode(a)})(h,a),k.logAction(this.logger,k.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),r}async getAuthParams(){if("basic"==this.method)return{key:this.key};{let e=await this._ensureValidAuthCredentials(!1);if(!e)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{access_token:e.token}}}async getAuthHeaders(){if("basic"==this.method)return{authorization:"Basic "+this.basicKey};{const e=await this._ensureValidAuthCredentials(!1);if(!e)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{authorization:"Bearer "+fe(e.token)}}}_saveBasicOptions(e){this.method="basic",this.key=e.key,this.basicKey=fe(e.key),this.authOptions=e||{},"clientId"in e&&this._userSetClientId(e.clientId)}_saveTokenOptions(e,t){this.method="token",e&&(this.tokenParams=e),t&&(t.token&&(t.tokenDetails="string"==typeof t.token?{token:t.token}:t.token),t.tokenDetails&&(this.tokenDetails=t.tokenDetails),"clientId"in t&&this._userSetClientId(t.clientId),this.authOptions=t)}async _ensureValidAuthCredentials(e){const t=this.tokenDetails;if(t){if(this._tokenClientIdMismatch(t.clientId))throw new C("Mismatch between clientId in token ("+t.clientId+") and current clientId ("+this.clientId+")",40102,403);if(!this.client.isTimeOffsetSet()||!t.expires||t.expires>=this.client.getTimestampUsingOffset())return k.logAction(this.logger,k.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+t.expires),t;k.logAction(this.logger,k.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}const s=(this.waitingForTokenRequest||(this.waitingForTokenRequest=Ie.create(this.logger))).createPromise();if(null!==this.currentTokenRequestId&&!e)return s;const n=this.currentTokenRequestId=qe++;let i,a=null;try{i=await this.requestToken(this.tokenParams,this.authOptions)}catch(o){a=o}if(this.currentTokenRequestId>n)return k.logAction(this.logger,k.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"),s;this.currentTokenRequestId=null;const r=this.waitingForTokenRequest;return this.waitingForTokenRequest=null,a?(null==r||r.rejectAll(a),s):(null==r||r.resolveAll(this.tokenDetails=i),s)}_userSetClientId(e){if("string"!=typeof e&&null!==e)throw new C("clientId must be either a string or null",40012,400);if("*"===e)throw new C('Canât use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);{const t=this._uncheckedSetClientId(e);if(t)throw t}}_uncheckedSetClientId(e){if(this._tokenClientIdMismatch(e)){const t="Unexpected clientId mismatch: client has "+this.clientId+", requested "+e,s=new C(t,40102,401);return k.logAction(this.logger,k.LOG_ERROR,"Auth._uncheckedSetClientId()",t),s}return this.clientId=this.tokenParams.clientId=e,null}_tokenClientIdMismatch(e){return!(!this.clientId||"*"===this.clientId||!e||"*"===e||this.clientId===e)}static isTokenErr(e){return e.code&&e.code>=40140&&e.code<40150}revokeTokens(e,t){return this.client.rest.revokeTokens(e,t)}async _getTimestamp(e){return this.client.getTimestamp(e||!!this.authOptions.queryTime)}};function Ve(e){const t=[];if(e)for(const s in e)t.push(s+"="+e[s]);return t.join("&")}function je(e,t){return e+(t?"?":"")+Ve(t)}var Fe=class{constructor(e){this.client=e,this.platformHttp=new m.Http(e),this.checkConnectivity=this.platformHttp.checkConnectivity?()=>this.platformHttp.checkConnectivity():void 0}get logger(){var e,t;return null!=(t=null==(e=this.client)?void 0:e.logger)?t:k.defaultLogger}get supportsAuthHeaders(){return this.platformHttp.supportsAuthHeaders}get supportsLinkHeaders(){return this.platformHttp.supportsLinkHeaders}_getHosts(e){const t=e.connection,s=t&&t.connectionManager.host;return s?[s].concat(Te.getFallbackHosts(e.options)):Te.getHosts(e.options)}async do(e,t,s,n,i){try{const a=this.client;if(!a)return{error:new C("http.do called without client",5e4,500)};const r="function"==typeof t?t:function(e){return a.baseUri(e)+t},o=a._currentFallback;if(o){if(o.validUntil>Date.now()){const c=await this.doUri(e,r(o.host),s,n,i);return c.error&&this.platformHttp.shouldFallback(c.error)?(a._currentFallback=null,this.do(e,t,s,n,i)):c}a._currentFallback=null}const c=this._getHosts(a);if(1===c.length)return this.doUri(e,r(c[0]),s,n,i);let l=null;const u=async(t,o)=>{const c=t.shift();l=null!=l?l:new Date;const d=await this.doUri(e,r(c),s,n,i);return d.error&&this.platformHttp.shouldFallback(d.error)&&t.length?Date.now()-l.getTime()>a.options.timeouts.httpMaxRetryDuration?{error:new C(`Timeout for trying fallback hosts retries. Total elapsed time exceeded the ${a.options.timeouts.httpMaxRetryDuration}ms limit`,50003,500)}:u(t,!0):(o&&(a._currentFallback={host:c,validUntil:Date.now()+a.options.timeouts.fallbackRetryTimeout}),d)};return u(c)}catch(a){return{error:new C(`Unexpected error in Http.do: ${Q(a)}`,500,5e4)}}}async doUri(e,t,s,n,i){try{!function(e,t,s,n,i){i.shouldLog(k.LOG_MICRO)&&k.logActionNoStrip(i,k.LOG_MICRO,"Http."+e+"()","Sending; "+je(t,n)+"; Body"+(m.BufferUtils.isBuffer(s)?" (Base64): "+m.BufferUtils.base64Encode(s):": "+s))}(e,t,n,i,this.logger);const a=await this.platformHttp.doUri(e,t,s,n,i);return this.logger.shouldLog(k.LOG_MICRO)&&function(e,t,s,n,i){e.error?k.logActionNoStrip(i,k.LOG_MICRO,"Http."+t+"()","Received Error; "+je(s,n)+"; Error: "+Q(e.error)):k.logActionNoStrip(i,k.LOG_MICRO,"Http."+t+"()","Received; "+je(s,n)+"; Headers: "+Ve(e.headers)+"; StatusCode: "+e.statusCode+"; Body"+(m.BufferUtils.isBuffer(e.body)?" (Base64): "+m.BufferUtils.base64Encode(e.body):": "+e.body))}(a,e,t,i,this.logger),a}catch(a){return{error:new C(`Unexpected error in Http.doUri: ${Q(a)}`,500,5e4)}}}};function $e(e,t,s){let n,i,a;for(let r=0;r<e.length;r++)if(n=e[r],s&&(n=n[s]),Array.isArray(n)){for(;-1!==(i=n.indexOf(t));)n.splice(i,1);s&&0===n.length&&delete e[r][s]}else if(I(n))for(a in n)Object.prototype.hasOwnProperty.call(n,a)&&Array.isArray(n[a])&&$e([n],t,a)}var We=class{constructor(e){this.logger=e,this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}on(...e){if(1===e.length){const t=e[0];if("function"!=typeof t)throw new Error("EventListener.on(): Invalid arguments: "+m.Config.inspect(e));this.any.push(t)}if(2===e.length){const[t,s]=e;if("function"!=typeof s)throw new Error("EventListener.on(): Invalid arguments: "+m.Config.inspect(e));if(P(t))this.any.push(s);else if(Array.isArray(t))t.forEach(e=>{this.on(e,s)});else{if("string"!=typeof t)throw new Error("EventListener.on(): Invalid arguments: "+m.Config.inspect(e));(this.events[t]||(this.events[t]=[])).push(s)}}}off(...e){if(0==e.length||P(e[0])&&P(e[1]))return this.any=[],this.events=Object.create(null),this.anyOnce=[],void(this.eventsOnce=Object.create(null));const[t,s]=e;let n=null,i=null;if(1!==e.length&&s){if("function"!=typeof s)throw new Error("EventEmitter.off(): invalid arguments:"+m.Config.inspect(e));[i,n]=[t,s]}else"function"==typeof t?n=t:i=t;if(n&&P(i))$e([this.any,this.events,this.anyOnce,this.eventsOnce],n);else if(Array.isArray(i))i.forEach(e=>{this.off(e,n)});else{if("string"!=typeof i)throw new Error("EventEmitter.off(): invalid arguments:"+m.Config.inspect(e));n?$e([this.events,this.eventsOnce],n,i):(delete this.events[i],delete this.eventsOnce[i])}}listeners(e){if(e){const t=this.events[e]||[];return this.eventsOnce[e]&&Array.prototype.push.apply(t,this.eventsOnce[e]),t.length?t:null}return this.any.length?this.any:null}emit(e,...t){const s={event:e},n=[];this.anyOnce.length&&(Array.prototype.push.apply(n,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(n,this.any);const i=this.eventsOnce[e];i&&(Array.prototype.push.apply(n,i),delete this.eventsOnce[e]);const a=this.events[e];a&&Array.prototype.push.apply(n,a),n.forEach(e=>{!function(e,t,s,n){try{s.apply(t,n)}catch(i){k.logAction(e,k.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+i+"; stack = "+(i&&i.stack))}}(this.logger,s,e,t)})}once(...e){const t=e.length;if(0===t||1===t&&"function"!=typeof e[0]){const t=e[0];return new Promise(e=>{this.once(t,e)})}const[s,n]=e;if(1===e.length&&"function"==typeof s)this.anyOnce.push(s);else if(P(s)){if("function"!=typeof n)throw new Error("EventEmitter.once(): Invalid arguments:"+m.Config.inspect(e));this.anyOnce.push(n)}else if(Array.isArray(s)){const t=this,i=function(){const a=Array.prototype.slice.call(arguments);if(s.forEach(function(e){t.off(e,i)}),"function"!=typeof n)throw new Error("EventEmitter.once(): Invalid arguments:"+m.Config.inspect(e));n.apply(this,a)};s.forEach(function(e){t.on(e,i)})}else{if("string"!=typeof s)throw new Error("EventEmitter.once(): Invalid arguments:"+m.Config.inspect(e));const t=this.eventsOnce[s]||(this.eventsOnce[s]=[]);if(n){if("function"!=typeof n)throw new Error("EventEmitter.once(): Invalid arguments:"+m.Config.inspect(e));t.push(n)}}}async whenState(e,t){if("string"!=typeof e||"string"!=typeof t)throw new Error("whenState requires a valid state String argument");return e===t?null:this.once(e)}},ze={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17,ACTIVATE:18,OBJECT:19,OBJECT_SYNC:20,ANNOTATION:21},Je=[];Object.keys(ze).forEach(function(e){Je[ze[e]]=e});var Ke={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,HAS_OBJECTS:128,PRESENCE:65536,PUBLISH:1<<17,SUBSCRIBE:1<<18,PRESENCE_SUBSCRIBE:1<<19,ANNOTATION_PUBLISH:1<<21,ANNOTATION_SUBSCRIBE:1<<22,OBJECT_SUBSCRIBE:1<<24,OBJECT_PUBLISH:1<<25},Ye=Object.keys(Ke);Ke.MODE_ALL=Ke.PRESENCE|Ke.PUBLISH|Ke.SUBSCRIBE|Ke.PRESENCE_SUBSCRIBE|Ke.ANNOTATION_PUBLISH|Ke.ANNOTATION_SUBSCRIBE|Ke.OBJECT_SUBSCRIBE|Ke.OBJECT_PUBLISH;var Qe=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE","ANNOTATION_PUBLISH","ANNOTATION_SUBSCRIBE","OBJECT_SUBSCRIBE","OBJECT_PUBLISH"];function Xe(e,t,s){if(s&&s.cipher){e||me("Crypto");const n=e.getCipher(s.cipher,t);return{cipher:n.cipherParams,channelCipher:n.cipher}}return null!=s?s:{}}async function Ze(e,t,s){let n=s.channelCipher,i=e,a=t?t+"/":"";m.BufferUtils.isBuffer(i)||(i=m.BufferUtils.utf8Encode(String(i)),a+="utf-8/");const r=await n.encrypt(i);return a=a+"cipher+"+n.algorithm,{data:r,encoding:a}}async function et(e,t){const s="string"==typeof e.data||m.BufferUtils.isBuffer(e.data)||null===e.data||void 0===e.data,{data:n,encoding:i}=tt(e.data,e.encoding,s);return e.data=n,e.encoding=i,null!=t&&t.cipher?async function(e,t){const{data:s,encoding:n}=await Ze(e.data,e.encoding,t);return e.data=s,e.encoding=n,e}(e,t):e}function tt(e,t,s){if(s)return{data:e,encoding:t};if(I(e)||Array.isArray(e))return{data:JSON.stringify(e),encoding:t?t+"/json":"json"};throw new C("Data type is unsupported",40013,400)}async function st(e,t){const{data:s,encoding:n,error:i}=await nt(e.data,e.encoding,t);if(e.data=s,e.encoding=n,i)throw i}async function nt(e,t,s){const n=function(e){return e&&e.channelOptions?e:{channelOptions:e,plugins:{},baseEncodedPreviousPayload:void 0}}(s);let i,a=e,r=e,o=t;if(t){const e=t.split("/");let s,l=e.length,u="";try{for(;(s=l)>0;){const t=e[--l].match(/([-\w]+)(\+([\w-]+))?/);if(!t)break;switch(u=t[1],u){case"base64":r=m.BufferUtils.base64Decode(String(r)),s==e.length&&(a=r);continue;case"utf-8":r=m.BufferUtils.utf8Decode(r);continue;case"json":r=JSON.parse(r);continue;case"cipher":if(null!=n.channelOptions&&n.channelOptions.cipher&&n.channelOptions.channelCipher){const e=t[3],s=n.channelOptions.channelCipher;if(e!=s.algorithm)throw new Error("Unable to decrypt message with given cipher; incompatible cipher params");r=await s.decrypt(r);continue}throw new Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!n.plugins||!n.plugins.vcdiff)throw new C("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if("undefined"==typeof Uint8Array)throw new C("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{let e=n.baseEncodedPreviousPayload;"string"==typeof e&&(e=m.BufferUtils.utf8Encode(e));const t=m.BufferUtils.toBuffer(e);r=m.BufferUtils.toBuffer(r),r=m.BufferUtils.arrayBufferViewToBuffer(n.plugins.vcdiff.decode(r,t)),a=r}catch(c){throw new C("Vcdiff delta decode failed with "+c,40018,400)}continue;default:throw new Error("Unknown encoding")}}}catch(c){const e=c;i=new C(`Error processing the ${u} encoding, decoder returned â${e.message}â`,e.code||40013,400)}finally{o=s<=0?null:e.slice(0,s).join("/")}}return i?{error:i,data:r,encoding:o}:(n.baseEncodedPreviousPayload=a,{data:r,encoding:o})}function it(...e){const t=e.length>0?"json":"msgpack",{data:s,encoding:n}=at(this.data,this.encoding,t);return Object.assign({},this,{encoding:n,data:s})}function at(e,t,s){return e&&m.BufferUtils.isBuffer(e)?"msgpack"===s?{data:m.BufferUtils.toBuffer(e),encoding:t}:{data:m.BufferUtils.base64Encode(e),encoding:t?t+"/base64":"base64"}:{data:e,encoding:t}}var rt={encryptData:Ze,encodeData:tt,encodeDataForWire:at,decodeData:nt};function ot(e){const{id:t,connectionId:s,timestamp:n}=e;let i;switch(e.action){case ze.MESSAGE:i=e.messages;break;case ze.PRESENCE:case ze.SYNC:i=e.presence;break;case ze.ANNOTATION:i=e.annotations;break;case ze.OBJECT:case ze.OBJECT_SYNC:i=e.state;break;default:throw new C("Unexpected action "+e.action,4e4,400)}for(let a=0;a<i.length;a++){const e=i[a];e.connectionId||(e.connectionId=s),e.timestamp||(e.timestamp=n),t&&!e.id&&(e.id=t+":"+a)}}function ct(e,t){let s="["+t;for(const n in e)"data"===n?"string"==typeof e.data?s+="; data="+e.data:m.BufferUtils.isBuffer(e.data)?s+="; data (buffer)="+m.BufferUtils.base64Encode(e.data):void 0!==e.data&&(s+="; data (json)="+JSON.stringify(e.data)):!n||"extras"!==n&&"operation"!==n?void 0!==e[n]&&(s+="; "+n+"="+e[n]):s+="; "+n+"="+JSON.stringify(e[n]);return s+="]",s}var lt=class{},ut=class{constructor(e){var t,s,n,i,a,r,o,c,l,u;this.Platform=m,this.ErrorInfo=C,this.Logger=k,this.Defaults=Te,this.Utils=S,this.EventEmitter=We,this.MessageEncoding=rt,this._additionalHTTPRequestImplementations=null!=(t=e.plugins)?t:null,this.logger=new k,this.logger.setLog(e.logLevel,e.logHandler),k.logAction(this.logger,k.LOG_MICRO,"BaseClient()","initialized with clientOptions "+m.Config.inspect(e)),this._MsgPack=null!=(n=null==(s=e.plugins)?void 0:s.MsgPack)?n:null;const d=this.options=Te.normaliseOptions(e,this._MsgPack,this.logger);if(d.key){const e=d.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!e){const e="invalid key parameter";throw k.logAction(this.logger,k.LOG_ERROR,"BaseClient()",e),new C(e,40400,404)}d.keyName=e[1],d.keySecret=e[2]}if("clientId"in d){if("string"!=typeof d.clientId&&null!==d.clientId)throw new C("clientId must be either a string or null",40012,400);if("*"===d.clientId)throw new C('Canât use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}k.logAction(this.logger,k.LOG_MINOR,"BaseClient()","started; version = "+Te.version),this._currentFallback=null,this.serverTimeOffset=null,this.http=new Fe(this),this.auth=new Ge(this,d),this._rest=(null==(i=e.plugins)?void 0:i.Rest)?new e.plugins.Rest(this):null,this._Crypto=null!=(r=null==(a=e.plugins)?void 0:a.Crypto)?r:null,this.__FilteredSubscriptions=null!=(c=null==(o=e.plugins)?void 0:o.MessageInteractions)?c:null,this._Annotations=null!=(u=null==(l=e.plugins)?void 0:l.Annotations)?u:null}get rest(){return this._rest||me("Rest"),this._rest}get _FilteredSubscriptions(){return this.__FilteredSubscriptions||me("MessageInteractions"),this.__FilteredSubscriptions}get channels(){return this.rest.channels}get push(){return this.rest.push}device(){var e;return(null==(e=this.options.plugins)?void 0:e.Push)&&this.push.LocalDevice||me("Push"),this._device||(this._device=this.push.LocalDevice.load(this)),this._device}baseUri(e){return Te.getHttpScheme(this.options)+e+":"+Te.getPort(this.options,!1)}async stats(e){return this.rest.stats(e)}async time(e){return this.rest.time(e)}async request(e,t,s,n,i,a){return this.rest.request(e,t,s,n,i,a)}batchPublish(e){return this.rest.batchPublish(e)}batchPresence(e){return this.rest.batchPresence(e)}setLog(e){this.logger.setLog(e.level,e.handler)}async getTimestamp(e){return!this.isTimeOffsetSet()&&e?this.time():this.getTimestampUsingOffset()}getTimestampUsingOffset(){return Date.now()+(this.serverTimeOffset||0)}isTimeOffsetSet(){return null!==this.serverTimeOffset}};ut.Platform=m;var dt=ut,ht=class e{toJSON(){var e,t,s;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:null==(e=this.push)?void 0:e.recipient,state:null==(t=this.push)?void 0:t.state,error:null==(s=this.push)?void 0:s.error}}}toString(){var e,t,s,n;let i="[DeviceDetails";return this.id&&(i+="; id="+this.id),this.platform&&(i+="; platform="+this.platform),this.formFactor&&(i+="; formFactor="+this.formFactor),this.clientId&&(i+="; clientId="+this.clientId),this.metadata&&(i+="; metadata="+this.metadata),this.deviceIdentityToken&&(i+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),(null==(e=this.push)?void 0:e.recipient)&&(i+="; push.recipient="+JSON.stringify(this.push.recipient)),(null==(t=this.push)?void 0:t.state)&&(i+="; push.state="+this.push.state),(null==(s=this.push)?void 0:s.error)&&(i+="; push.error="+JSON.stringify(this.push.error)),(null==(n=this.push)?void 0:n.metadata)&&(i+="; push.metadata="+this.push.metadata),i+="]",i}static toRequestBody(e,t,s){return ae(e,t,s)}static fromResponseBody(t,s,n){return n&&(t=ie(t,s,n)),Array.isArray(t)?e.fromValuesArray(t):e.fromValues(t)}static fromValues(t){return t.error=t.error&&C.fromValues(t.error),Object.assign(new e,t)}static fromLocalDevice(t){return Object.assign(new e,t)}static fromValuesArray(t){const s=t.length,n=new Array(s);for(let i=0;i<s;i++)n[i]=e.fromValues(t[i]);return n}};async function pt(e,t,s,n){return e.http.supportsAuthHeaders?n(E(await e.auth.getAuthHeaders(),t),s):n(t,E(await e.auth.getAuthParams(),s))}var ft=class e{static async get(t,s,n,i,a,r){return e.do(Pe.Get,t,s,null,n,i,a,null!=r&&r)}static async delete(t,s,n,i,a,r){return e.do(Pe.Delete,t,s,null,n,i,a,r)}static async post(t,s,n,i,a,r,o){return e.do(Pe.Post,t,s,n,i,a,r,o)}static async patch(t,s,n,i,a,r,o){return e.do(Pe.Patch,t,s,n,i,a,r,o)}static async put(t,s,n,i,a,r,o){return e.do(Pe.Put,t,s,n,i,a,r,o)}static async do(e,t,s,n,i,a,r,o){r&&((a=a||{}).envelope=r);const c=t.logger;let l=await pt(t,i,a,async function i(a,r){var o;if(c.shouldLog(k.LOG_MICRO)){let i=n;if((null==(o=a["content-type"])?void 0:o.indexOf("msgpack"))>0)try{t._MsgPack||me("MsgPack"),i=t._MsgPack.decode(n)}catch(u){k.logAction(c,k.LOG_MICRO,"Resource."+e+"()","Sending MsgPack Decoding Error: "+Q(u))}k.logAction(c,k.LOG_MICRO,"Resource."+e+"()","Sending; "+je(s,r)+"; Body: "+i)}const l=await t.http.do(e,s,a,n,r);return l.error&&Ge.isTokenErr(l.error)?(await t.auth.authorize(null,null),pt(t,a,r,i)):{err:l.error,body:l.body,headers:l.headers,unpacked:l.unpacked,statusCode:l.statusCode}});if(r&&(l=function(e,t,s){if(e.err&&!e.body)return{err:e.err};if(e.statusCode===Ne.NoContent)return f(p({},e),{body:[],unpacked:!0});let n=e.body;if(!e.unpacked)try{n=ie(n,t,s)}catch(o){return Y(o)?{err:o}:{err:new O(Q(o),null)}}if(!n)return{err:new O("unenvelope(): Response body is missing",null)};const{statusCode:i,response:a,headers:r}=n;if(void 0===i)return f(p({},e),{body:n,unpacked:!0});if(i<200||i>=300){let t=a&&a.error||e.err;return t||(t=new Error("Error in unenveloping "+n),t.statusCode=i),{err:t,body:a,headers:r,unpacked:!0,statusCode:i}}return{err:e.err,body:a,headers:r,unpacked:!0,statusCode:i}}(l,t._MsgPack,r)),c.shouldLog(k.LOG_MICRO)&&function(e,t,s,n,i){e.err?k.logAction(i,k.LOG_MICRO,"Resource."+t+"()","Received Error; "+je(s,n)+"; Error: "+Q(e.err)):k.logAction(i,k.LOG_MICRO,"Resource."+t+"()","Received; "+je(s,n)+"; Headers: "+Ve(e.headers)+"; StatusCode: "+e.statusCode+"; Body: "+(m.BufferUtils.isBuffer(e.body)?" (Base64): "+m.BufferUtils.base64Encode(e.body):": "+m.Config.inspect(e.body)))}(l,e,s,a,c),o){if(l.err)throw l.err;{const e=p({},l);return delete e.err,e}}return l}};function gt(e){const t=e.match(/^\.\/(\w+)\?(.*)$/);return t&&t[2]&&K(t[2])}var vt=class{constructor(e,t,s){this.resource=e,this.items=t,this._relParams=s}async first(){if(this.hasFirst())return this.get(this._relParams.first);throw new C("No link to the first page of results",40400,404)}async current(){if(this.hasCurrent())return this.get(this._relParams.current);throw new C("No link to the current page of results",40400,404)}async next(){return this.hasNext()?this.get(this._relParams.next):null}hasFirst(){return null!=this._relParams&&"first"in this._relParams}hasCurrent(){return null!=this._relParams&&"current"in this._relParams}hasNext(){return null!=this._relParams&&"next"in this._relParams}isLast(){return!this.hasNext()}async get(e){const t=this.resource,s=await ft.get(t.client,t.path,t.headers,e,t.envelope,!1);return t.handlePage(s)}},mt=class extends vt{constructor(e,t,s,n,i,a){super(e,t,i),this.statusCode=n,this.success=n<300&&n>=200,this.headers=s,this.errorCode=a&&a.code,this.errorMessage=a&&a.message}toJSON(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}}},yt=class{constructor(e,t,s,n,i,a){this.client=e,this.path=t,this.headers=s,this.envelope=null!=n?n:null,this.bodyHandler=i,this.useHttpPaginatedResponse=a||!1}get logger(){return this.client.logger}async get(e){const t=await ft.get(this.client,this.path,this.headers,e,this.envelope,!1);return this.handlePage(t)}async delete(e){const t=await ft.delete(this.client,this.path,this.headers,e,this.envelope,!1);return this.handlePage(t)}async post(e,t){const s=await ft.post(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(s)}async put(e,t){const s=await ft.put(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(s)}async patch(e,t){const s=await ft.patch(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(s)}async handlePage(e){if(e.err&&(t=e.err,s=e.body,!this.useHttpPaginatedResponse||!s&&"number"!=typeof t.code))throw k.logAction(this.logger,k.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+Q(e.err)),e.err;var t,s;let n,i,a;try{n=e.statusCode==Ne.NoContent?[]:await this.bodyHandler(e.body,e.headers||{},e.unpacked)}catch(r){throw e.err||r}return e.headers&&(i=e.headers.Link||e.headers.link)&&(a=function(e){"string"==typeof e&&(e=e.split(","));const t={};for(let s=0;s<e.length;s++){const n=e[s].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(n){const e=gt(n[1]);e&&(t[n[2]]=e)}}return t}(i)),this.useHttpPaginatedResponse?new mt(this,n,e.headers||{},e.statusCode,a,e.err):new vt(this,n,a)}},bt=class e{toJSON(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}}toString(){let e="[PushChannelSubscription";return this.channel&&(e+="; channel="+this.channel),this.deviceId&&(e+="; deviceId="+this.deviceId),this.clientId&&(e+="; clientId="+this.clientId),e+="]",e}static fromResponseBody(t,s,n){return n&&(t=ie(t,s,n)),Array.isArray(t)?e.fromValuesArray(t):e.fromValues(t)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){const s=t.length,n=new Array(s);for(let i=0;i<s;i++)n[i]=e.fromValues(t[i]);return n}};bt.toRequestBody=ae;var wt=bt,_t=class{constructor(e){this.client=e,this.deviceRegistrations=new kt(e),this.channelSubscriptions=new St(e)}async publish(e,t){const s=this.client,n=s.options.useBinaryProtocol?"msgpack":"json",i=Te.defaultPostHeaders(s.options,{format:n}),a={},r=E({recipient:e},t);E(i,s.options.headers),s.options.pushFullWait&&E(a,{fullWait:"true"});const o=ae(r,s._MsgPack,n);await ft.post(s,"/push/publish",o,i,a,null,!0)}},kt=class{constructor(e){this.client=e}async save(e){const t=this.client,s=ht.fromValues(e),n=t.options.useBinaryProtocol?"msgpack":"json",i=Te.defaultPostHeaders(t.options,{format:n}),a={};E(i,t.options.headers),t.options.pushFullWait&&E(a,{fullWait:"true"});const r=ae(s,t._MsgPack,n),o=await ft.put(t,"/push/deviceRegistrations/"+encodeURIComponent(e.id),r,i,a,null,!0);return ht.fromResponseBody(o.body,t._MsgPack,o.unpacked?void 0:n)}async get(e){const t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",n=Te.defaultGetHeaders(t.options,{format:s}),i=e.id||e;if("string"!=typeof i||!i.length)throw new C("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400);E(n,t.options.headers);const a=await ft.get(t,"/push/deviceRegistrations/"+encodeURIComponent(i),n,{},null,!0);return ht.fromResponseBody(a.body,t._MsgPack,a.unpacked?void 0:s)}async list(e){const t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",n=this.client.http.supportsLinkHeaders?void 0:s,i=Te.defaultGetHeaders(t.options,{format:s});return E(i,t.options.headers),new yt(t,"/push/deviceRegistrations",i,n,async function(e,n,i){return ht.fromResponseBody(e,t._MsgPack,i?void 0:s)}).get(e)}async remove(e){const t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",n=Te.defaultGetHeaders(t.options,{format:s}),i={},a=e.id||e;if("string"!=typeof a||!a.length)throw new C("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400);E(n,t.options.headers),t.options.pushFullWait&&E(i,{fullWait:"true"}),await ft.delete(t,"/push/deviceRegistrations/"+encodeURIComponent(a),n,i,null,!0)}async removeWhere(e){const t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",n=Te.defaultGetHeaders(t.options,{format:s});E(n,t.options.headers),t.options.pushFullWait&&E(e,{fullWait:"true"}),await ft.delete(t,"/push/deviceRegistrations",n,e,null,!0)}},St=class e{constructor(t){this.remove=e.prototype.removeWhere,this.client=t}async save(e){const t=this.client,s=wt.fromValues(e),n=t.options.useBinaryProtocol?"msgpack":"json",i=Te.defaultPostHeaders(t.options,{format:n}),a={};E(i,t.options.headers),t.options.pushFullWait&&E(a,{fullWait:"true"});const r=ae(s,t._MsgPack,n),o=await ft.post(t,"/push/channelSubscriptions",r,i,a,null,!0);return wt.fromResponseBody(o.body,t._MsgPack,o.unpacked?void 0:n)}async list(e){const t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",n=this.client.http.supportsLinkHeaders?void 0:s,i=Te.defaultGetHeaders(t.options,{format:s});return E(i,t.options.headers),new yt(t,"/push/channelSubscriptions",i,n,async function(e,n,i){return wt.fromResponseBody(e,t._MsgPack,i?void 0:s)}).get(e)}async removeWhere(e){const t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",n=Te.defaultGetHeaders(t.options,{format:s});E(n,t.options.headers),t.options.pushFullWait&&E(e,{fullWait:"true"}),await ft.delete(t,"/push/channelSubscriptions",n,e,null,!0)}async listChannels(e){const t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",n=this.client.http.supportsLinkHeaders?void 0:s,i=Te.defaultGetHeaders(t.options,{format:s});return E(i,t.options.headers),t.options.pushFullWait&&E(e,{fullWait:"true"}),new yt(t,"/push/channels",i,n,async function(e,n,i){const a=!i&&s?ie(e,t._MsgPack,s):e;for(let t=0;t<a.length;t++)a[t]=String(a[t]);return a}).get(e)}},Rt=class{constructor(e){var t;this.client=e,this.admin=new _t(e),m.Config.push&&(null==(t=e.options.plugins)?void 0:t.Push)&&(this.stateMachine=new e.options.plugins.Push.ActivationStateMachine(e),this.LocalDevice=e.options.plugins.Push.localDeviceFactory(ht))}async activate(e,t){await new Promise((s,n)=>{var i;(null==(i=this.client.options.plugins)?void 0:i.Push)?this.stateMachine?this.stateMachine.activatedCallback?n(new C("Activation already in progress",4e4,400)):(this.stateMachine.activatedCallback=e=>{e?n(e):s()},this.stateMachine.updateFailedCallback=t,this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledActivate(this.stateMachine,e))):n(new C("This platform is not supported as a target of push notifications",4e4,400)):n(ve("Push"))})}async deactivate(e){await new Promise((t,s)=>{var n;(null==(n=this.client.options.plugins)?void 0:n.Push)?this.stateMachine?this.stateMachine.deactivatedCallback?s(new C("Deactivation already in progress",4e4,400)):(this.stateMachine.deactivatedCallback=e=>{e?s(e):t()},this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledDeactivate(this.stateMachine,e))):s(new C("This platform is not supported as a target of push notifications",4e4,400)):s(ve("Push"))})}},Ct=["absent","present","enter","leave","update"];async function Ot(e,t,s,n){const i=Xe(t,e,null!=n?n:null);return Tt.fromValues(s).decode(i,e)}async function Et(e,t){return Promise.all(e.map(function(e){return async function(e,t){return Tt.fromValues(e).decode(t.channelOptions,t.logger)}(e,t)}))}var At=class e extends lt{isSynthesized(){return!this.id||!this.connectionId||this.id.substring(this.connectionId.length,0)!==this.connectionId}parseId(){if(!this.id)throw new Error("parseId(): Presence message does not contain an id");const e=this.id.split(":");return{connectionId:e[0],msgSerial:parseInt(e[1],10),index:parseInt(e[2],10)}}async encode(e){return et(Object.assign(new Tt,this,{action:Ct.indexOf(this.action||"present")}),e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}static fromData(t){return t instanceof e?t:e.fromValues({data:t})}toString(){return ct(this,"PresenceMessage")}},Tt=class e extends lt{toJSON(...e){return it.call(this,...e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}async decode(e,t){const s=Object.assign(new At,f(p({},this),{action:Ct[this.action]}));try{await st(s,e)}catch(n){k.logAction(t,k.LOG_ERROR,"WirePresenceMessage.decode()",Q(n))}return s}toString(){return ct(this,"WirePresenceMessage")}},It=At,Mt=class{constructor(e){this.channel=e}get logger(){return this.channel.logger}async get(e){k.logAction(this.logger,k.LOG_MICRO,"RestPresence.get()","channel = "+this.channel.name);const t=this.channel.client,s=t.options.useBinaryProtocol?"msgpack":"json",n=this.channel.client.http.supportsLinkHeaders?void 0:s,i=Te.defaultGetHeaders(t.options,{format:s});return E(i,t.options.headers),new yt(t,this.channel.client.rest.presenceMixin.basePath(this),i,n,async(e,n,i)=>Et(i?e:ie(e,t._MsgPack,s),this.channel)).get(e)}async history(e){return k.logAction(this.logger,k.LOG_MICRO,"RestPresence.history()","channel = "+this.channel.name),this.channel.client.rest.presenceMixin.history(this,e)}},Pt=["message.create","message.update","message.delete","meta","message.summary"];function Lt(e){let t=0;return e.name&&(t+=e.name.length),e.clientId&&(t+=e.clientId.length),e.extras&&(t+=JSON.stringify(e.extras).length),e.data&&(t+=Z(e.data)),t}async function Nt(e,t,s,n){const i=Xe(t,e,null!=n?n:null);return qt.fromValues(s).decode(i,e)}async function Dt(e,t){return Promise.all(e.map(function(e){return async function(e,t){return qt.fromValues(e).decode(t.channelOptions,t.logger)}(e,t)}))}async function Ut(e,t){return Promise.all(e.map(e=>e.encode(t)))}var xt=ae;function Bt(e){let t,s=0;for(let n=0;n<e.length;n++)t=e[n],s+=t.size||(t.size=Lt(t));return s}var Ht=class e extends lt{expandFields(){"message.create"===this.action&&(this.version&&!this.serial&&(this.serial=this.version),this.timestamp&&!this.createdAt&&(this.createdAt=this.timestamp))}async encode(e){return et(Object.assign(new qt,this,{action:Pt.indexOf(this.action||"message.create")}),e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}toString(){return ct(this,"Message")}},qt=class e extends lt{toJSON(...e){return it.call(this,...e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}async decodeWithErr(e,t){const s=Object.assign(new Ht,f(p({},this),{action:(n=this.action,Pt[n||0]||"unknown")}));var n;let i;try{await st(s,e)}catch(a){k.logAction(t,k.LOG_ERROR,"WireMessage.decode()",Q(a)),i=a}return s.expandFields(),{decoded:s,err:i}}async decode(e,t){const{decoded:s}=await this.decodeWithErr(e,t);return s}toString(){return ct(this,"WireMessage")}},Gt=Ht,Vt=class{constructor(e,t,s){var n,i;this._annotations=null,k.logAction(e.logger,k.LOG_MINOR,"RestChannel()","started; name = "+t),this.name=t,this.client=e,this.presence=new Mt(this),this.channelOptions=Oe(null!=(n=e._Crypto)?n:null,this.logger,s),(null==(i=e.options.plugins)?void 0:i.Push)&&(this._push=new e.options.plugins.Push.PushChannel(this)),e._Annotations&&(this._annotations=new e._Annotations.RestAnnotations(this))}get annotations(){return this._annotations||me("Annotations"),this._annotations}get push(){return this._push||me("Push"),this._push}get logger(){return this.client.logger}setOptions(e){var t;this.channelOptions=Oe(null!=(t=this.client._Crypto)?t:null,this.logger,e)}async history(e){return k.logAction(this.logger,k.LOG_MICRO,"RestChannel.history()","channel = "+this.name),this.client.rest.channelMixin.history(this,e)}async publish(...e){const t=e[0],s=e[1];let n,i;if("string"==typeof t||null===t)n=[Gt.fromValues({name:t,data:s})],i=e[2];else if(I(t))n=[Gt.fromValues(t)],i=e[1];else{if(!Array.isArray(t))throw new C("The single-argument form of publish() expects a message object or an array of message objects",40013,400);n=Gt.fromValuesArray(t),i=e[1]}i||(i={});const a=this.client,r=a.options,o=r.useBinaryProtocol?"msgpack":"json",c=a.options.idempotentRestPublishing,l=Te.defaultPostHeaders(a.options,{format:o});if(E(l,r.headers),c&&function(e){return e.every(function(e){return!e.id})}(n)){const e=await te(9);n.forEach(function(t,s){t.id=e+":"+s.toString()})}const u=await Ut(n,this.channelOptions),d=Bt(u),h=r.maxMessageSize;if(d>h)throw new C(`Maximum size of messages that can be published at once exceeded (was ${d} bytes; limit is ${h} bytes)`,40009,400);await this._publish(xt(u,a._MsgPack,o),l,i)}async _publish(e,t,s){await ft.post(this.client,this.client.rest.channelMixin.basePath(this)+"/messages",e,t,s,null,!0)}async status(){return this.client.rest.channelMixin.status(this)}},jt=class e{constructor(e){this.entries=e&&e.entries||void 0,this.schema=e&&e.schema||void 0,this.appId=e&&e.appId||void 0,this.inProgress=e&&e.inProgress||void 0,this.unit=e&&e.unit||void 0,this.intervalId=e&&e.intervalId||void 0}static fromValues(t){return new e(t)}},Ft=class{static basePath(e){return"/channels/"+encodeURIComponent(e.name)}static history(e,t){const s=e.client,n=s.options.useBinaryProtocol?"msgpack":"json",i=e.client.http.supportsLinkHeaders?void 0:n,a=Te.defaultGetHeaders(s.options,{format:n});return E(a,s.options.headers),new yt(s,this.basePath(e)+"/messages",a,i,async function(t,i,a){return Dt(a?t:ie(t,s._MsgPack,n),e)}).get(t)}static async status(e){const t=e.client.options.useBinaryProtocol?"msgpack":"json",s=Te.defaultPostHeaders(e.client.options,{format:t});return(await ft.get(e.client,this.basePath(e),s,{},t,!0)).body}},$t=class{static basePath(e){return Ft.basePath(e.channel)+"/presence"}static async history(e,t){const s=e.channel.client,n=s.options.useBinaryProtocol?"msgpack":"json",i=e.channel.client.http.supportsLinkHeaders?void 0:n,a=Te.defaultGetHeaders(s.options,{format:n});return E(a,s.options.headers),new yt(s,this.basePath(e)+"/history",a,i,async(t,i,a)=>Et(a?t:ie(t,s._MsgPack,n),e.channel)).get(t)}},Wt=class{constructor(e){this.channelMixin=Ft,this.presenceMixin=$t,this.Resource=ft,this.PaginatedResource=yt,this.DeviceDetails=ht,this.PushChannelSubscription=wt,this.client=e,this.channels=new zt(this.client),this.push=new Rt(this.client)}async stats(e){const t=Te.defaultGetHeaders(this.client.options),s=this.client.options.useBinaryProtocol?"msgpack":"json",n=this.client.http.supportsLinkHeaders?void 0:s;return E(t,this.client.options.headers),new yt(this.client,"/stats",t,n,function(e,t,s){const n=s?e:JSON.parse(e);for(let i=0;i<n.length;i++)n[i]=jt.fromValues(n[i]);return n}).get(e)}async time(e){const t=Te.defaultGetHeaders(this.client.options);this.client.options.headers&&E(t,this.client.options.headers);let{error:s,body:n,unpacked:i}=await this.client.http.do(Pe.Get,e=>this.client.baseUri(e)+"/time",t,null,e);if(s)throw s;i||(n=JSON.parse(n));const a=n[0];if(!a)throw new C("Internal error (unexpected result type from GET /time)",5e4,500);return this.client.serverTimeOffset=a-Date.now(),a}async request(e,t,s,n,i,a){var r;const[o,c,l]=(()=>this.client.options.useBinaryProtocol?(this.client._MsgPack||me("MsgPack"),[this.client._MsgPack.encode,this.client._MsgPack.decode,"msgpack"]):[JSON.stringify,JSON.parse,"json"])(),u=this.client.http.supportsLinkHeaders?void 0:l;n=n||{};const d=e.toLowerCase(),h="get"==d?Te.defaultGetHeaders(this.client.options,{format:l,protocolVersion:s}):Te.defaultPostHeaders(this.client.options,{format:l,protocolVersion:s});"string"!=typeof i&&(i=null!=(r=o(i))?r:null),E(h,this.client.options.headers),a&&E(h,a);const p=new yt(this.client,t,h,u,async function(e,t,s){return T(s?e:c(e))},!0);if(!m.Http.methods.includes(d))throw new C("Unsupported method "+d,40500,405);return m.Http.methodsWithBody.includes(d)?p[d](n,i):p[d](n)}async batchPublish(e){let t,s;Array.isArray(e)?(t=e,s=!1):(t=[e],s=!0);const n=this.client.options.useBinaryProtocol?"msgpack":"json",i=Te.defaultPostHeaders(this.client.options,{format:n});this.client.options.headers&&E(i,this.client.options.headers);const a=ae(t,this.client._MsgPack,n),r=await ft.post(this.client,"/messages",a,i,{},null,!0),o=r.unpacked?r.body:ie(r.body,this.client._MsgPack,n);return s?o[0]:o}async batchPresence(e){const t=this.client.options.useBinaryProtocol?"msgpack":"json",s=Te.defaultPostHeaders(this.client.options,{format:t});this.client.options.headers&&E(s,this.client.options.headers);const n=e.join(","),i=await ft.get(this.client,"/presence",s,{channels:n},null,!0);return i.unpacked?i.body:ie(i.body,this.client._MsgPack,t)}async revokeTokens(e,t){if(He(this.client.options))throw new C("Cannot revoke tokens when using token auth",40162,401);const s=this.client.options.keyName;let n=null!=t?t:{};const i=p({targets:e.map(e=>`${e.type}:${e.value}`)},n),a=this.client.options.useBinaryProtocol?"msgpack":"json",r=Te.defaultPostHeaders(this.client.options,{format:a});this.client.options.headers&&E(r,this.client.options.headers);const o=ae(i,this.client._MsgPack,a),c=await ft.post(this.client,`/keys/${s}/revokeTokens`,o,r,{},null,!0);return c.unpacked?c.body:ie(c.body,this.client._MsgPack,a)}},zt=class{constructor(e){this.client=e,this.all=Object.create(null)}get(e,t){e=String(e);let s=this.all[e];return s?t&&s.setOptions(t):this.all[e]=s=new Vt(this.client,e,t),s}release(e){delete this.all[String(e)]}},Jt=class extends dt{constructor(e){super(Te.objectifyOptions(e,!1,"BaseRest",k.defaultLogger,{Rest:Wt}))}},Kt={Rest:Wt},Yt=class extends Gt{static async fromEncoded(e,t){return Nt(k.defaultLogger,m.Crypto,e,t)}static async fromEncodedArray(e,t){return async function(e,t,s,n){return Promise.all(s.map(function(s){return Nt(e,t,s,n)}))}(k.defaultLogger,m.Crypto,e,t)}static fromValues(e){return Gt.fromValues(e)}},Qt=class extends It{static async fromEncoded(e,t){return Ot(k.defaultLogger,m.Crypto,e,t)}static async fromEncodedArray(e,t){return async function(e,t,s,n){return Promise.all(s.map(function(s){return Ot(e,t,s,n)}))}(k.defaultLogger,m.Crypto,e,t)}static fromValues(e){return It.fromValues(e)}},Xt=["annotation.create","annotation.delete"];async function Zt(e,t,s){return ss.fromValues(t).decode(s||{},e)}async function es(e,t){return Promise.all(e.map(function(e){return async function(e,t){return ss.fromValues(e).decode(t.channelOptions,t.logger)}(e,t)}))}var ts=class e extends lt{async encode(){return et(Object.assign(new ss,this,{action:Xt.indexOf(this.action||"annotation.create")}),{})}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}toString(){return ct(this,"Annotation")}},ss=class e extends lt{toJSON(...e){return it.call(this,...e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}async decode(e,t){const s=Object.assign(new ts,f(p({},this),{action:Xt[this.action]}));try{await st(s,e)}catch(n){k.logAction(t,k.LOG_ERROR,"WireAnnotation.decode()",Q(n))}return s}toString(){return ct(this,"WireAnnotation")}},ns=ts,is=class extends ns{static async fromEncoded(e,t){return Zt(k.defaultLogger,e,t)}static async fromEncodedArray(e,t){return async function(e,t,s){return Promise.all(t.map(function(t){return Zt(e,t,s)}))}(k.defaultLogger,e,t)}static fromValues(e){return ns.fromValues(e)}};function as(e){let t;switch(typeof e){case"string":t=e;break;case"object":t=e.serial}if(!t||"string"!=typeof t)throw new C("First argument of annotations.publish() must be either a Message (or at least an object with a string `serial` property) or a message serial (string)",40003,400);return t}function rs(e,t){const s=as(e);if(!t||"object"!=typeof t)throw new C("Second argument of annotations.publish() must be an object (the intended annotation to publish)",40003,400);const n=ns.fromValues(t);return n.messageSerial=s,n.action||(n.action="annotation.create"),n}function os(e,t){return e.client.rest.channelMixin.basePath(e)+"/messages/"+encodeURIComponent(t)+"/annotations"}var cs=class{constructor(e){this.channel=e}async publish(e,t){const s=rs(e,t),n=await s.encode(),i=this.channel.client,a=i.options.useBinaryProtocol?"msgpack":"json",r=Te.defaultPostHeaders(i.options,{format:a});E(r,i.options.headers);const o=ae([n],i._MsgPack,a);await ft.post(i,os(this.channel,s.messageSerial),o,r,{},null,!0)}async delete(e,t){return t.action="annotation.delete",this.publish(e,t)}async get(e,t){const s=this.channel.client,n=as(e),i=s.options.useBinaryProtocol?"msgpack":"json",a=s.http.supportsLinkHeaders?void 0:i,r=Te.defaultGetHeaders(s.options,{format:i});return E(r,s.options.headers),new yt(s,os(this.channel,n),r,a,async(e,t,n)=>es(n?e:ie(e,s._MsgPack,i),this.channel)).get(t)}},ls=ae;function us(e){const t=[];if(e)for(let s=0;s<e.length;s++)t.push(e[s].toString());return"[ "+t.join(", ")+" ]"}function ds(e,t,s,n){let i,a,r,o,c;return e.error&&(i=C.fromValues(e.error)),e.messages&&(a=qt.fromValuesArray(e.messages)),t&&e.presence&&(r=t.WirePresenceMessage.fromValuesArray(e.presence)),s&&e.annotations&&(o=s.WireAnnotation.fromValuesArray(e.annotations)),n&&e.state&&(c=n.ObjectMessage.fromValuesArray(e.state,S,rt)),Object.assign(new gs,f(p({},e),{presence:r,messages:a,annotations:o,state:c,error:i}))}function hs(e){return t=>{var s;return ds(t,{WirePresenceMessage:Tt},{WireAnnotation:ss},null!=(s=null==e?void 0:e.ObjectsPlugin)?s:null)}}function ps(e){return Object.assign(new gs,e)}function fs(e,t,s,n){let i="[ProtocolMessage";void 0!==e.action&&(i+="; action="+Je[e.action]||e.action);const a=["id","channel","channelSerial","connectionId","count","msgSerial","timestamp"];let r;for(let o=0;o<a.length;o++)r=a[o],void 0!==e[r]&&(i+="; "+r+"="+e[r]);if(e.messages&&(i+="; messages="+us(qt.fromValuesArray(e.messages))),e.presence&&t&&(i+="; presence="+us(t.WirePresenceMessage.fromValuesArray(e.presence))),e.annotations&&s&&(i+="; annotations="+us(s.WireAnnotation.fromValuesArray(e.annotations))),e.state&&n&&(i+="; state="+us(n.ObjectMessage.fromValuesArray(e.state,S,rt))),e.error&&(i+="; error="+C.fromValues(e.error).toString()),e.auth&&e.auth.accessToken&&(i+="; token="+e.auth.accessToken),e.flags&&(i+="; flags="+Ye.filter(e.hasFlag).join(",")),e.params){let t="";F(e.params,function(s){t.length>0&&(t+="; "),t+=s+"="+e.params[s]}),t.length>0&&(i+="; params=["+t+"]")}return i+="]",i}var gs=class{constructor(){this.hasFlag=e=>(this.flags&Ke[e])>0}setFlag(e){return this.flags=this.flags|Ke[e]}getMode(){return(this.flags||0)&Ke.MODE_ALL}encodeModesToFlags(e){e.forEach(e=>this.setFlag(e))}decodeModesFromFlags(){const e=[];return Qe.forEach(t=>{this.hasFlag(t)&&e.push(t)}),e.length>0?e:void 0}},vs=gs,ms=class{constructor(e,t,s,n,i){this.previous=e,this.current=t,"attached"===t&&(this.resumed=s,this.hasBacklog=n),i&&(this.reason=i)}},ys=function(){};function bs(e){const t=e||{},{agent:s}=t;return((e,t)=>{var s={};for(var n in e)u.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&l)for(var n of l(e))t.indexOf(n)<0&&d.call(e,n)&&(s[n]=e[n]);return s})(t,["agent"])}var ws=class e extends We{constructor(e,t,s){var n,i,a;super(e.logger),this._annotations=null,this._mode=0,this.retryCount=0,this.history=async function(e){k.logAction(this.logger,k.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);const t=this.client.rest.channelMixin;if(e&&e.untilAttach){if("attached"!==this.state)throw new C("option untilAttach requires the channel to be attached",4e4,400);if(!this.properties.attachSerial)throw new C("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400);delete e.untilAttach,e.from_serial=this.properties.attachSerial}return t.history(this,e)},this.whenState=e=>We.prototype.whenState.call(this,e,this.state),k.logAction(this.logger,k.LOG_MINOR,"RealtimeChannel()","started; name = "+t),this.name=t,this.channelOptions=Oe(null!=(n=e._Crypto)?n:null,this.logger,s),this.client=e,this._presence=e._RealtimePresence?new e._RealtimePresence.RealtimePresence(this):null,e._Annotations&&(this._annotations=new e._Annotations.RealtimeAnnotations(this)),this.connectionManager=e.connection.connectionManager,this.state="initialized",this.subscriptions=new We(this.logger),this.syncChannelSerial=void 0,this.properties={attachSerial:void 0,channelSerial:void 0},this.setOptions(s),this.errorReason=null,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:e.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new We(this.logger),(null==(i=e.options.plugins)?void 0:i.Push)&&(this._push=new e.options.plugins.Push.PushChannel(this)),(null==(a=e.options.plugins)?void 0:a.Objects)&&(this._objects=new e.options.plugins.Objects.Objects(this))}get presence(){return this._presence||me("RealtimePresence"),this._presence}get annotations(){return this._annotations||me("Annotations"),this._annotations}get push(){return this._push||me("Push"),this._push}get objects(){return this._objects||me("Objects"),this._objects}invalidStateError(){return new C("Channel operation failed as channel state is "+this.state,90001,400,this.errorReason||void 0)}static processListenerArgs(e){return"function"==typeof(e=Array.prototype.slice.call(e))[0]&&e.unshift(null),e}async setOptions(e){var t;const s=this.channelOptions,n=function(e){if(e&&"params"in e&&!I(e.params))return new C("options.params must be an object",4e4,400);if(e&&"modes"in e){if(!Array.isArray(e.modes))return new C("options.modes must be an array",4e4,400);for(let t=0;t<e.modes.length;t++){const s=e.modes[t];if(!s||"string"!=typeof s||!Qe.includes(String.prototype.toUpperCase.call(s)))return new C("Invalid channel mode: "+s,4e4,400)}}}(e);if(n)throw n;if(this.channelOptions=Oe(null!=(t=this.client._Crypto)?t:null,this.logger,e),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(e,s))return this.attachImpl(),new Promise((e,t)=>{this._allChannelChanges.once(["attached","update","detached","failed"],function(s){switch(this.event){case"update":case"attached":e();break;default:t(s.reason)}})})}_shouldReattachToSetOptions(e,t){if("attached"!==this.state&&"attaching"!==this.state)return!1;if(null==e?void 0:e.params){const s=bs(e.params),n=bs(t.params);if(Object.keys(s).length!==Object.keys(n).length)return!0;if(!he(n,s))return!0}return!(!(null==e?void 0:e.modes)||t.modes&&ge(e.modes,t.modes))}async publish(...e){let t;if(1==e.length)if(I(e[0]))t=[Gt.fromValues(e[0])];else{if(!Array.isArray(e[0]))throw new C("The single-argument form of publish() expects a message object or an array of message objects",40013,400);t=Gt.fromValuesArray(e[0])}else t=[Gt.fromValues({name:e[0],data:e[1]})];const s=this.client.options.maxMessageSize,n=await Ut(t,this.channelOptions),i=Bt(n);if(i>s)throw new C(`Maximum size of messages that can be published at once exceeded (was ${i} bytes; limit is ${s} bytes)`,40009,400);this.throwIfUnpublishableState(),k.logAction(this.logger,k.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+this.state+", message count = "+n.length);const a=ps({action:ze.MESSAGE,channel:this.name,messages:n});return this.sendMessage(a)}throwIfUnpublishableState(){if(!this.connectionManager.activeState())throw this.connectionManager.getError();if("failed"===this.state||"suspended"===this.state)throw this.invalidStateError()}onEvent(e){k.logAction(this.logger,k.LOG_MICRO,"RealtimeChannel.onEvent()","received message");const t=this.subscriptions;for(let s=0;s<e.length;s++){const n=e[s];t.emit(n.name,n)}}async attach(){return"attached"===this.state?null:new Promise((e,t)=>{this._attach(!1,null,(s,n)=>s?t(s):e(n))})}_attach(e,t,s){s||(s=e=>{e&&k.logAction(this.logger,k.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+e.toString())});const n=this.connectionManager;n.activeState()?(("attaching"!==this.state||e)&&this.requestState("attaching",t),this.once(function(e){switch(this.event){case"attached":null==s||s(null,e);break;case"detached":case"suspended":case"failed":null==s||s(e.reason||n.getError()||new C("Unable to attach; reason unknown; state = "+this.event,9e4,500));break;case"detaching":null==s||s(new C("Attach request superseded by a subsequent detach request",9e4,409))}})):s(n.getError())}attachImpl(){k.logAction(this.logger,k.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");const e=ps({action:ze.ATTACH,channel:this.name,params:this.channelOptions.params,channelSerial:this.properties.channelSerial});this.channelOptions.modes&&e.encodeModesToFlags(oe(this.channelOptions.modes)),this._attachResume&&e.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(e.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(e).catch(ys)}async detach(){const e=this.connectionManager;if(!e.activeState())throw e.getError();switch(this.state){case"suspended":return void this.notifyState("detached");case"detached":return;case"failed":throw new C("Unable to detach; channel state = failed",90001,400);default:this.requestState("detaching");case"detaching":return new Promise((t,s)=>{this.once(function(n){switch(this.event){case"detached":t();break;case"attached":case"suspended":case"failed":s(n.reason||e.getError()||new C("Unable to detach; reason unknown; state = "+this.event,9e4,500));break;case"attaching":s(new C("Detach request superseded by a subsequent attach request",9e4,409))}})})}}detachImpl(){k.logAction(this.logger,k.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");const e=ps({action:ze.DETACH,channel:this.name});this.sendMessage(e).catch(ys)}async subscribe(...t){const[s,n]=e.processListenerArgs(t);if("failed"===this.state)throw C.fromValues(this.invalidStateError());return s&&"object"==typeof s&&!Array.isArray(s)?this.client._FilteredSubscriptions.subscribeFilter(this,s,n):this.subscriptions.on(s,n),!1!==this.channelOptions.attachOnSubscribe?this.attach():null}unsubscribe(...t){var s;const[n,i]=e.processListenerArgs(t);"object"==typeof n&&!i||(null==(s=this.filteredSubscriptions)?void 0:s.has(i))?this.client._FilteredSubscriptions.getAndDeleteFilteredSubscriptions(this,n,i).forEach(e=>this.subscriptions.off(e)):this.subscriptions.off(n,i)}sync(){switch(this.state){case"initialized":case"detaching":case"detached":throw new O("Unable to sync to channel; not attached",4e4)}const e=this.connectionManager;if(!e.activeState())throw e.getError();const t=ps({action:ze.SYNC,channel:this.name});this.syncChannelSerial&&(t.channelSerial=this.syncChannelSerial),e.send(t)}async sendMessage(e){return new Promise((t,s)=>{this.connectionManager.send(e,this.client.options.queueMessages,e=>{e?s(e):t()})})}async sendPresence(e){const t=ps({action:ze.PRESENCE,channel:this.name,presence:e});return this.sendMessage(t)}sendState(e){const t=ps({action:ze.OBJECT,channel:this.name,state:e});return this.sendMessage(t)}async processMessage(e){e.action!==ze.ATTACHED&&e.action!==ze.MESSAGE&&e.action!==ze.PRESENCE&&e.action!==ze.OBJECT&&e.action!==ze.ANNOTATION||this.setChannelSerial(e.channelSerial);let t,s=!1;switch(e.action){case ze.ATTACHED:{this.properties.attachSerial=e.channelSerial,this._mode=e.getMode(),this.params=e.params||{};const t=e.decodeModesFromFlags();this.modes=t&&re(t)||void 0;const s=e.hasFlag("RESUMED"),n=e.hasFlag("HAS_PRESENCE"),i=e.hasFlag("HAS_BACKLOG"),a=e.hasFlag("HAS_OBJECTS");if("attached"===this.state){s||(this._presence&&this._presence.onAttached(n),this._objects&&this._objects.onAttached(a));const t=new ms(this.state,this.state,s,i,e.error);this._allChannelChanges.emit("update",t),s&&!this.channelOptions.updateOnAttached||this.emit("update",t)}else"detaching"===this.state?this.checkPendingState():this.notifyState("attached",e.error,s,n,i,a);break}case ze.DETACHED:{const t=e.error?C.fromValues(e.error):new C("Channel detached",90001,404);"detaching"===this.state?this.notifyState("detached",t):"attaching"===this.state?this.notifyState("suspended",t):"attached"!==this.state&&"suspended"!==this.state||this.requestState("attaching",t);break}case ze.SYNC:if(s=!0,t=this.syncChannelSerial=e.channelSerial,!e.presence)break;case ze.PRESENCE:{if(!e.presence)break;ot(e);const n=this.channelOptions;if(this._presence){const i=await Promise.all(e.presence.map(e=>e.decode(n,this.logger)));this._presence.setPresence(i,s,t)}break}case ze.OBJECT:case ze.OBJECT_SYNC:{if(!this._objects||!e.state)return;ot(e);const t=e.state,s=this.client.connection.connectionManager.getActiveTransportFormat();await Promise.all(t.map(e=>this.client._objectsPlugin.ObjectMessage.decode(e,this.client,this.logger,k,S,s))),e.action===ze.OBJECT?this._objects.handleObjectMessages(t):this._objects.handleObjectSyncMessages(t,e.channelSerial);break}case ze.MESSAGE:{if("attached"!==this.state)return void k.logAction(this.logger,k.LOG_MAJOR,"RealtimeChannel.processMessage()",'Message "'+e.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');ot(e);const t=e.messages,s=t[0],n=t[t.length-1];if(s.extras&&s.extras.delta&&s.extras.delta.from!==this._lastPayload.messageId){const t='Delta message decode failure - previous message not available for message "'+e.id+'" on this channel "'+this.name+'".';k.logAction(this.logger,k.LOG_ERROR,"RealtimeChannel.processMessage()",t),this._startDecodeFailureRecovery(new C(t,40018,400));break}let i=[];for(let e=0;e<t.length;e++){const{decoded:s,err:n}=await t[e].decodeWithErr(this._decodingContext,this.logger);if(i[e]=s,n)switch(n.code){case 40018:return void this._startDecodeFailureRecovery(n);case 40019:case 40021:return void this.notifyState("failed",n)}}this._lastPayload.messageId=n.id,this._lastPayload.protocolMessageChannelSerial=e.channelSerial,this.onEvent(i);break}case ze.ANNOTATION:{ot(e);const t=this.channelOptions;if(this._annotations){const s=await Promise.all((e.annotations||[]).map(e=>e.decode(t,this.logger)));this._annotations._processIncoming(s)}break}case ze.ERROR:{const t=e.error;t&&80016==t.code?this.checkPendingState():this.notifyState("failed",C.fromValues(t));break}default:k.logAction(this.logger,k.LOG_MAJOR,"RealtimeChannel.processMessage()","Protocol error: unrecognised message action ("+e.action+")")}}_startDecodeFailureRecovery(e){this._lastPayload.decodeFailureRecoveryInProgress||(k.logAction(this.logger,k.LOG_MAJOR,"RealtimeChannel.processMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,e,()=>{this._lastPayload.decodeFailureRecoveryInProgress=!1}))}onAttached(){k.logAction(this.logger,k.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)}notifyState(e,t,s,n,i,a){if(k.logAction(this.logger,k.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+e),this.clearStateTimer(),["detached","suspended","failed"].includes(e)&&(this.properties.channelSerial=null),e===this.state)return;this._presence&&this._presence.actOnChannelState(e,n,t),this._objects&&this._objects.actOnChannelState(e,a),"suspended"===e&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),t&&(this.errorReason=t);const r=new ms(this.state,e,s,i,t),o='Channel state for channel "'+this.name+'"',c=e+(t?"; reason: "+t:"");"failed"===e?k.logAction(this.logger,k.LOG_ERROR,o,c):k.logAction(this.logger,k.LOG_MAJOR,o,c),"attaching"!==e&&"suspended"!==e&&(this.retryCount=0),"attached"===e&&this.onAttached(),"attached"===e?this._attachResume=!0:"detaching"!==e&&"failed"!==e||(this._attachResume=!1),this.state=e,this._allChannelChanges.emit(e,r),this.emit(e,r)}requestState(e,t){k.logAction(this.logger,k.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+e),this.notifyState(e,t),this.checkPendingState()}checkPendingState(){if(this.connectionManager.state.sendEvents)switch(k.logAction(this.logger,k.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync()}else k.logAction(this.logger,k.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state)}timeoutPendingState(){switch(this.state){case"attaching":{const e=new C("Channel attach timed out",90007,408);this.notifyState("suspended",e);break}case"detaching":{const e=new C("Channel detach timed out",90007,408);this.notifyState("attached",e);break}default:this.checkPendingState()}}startStateTimerIfNotRunning(){this.stateTimer||(this.stateTimer=setTimeout(()=>{k.logAction(this.logger,k.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),this.stateTimer=null,this.timeoutPendingState()},this.client.options.timeouts.realtimeRequestTimeout))}clearStateTimer(){const e=this.stateTimer;e&&(clearTimeout(e),this.stateTimer=null)}startRetryTimer(){if(this.retryTimer)return;this.retryCount++;const e=ue(this.client.options.timeouts.channelRetryTimeout,this.retryCount);this.retryTimer=setTimeout(()=>{"suspended"===this.state&&this.connectionManager.state.sendEvents&&(this.retryTimer=null,k.logAction(this.logger,k.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),this.requestState("attaching"))},e)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}getReleaseErr(){const e=this.state;return"initialized"===e||"detached"===e||"failed"===e?null:new C("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+e,90001,400)}setChannelSerial(e){k.logAction(this.logger,k.LOG_MICRO,"RealtimeChannel.setChannelSerial()","Updating channel serial; serial = "+e+"; previous = "+this.properties.channelSerial),e&&(this.properties.channelSerial=e)}async status(){return this.client.rest.channelMixin.status(this)}},_s=class{constructor(e){this.channel=e,this.logger=e.logger,this.subscriptions=new We(this.logger)}async publish(e,t){const s=this.channel.name,n=rs(e,t),i=await n.encode();this.channel.throwIfUnpublishableState(),k.logAction(this.logger,k.LOG_MICRO,"RealtimeAnnotations.publish()","channelName = "+s+", sending annotation with messageSerial = "+n.messageSerial+", type = "+n.type);const a=ps({action:ze.ANNOTATION,channel:s,annotations:[i]});return this.channel.sendMessage(a)}async delete(e,t){return t.action="annotation.delete",this.publish(e,t)}async subscribe(...e){const t=ws.processListenerArgs(e),s=t[0],n=t[1],i=this.channel;if("failed"===i.state)throw C.fromValues(i.invalidStateError());if(this.subscriptions.on(s,n),!1!==this.channel.channelOptions.attachOnSubscribe&&await i.attach(),0===("attached"===this.channel.state&&this.channel._mode&Ke.ANNOTATION_SUBSCRIBE))throw new C("You are trying to add an annotation listener, but you haven't requested the annotation_subscribe channel mode in ChannelOptions, so this won't do anything (we only deliver annotations to clients who have explicitly requested them)",93001,400)}unsubscribe(...e){const t=ws.processListenerArgs(e),s=t[0],n=t[1];this.subscriptions.off(s,n)}_processIncoming(e){for(const t of e)this.subscriptions.emit(t.type||"",t)}async get(e,t){return cs.prototype.get.call(this,e,t)}},ks=class e extends Jt{constructor(t){var s,n;if(!e._MsgPack)throw new Error("Expected DefaultRest._MsgPack to have been set");super(Te.objectifyOptions(t,!0,"Rest",k.defaultLogger,f(p({},Kt),{Crypto:null!=(s=e.Crypto)?s:void 0,MsgPack:null!=(n=e._MsgPack)?n:void 0,Annotations:{Annotation:ns,WireAnnotation:ss,RealtimeAnnotations:_s,RestAnnotations:cs}})))}static get Crypto(){if(null===this._Crypto)throw new Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(e){this._Crypto=e}};ks._Crypto=null,ks.Message=Yt,ks.PresenceMessage=Qt,ks.Annotation=is,ks._MsgPack=null,ks._Http=Fe;var Ss,Rs,Cs=ks,Os=class extends We{constructor(e){super(e),this.messages=[]}count(){return this.messages.length}push(e){this.messages.push(e)}shift(){return this.messages.shift()}last(){return this.messages[this.messages.length-1]}copyAll(){return this.messages.slice()}append(e){this.messages.push.apply(this.messages,e)}prepend(e){this.messages.unshift.apply(this.messages,e)}completeMessages(e,t,s){k.logAction(this.logger,k.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+e+"; count = "+t),s=s||null;const n=this.messages;if(0===n.length)throw new Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");const i=n[0];if(i){const a=i.message.msgSerial,r=e+t;if(r>a){const e=n.splice(0,r-a);for(const t of e)t.callback(s)}0==n.length&&this.emit("idle")}}completeAllMessages(e){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,e)}resetSendAttempted(){for(let e of this.messages)e.sendAttempted=!1}clear(){k.logAction(this.logger,k.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")}},Es=class{constructor(e,t){this.message=e,this.callback=t,this.merged=!1;const s=e.action;this.sendAttempted=!1,this.ackRequired="number"==typeof s&&[ze.MESSAGE,ze.PRESENCE,ze.ANNOTATION,ze.OBJECT].includes(s)}},As=class extends We{constructor(e){super(e.logger),this.transport=e,this.messageQueue=new Os(this.logger),e.on("ack",(e,t)=>{this.onAck(e,t)}),e.on("nack",(e,t,s)=>{this.onNack(e,t,s)})}onAck(e,t){k.logAction(this.logger,k.LOG_MICRO,"Protocol.onAck()","serial = "+e+"; count = "+t),this.messageQueue.completeMessages(e,t)}onNack(e,t,s){k.logAction(this.logger,k.LOG_ERROR,"Protocol.onNack()","serial = "+e+"; count = "+t+"; err = "+Q(s)),s||(s=new C("Unable to send message; channel not responding",50001,500)),this.messageQueue.completeMessages(e,t,s)}onceIdle(e){const t=this.messageQueue;0!==t.count()?t.once("idle",e):e()}send(e){e.ackRequired&&this.messageQueue.push(e),this.logger.shouldLog(k.LOG_MICRO)&&k.logActionNoStrip(this.logger,k.LOG_MICRO,"Protocol.send()","sending msg; "+fs(e.message,this.transport.connectionManager.realtime._RealtimePresence,this.transport.connectionManager.realtime._Annotations,this.transport.connectionManager.realtime._objectsPlugin)),e.sendAttempted=!0,this.transport.send(e.message)}getTransport(){return this.transport}getPendingMessages(){return this.messageQueue.copyAll()}clearPendingMessages(){return this.messageQueue.clear()}finish(){const e=this.transport;this.onceIdle(function(){e.disconnect()})}},Ts=class{constructor(e,t,s,n){this.previous=e,this.current=t,s&&(this.retryIn=s),n&&(this.reason=n)}},Is={DISCONNECTED:80003,SUSPENDED:80002,FAILED:8e4,CLOSING:80017,CLOSED:80017,UNKNOWN_CONNECTION_ERR:50002,UNKNOWN_CHANNEL_ERR:50001},Ms={disconnected:()=>C.fromValues({statusCode:400,code:Is.DISCONNECTED,message:"Connection to server temporarily unavailable"}),suspended:()=>C.fromValues({statusCode:400,code:Is.SUSPENDED,message:"Connection to server unavailable"}),failed:()=>C.fromValues({statusCode:400,code:Is.FAILED,message:"Connection failed or disconnected by server"}),closing:()=>C.fromValues({statusCode:400,code:Is.CLOSING,message:"Connection closing"}),closed:()=>C.fromValues({statusCode:400,code:Is.CLOSED,message:"Connection closed"}),unknownConnectionErr:()=>C.fromValues({statusCode:500,code:Is.UNKNOWN_CONNECTION_ERR,message:"Internal connection error"}),unknownChannelErr:()=>C.fromValues({statusCode:500,code:Is.UNKNOWN_CONNECTION_ERR,message:"Internal channel error"})},Ps=ps({action:ze.CLOSE}),Ls=ps({action:ze.DISCONNECT}),Ns=class extends We{constructor(e,t,s,n){super(e.logger),n&&(s.format=void 0,s.heartbeats=!0),this.connectionManager=e,this.auth=t,this.params=s,this.timeouts=s.options.timeouts,this.format=s.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}connect(){}close(){this.isConnected&&this.requestClose(),this.finish("closed",Ms.closed())}disconnect(e){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",e||Ms.disconnected())}fail(e){this.isConnected&&this.requestDisconnect(),this.finish("failed",e||Ms.failed())}finish(e,t){var s;this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout(null!=(s=this.idleTimer)?s:void 0),this.idleTimer=null,this.emit(e,t),this.dispose())}onProtocolMessage(e){switch(this.logger.shouldLog(k.LOG_MICRO)&&k.logActionNoStrip(this.logger,k.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+fs(e,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),e.action){case ze.HEARTBEAT:k.logActionNoStrip(this.logger,k.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",e.id);break;case ze.CONNECTED:this.onConnect(e),this.emit("connected",e.error,e.connectionId,e.connectionDetails,e);break;case ze.CLOSED:this.onClose(e);break;case ze.DISCONNECTED:this.onDisconnect(e);break;case ze.ACK:this.emit("ack",e.msgSerial,e.count);break;case ze.NACK:this.emit("nack",e.msgSerial,e.count,e.error);break;case ze.SYNC:this.connectionManager.onChannelMessage(e,this);break;case ze.ACTIVATE:break;case ze.AUTH:ne(this.auth.authorize(),e=>{e&&k.logAction(this.logger,k.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+Q(e))});break;case ze.ERROR:if(k.logAction(this.logger,k.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+m.Config.inspect(e.error)+(e.channel?", channel: "+e.channel:"")),void 0===e.channel){this.onFatalError(e);break}this.connectionManager.onChannelMessage(e,this);break;default:this.connectionManager.onChannelMessage(e,this)}}onConnect(e){if(this.isConnected=!0,!e.connectionDetails)throw new Error("Transport.onConnect(): Connect message recieved without connectionDetails");const t=e.connectionDetails.maxIdleInterval;t&&(this.maxIdleInterval=t+this.timeouts.realtimeRequestTimeout,this.onActivity())}onDisconnect(e){const t=e&&e.error;k.logAction(this.logger,k.LOG_MINOR,"Transport.onDisconnect()","err = "+Q(t)),this.finish("disconnected",t)}onFatalError(e){const t=e&&e.error;k.logAction(this.logger,k.LOG_MINOR,"Transport.onFatalError()","err = "+Q(t)),this.finish("failed",t)}onClose(e){const t=e&&e.error;k.logAction(this.logger,k.LOG_MINOR,"Transport.onClose()","err = "+Q(t)),this.finish("closed",t)}requestClose(){k.logAction(this.logger,k.LOG_MINOR,"Transport.requestClose()",""),this.send(Ps)}requestDisconnect(){k.logAction(this.logger,k.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(Ls)}ping(e){const t={action:ze.HEARTBEAT};e&&(t.id=e),this.send(ps(t))}dispose(){k.logAction(this.logger,k.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()}onActivity(){this.maxIdleInterval&&(this.lastActivity=this.connectionManager.lastActivity=Date.now(),this.setIdleTimer(this.maxIdleInterval+100))}setIdleTimer(e){this.idleTimer||(this.idleTimer=setTimeout(()=>{this.onIdleTimerExpire()},e))}onIdleTimerExpire(){if(!this.lastActivity||!this.maxIdleInterval)throw new Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;const e=Date.now()-this.lastActivity,t=this.maxIdleInterval-e;if(t<=0){const t="No activity seen from realtime in "+e+"ms; assuming connection has dropped";k.logAction(this.logger,k.LOG_ERROR,"Transport.onIdleTimerExpire()",t),this.disconnect(new C(t,80003,408))}else this.setIdleTimer(t+100)}static tryConnect(e,t,s,n,i){const a=new e(t,s,n);let r;const o=function(e){clearTimeout(r),i({event:this.event,error:e})},c=t.options.timeouts.realtimeRequestTimeout;return r=setTimeout(()=>{a.off(["preconnect","disconnected","failed"]),a.dispose(),o.call({event:"disconnected"},new C("Timeout waiting for transport to indicate itself viable",5e4,500))},c),a.on(["failed","disconnected"],o),a.on("preconnect",function(){k.logAction(t.logger,k.LOG_MINOR,"Transport.tryConnect()","viable transport "+a),clearTimeout(r),a.off(["failed","disconnected"],o),i(null,a)}),a.connect(),a}static isAvailable(){throw new C("isAvailable not implemented for transport",5e4,500)}};(Rs=Ss||(Ss={})).WebSocket="web_socket",Rs.Comet="comet",Rs.XhrPolling="xhr_polling";var Ds=void 0!==s?s:"undefined"!=typeof window?window:self,Us=()=>{var e;return void 0!==m.WebStorage&&(null==(e=m.WebStorage)?void 0:e.localSupported)},xs=()=>{var e;return void 0!==m.WebStorage&&(null==(e=m.WebStorage)?void 0:e.sessionSupported)},Bs=function(){},Hs="ably-transport-preference";function qs(e){try{return JSON.parse(e)}catch(t){return null}}var Gs=class{constructor(e,t,s,n){this.options=e,this.host=t,this.mode=s,this.connectionKey=n,this.format=e.useBinaryProtocol?"msgpack":"json"}getConnectParams(e){const t=e?A(e):{},s=this.options;switch(this.mode){case"resume":t.resume=this.connectionKey;break;case"recover":{const e=qs(s.recover);e&&(t.recover=e.connectionKey);break}}return void 0!==s.clientId&&(t.clientId=s.clientId),!1===s.echoMessages&&(t.echo="false"),void 0!==this.format&&(t.format=this.format),void 0!==this.stream&&(t.stream=this.stream),void 0!==this.heartbeats&&(t.heartbeats=this.heartbeats),t.v=Te.protocolVersion,t.agent=Ce(this.options),void 0!==s.transportParams&&E(t,s.transportParams),t}toString(){let e="[mode="+this.mode;return this.host&&(e+=",host="+this.host),this.connectionKey&&(e+=",connectionKey="+this.connectionKey),this.format&&(e+=",format="+this.format),e+="]",e}},Vs=class e extends We{constructor(e,t){super(e.logger),this.supportedTransports={},this.disconnectedRetryCount=0,this.pendingChannelMessagesState={isProcessing:!1,queue:[]},this.realtime=e,this.initTransports(),this.options=t;const s=t.timeouts,n=s.webSocketConnectTimeout+s.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:n,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:s.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:s.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:s.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new Os(this.logger),this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionStateTtl=s.connectionStateTtl,this.maxIdleInterval=null,this.transports=x(t.transports||Te.defaultTransports,this.supportedTransports),this.transportPreference=null,this.transports.includes(Ss.WebSocket)&&(this.webSocketTransportAvailable=!0),this.transports.includes(Ss.XhrPolling)?this.baseTransport=Ss.XhrPolling:this.transports.includes(Ss.Comet)&&(this.baseTransport=Ss.Comet),this.httpHosts=Te.getHosts(t),this.wsHosts=Te.getHosts(t,!0),this.activeProtocol=null,this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.forceFallbackHost=!1,this.connectCounter=0,this.wsCheckResult=null,this.webSocketSlowTimer=null,this.webSocketGiveUpTimer=null,this.abandonedWebSocket=!1,k.logAction(this.logger,k.LOG_MINOR,"Realtime.ConnectionManager()","started"),k.logAction(this.logger,k.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(t.transports||Te.defaultTransports)+"]"),k.logAction(this.logger,k.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),k.logAction(this.logger,k.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]"),!this.transports.length){const e="no requested transports available";throw k.logAction(this.logger,k.LOG_ERROR,"realtime.ConnectionManager()",e),new Error(e)}const i=m.Config.addEventListener;i&&(xs()&&"function"==typeof t.recover&&i("beforeunload",this.persistConnection.bind(this)),!0===t.closeOnUnload&&i("beforeunload",()=>{k.logAction(this.logger,k.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),this.requestState({state:"closing"})}),i("online",()=>{var e;this.state==this.states.disconnected||this.state==this.states.suspended?(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager caught browser âonlineâ event","reattempting connection"),this.requestState({state:"connecting"})):this.state==this.states.connecting&&(null==(e=this.pendingTransport)||e.off(),this.disconnectAllTransports(),this.startConnect())}),i("offline",()=>{this.state==this.states.connected&&(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager caught browser âofflineâ event","disconnecting active transport"),this.disconnectAllTransports())}))}static supportedTransports(e){const t={supportedTransports:{}};return this.initTransports(e,t),t.supportedTransports}static initTransports(e,t){const s=p(p({},m.Transports.bundledImplementations),e);[Ss.WebSocket,...m.Transports.order].forEach(e=>{const n=s[e];n&&n.isAvailable()&&(t.supportedTransports[e]=n)})}initTransports(){e.initTransports(this.realtime._additionalTransportImplementations,this)}createTransportParams(e,t){return new Gs(this.options,e,t,this.connectionKey)}getTransportParams(e){(e=>{if(this.connectionKey)return void e("resume");if("string"==typeof this.options.recover)return void e("recover");const t=this.options.recover,s=this.getSessionRecoverData(),n=this.sessionRecoveryName();if(s&&"function"==typeof t)return k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data (recovery scope: "+n+")"),void t(s,t=>{t?(this.options.recover=s.recoveryKey,e("recover")):e("clean")});e("clean")})(t=>{const s=this.createTransportParams(null,t);if("recover"===t){k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+this.options.recover);const e=qs(this.options.recover);e&&(this.msgSerial=e.msgSerial)}else k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+s.toString());e(s)})}tryATransport(e,t,s){k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+t),this.proposedTransport=Ns.tryConnect(this.supportedTransports[t],this,this.realtime.auth,e,(n,i)=>{const a=this.state;return a==this.states.closing||a==this.states.closed||a==this.states.failed?(i&&(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+a.state+" while we were attempting the transport; closing "+i),i.close()),void s(!0)):n?(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+t+" "+n.event+", err: "+n.error.toString()),void(!Ge.isTokenErr(n.error)||this.errorReason&&Ge.isTokenErr(this.errorReason)?"failed"===n.event?(this.notifyState({state:"failed",error:n.error}),s(!0)):"disconnected"===n.event&&(!(r=n.error).statusCode||!r.code||r.statusCode>=500||Object.values(Is).includes(r.code)?s(!1):(this.notifyState({state:this.states.connecting.failState,error:n.error}),s(!0))):(this.errorReason=n.error,ne(this.realtime.auth._forceNewToken(null,null),n=>{n?this.actOnErrorFromAuthorize(n):this.tryATransport(e,t,s)})))):(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+t+"; setting pending"),this.setTransportPending(i,e),void s(null,i));var r})}setTransportPending(e,t){const s=t.mode;k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+e+"; mode = "+s),this.pendingTransport=e,this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),e.once("connected",(t,n,i)=>{this.activateTransport(t,e,n,i),"recover"===s&&this.options.recover&&(delete this.options.recover,this.unpersistConnection())});const n=this;e.on(["disconnected","closed","failed"],function(t){n.deactivateTransport(e,this.event,t)}),this.emit("transport.pending",e)}activateTransport(e,t,s,n){k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+t),e&&k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+e),s&&k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+s),n&&k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(n)),this.persistTransportPreference(t);const i=this.state,a=this.states.connected.state;if(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+i.state),i.state==this.states.closing.state||i.state==this.states.closed.state||i.state==this.states.failed.state)return k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),t.disconnect(),!1;if(delete this.pendingTransport,!t.isConnected)return k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+t+" since it appears to no longer be connected"),!1;const r=this.activeProtocol;this.activeProtocol=new As(t),this.host=t.params.host;const o=n.connectionKey;if(o&&this.connectionKey!=o&&this.setConnection(s,n,!!e),this.onConnectionDetailsUpdate(n,t),m.Config.nextTick(()=>{t.on("connected",(e,s,n)=>{this.onConnectionDetailsUpdate(n,t),this.emit("update",new Ts(a,a,null,e))})}),i.state===this.states.connected.state?e&&(this.errorReason=this.realtime.connection.errorReason=e,this.emit("update",new Ts(a,a,null,e))):(this.notifyState({state:"connected",error:e}),this.errorReason=this.realtime.connection.errorReason=e||null),this.emit("transport.active",t),r)if(r.messageQueue.count()>0&&k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+r.transport.shortName+", new one is "+t.shortName+") finishing with "+r.messageQueue.count()+" messages still pending"),r.transport===t){const e="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+t.shortName+"; stack = "+(new Error).stack;k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.activateTransport()",e)}else r.finish();return!0}deactivateTransport(e,t,s){const n=this.activeProtocol,i=n&&n.getTransport()===e,a=e===this.pendingTransport,r=this.noTransportsScheduledForActivation();if(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+e),k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+t+(i?"; was active":a?"; was pending":"")+(r?"":"; another transport is scheduled for activation")),s&&s.message&&k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+s.message),i&&(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(n.getPendingMessages()),n.clearPendingMessages(),this.activeProtocol=this.host=null),this.emit("transport.inactive",e),i&&r||i&&"failed"===t||"closed"===t||null===n&&a){if("disconnected"===t&&s&&s.statusCode>500&&this.httpHosts.length>1)return this.unpersistTransportPreference(),this.forceFallbackHost=!0,void this.notifyState({state:t,error:s,retryImmediately:!0});const e="failed"===t&&Ge.isTokenErr(s)?"disconnected":t;return void this.notifyState({state:e,error:s})}}noTransportsScheduledForActivation(){return!this.pendingTransport||!this.pendingTransport.isConnected}setConnection(e,t,s){const n=this.connectionId;(n&&n!==e||!n&&s)&&(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0,this.queuedMessages.resetSendAttempted()),this.connectionId!==e&&k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),this.realtime.connection.id=this.connectionId=e,this.realtime.connection.key=this.connectionKey=t.connectionKey}clearConnection(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.msgSerial=0,this.unpersistConnection()}createRecoveryKey(){return this.connectionKey?JSON.stringify({connectionKey:this.connectionKey,msgSerial:this.msgSerial,channelSerials:this.realtime.channels.channelSerials()}):null}checkConnectionStateFreshness(){if(!this.lastActivity||!this.connectionId)return;const e=Date.now()-this.lastActivity;e>this.connectionStateTtl+this.maxIdleInterval&&(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+e+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended")}persistConnection(){if(xs()){const e=this.createRecoveryKey();e&&this.setSessionRecoverData({recoveryKey:e,disconnectedAt:Date.now(),location:Ds.location,clientId:this.realtime.auth.clientId})}}unpersistConnection(){this.clearSessionRecoverData()}getActiveTransportFormat(){var e;return null==(e=this.activeProtocol)?void 0:e.getTransport().format}getError(){if(this.errorReason){const e=O.fromValues(this.errorReason);return e.cause=this.errorReason,e}return this.getStateError()}getStateError(){var e,t;return null==(t=(e=Ms)[this.state.state])?void 0:t.call(e)}activeState(){return this.state.queueEvents||this.state.sendEvents}enactStateChange(e){const t="Connection state",s=e.current+(e.reason?"; reason: "+e.reason:"");"failed"===e.current?k.logAction(this.logger,k.LOG_ERROR,t,s):k.logAction(this.logger,k.LOG_MAJOR,t,s),k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+e.current+"; reason = "+(e.reason&&e.reason.message));const n=this.state=this.states[e.current];e.reason&&(this.errorReason=e.reason,this.realtime.connection.errorReason=e.reason),(n.terminal||"suspended"===n.state)&&this.clearConnection(),this.emit("connectionstate",e)}startTransitionTimer(e){k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+e.state),this.transitionTimer&&(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer)),this.transitionTimer=setTimeout(()=>{this.transitionTimer&&(this.transitionTimer=null,k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager "+e.state+" timer expired","requesting new state: "+e.failState),this.notifyState({state:e.failState}))},e.retryDelay)}cancelTransitionTimer(){k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)}startSuspendTimer(){this.suspendTimer||(this.suspendTimer=setTimeout(()=>{this.suspendTimer&&(this.suspendTimer=null,k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),this.states.connecting.failState="suspended",this.notifyState({state:"suspended"}))},this.connectionStateTtl))}checkSuspendTimer(e){"disconnected"!==e&&"suspended"!==e&&"connecting"!==e&&this.cancelSuspendTimer()}cancelSuspendTimer(){this.states.connecting.failState="disconnected",this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)}startRetryTimer(e){this.retryTimer=setTimeout(()=>{k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),this.retryTimer=null,this.requestState({state:"connecting"})},e)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}startWebSocketSlowTimer(){this.webSocketSlowTimer=setTimeout(()=>{k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager WebSocket slow timer","checking connectivity"),this.checkWsConnectivity().then(()=>{k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager WebSocket slow timer","ws connectivity check succeeded"),this.wsCheckResult=!0}).catch(()=>{k.logAction(this.logger,k.LOG_MAJOR,"ConnectionManager WebSocket slow timer","ws connectivity check failed"),this.wsCheckResult=!1}),this.realtime.http.checkConnectivity&&ne(this.realtime.http.checkConnectivity(),(e,t)=>{e||!t?(k.logAction(this.logger,k.LOG_MAJOR,"ConnectionManager WebSocket slow timer","http connectivity check failed"),this.cancelWebSocketGiveUpTimer(),this.notifyState({state:"disconnected",error:new C("Unable to connect (network unreachable)",80003,404)})):k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager WebSocket slow timer","http connectivity check succeeded")})},this.options.timeouts.webSocketSlowTimeout)}cancelWebSocketSlowTimer(){this.webSocketSlowTimer&&(clearTimeout(this.webSocketSlowTimer),this.webSocketSlowTimer=null)}startWebSocketGiveUpTimer(e){this.webSocketGiveUpTimer=setTimeout(()=>{var t,s;this.wsCheckResult||(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager WebSocket give up timer","websocket connection took more than 10s; "+(this.baseTransport?"trying base transport":"")),this.baseTransport?(this.abandonedWebSocket=!0,null==(t=this.proposedTransport)||t.dispose(),null==(s=this.pendingTransport)||s.dispose(),this.connectBase(e,++this.connectCounter)):k.logAction(this.logger,k.LOG_MAJOR,"ConnectionManager WebSocket give up timer","websocket connectivity appears to be unavailable but no other transports to try"))},this.options.timeouts.webSocketConnectTimeout)}cancelWebSocketGiveUpTimer(){this.webSocketGiveUpTimer&&(clearTimeout(this.webSocketGiveUpTimer),this.webSocketGiveUpTimer=null)}notifyState(e){var t,s;const n=e.state,i="disconnected"===n&&(this.state===this.states.connected||e.retryImmediately||this.state===this.states.connecting&&e.error&&Ge.isTokenErr(e.error)&&!(this.errorReason&&Ge.isTokenErr(this.errorReason)));if(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+n+(i?"; will retry connection immediately":"")),n==this.state.state)return;if(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.checkSuspendTimer(e.state),"suspended"!==n&&"connected"!==n||(this.disconnectedRetryCount=0),this.state.terminal)return;const a=this.states[e.state];let r=a.retryDelay;"disconnected"===a.state&&(this.disconnectedRetryCount++,r=ue(a.retryDelay,this.disconnectedRetryCount));const o=new Ts(this.state.state,a.state,r,e.error||(null==(s=(t=Ms)[a.state])?void 0:s.call(t)));if(i){const e=()=>{this.state===this.states.disconnected&&(this.lastAutoReconnectAttempt=Date.now(),this.requestState({state:"connecting"}))},t=this.lastAutoReconnectAttempt&&Date.now()-this.lastAutoReconnectAttempt+1;t&&t<1e3?(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+t+"ms ago, waiting another "+(1e3-t)+"ms before trying again"),setTimeout(e,1e3-t)):m.Config.nextTick(e)}else"disconnected"!==n&&"suspended"!==n||this.startRetryTimer(r);("disconnected"===n&&!i||"suspended"===n||a.terminal)&&m.Config.nextTick(()=>{this.disconnectAllTransports()}),"connected"!=n||this.activeProtocol||k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(o),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(n,o.reason),this.failQueuedMessages(o.reason))}requestState(e){var t,s;const n=e.state;if(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+n+"; current state: "+this.state.state),n==this.state.state)return;if(this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(n),"connecting"==n&&"connected"==this.state.state)return;if("closing"==n&&"closed"==this.state.state)return;const i=this.states[n],a=new Ts(this.state.state,i.state,null,e.error||(null==(s=(t=Ms)[i.state])?void 0:s.call(t)));this.enactStateChange(a),"connecting"==n&&m.Config.nextTick(()=>{this.startConnect()}),"closing"==n&&this.closeImpl()}startConnect(){if(this.state!==this.states.connecting)return void k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);const e=this.realtime.auth,t=++this.connectCounter,s=()=>{this.checkConnectionStateFreshness(),this.getTransportParams(e=>{if("recover"===e.mode&&e.options.recover){const t=qs(e.options.recover);t&&this.realtime.channels.recoverChannels(t.channelSerials)}t===this.connectCounter&&this.connectImpl(e,t)})};if(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),"basic"===e.method)s();else{const n=e=>{t===this.connectCounter&&(e?this.actOnErrorFromAuthorize(e):s())};this.errorReason&&Ge.isTokenErr(this.errorReason)?ne(e._forceNewToken(null,null),n):ne(e._ensureValidAuthCredentials(!1),n)}}connectImpl(e,t){const s=this.state.state;if(s!==this.states.connecting.state)return void k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect, but was "+s);const n=this.getTransportPreference();n&&n===this.baseTransport&&this.webSocketTransportAvailable&&this.checkWsConnectivity().then(()=>{this.unpersistTransportPreference(),this.state===this.states.connecting&&(k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.connectImpl():","web socket connectivity available, cancelling connection attempt with "+this.baseTransport),this.disconnectAllTransports(),this.connectWs(e,++this.connectCounter))}).catch(Bs),n&&n===this.baseTransport||this.baseTransport&&!this.webSocketTransportAvailable?this.connectBase(e,t):this.connectWs(e,t)}connectWs(e,t){k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.connectWs()"),this.wsCheckResult=null,this.abandonedWebSocket=!1,this.startWebSocketSlowTimer(),this.startWebSocketGiveUpTimer(e),this.tryTransportWithFallbacks("web_socket",e,!0,t,()=>!1!==this.wsCheckResult&&!this.abandonedWebSocket)}connectBase(e,t){k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.connectBase()"),this.baseTransport?this.tryTransportWithFallbacks(this.baseTransport,e,!1,t,()=>!0):this.notifyState({state:"disconnected",error:new C("No transports left to try",8e4,404)})}tryTransportWithFallbacks(e,t,s,n,i){k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.tryTransportWithFallbacks()",e);const a=e=>{this.notifyState({state:this.states.connecting.failState,error:e})},r=s?this.wsHosts.slice():this.httpHosts.slice(),o=(e,t)=>{n===this.connectCounter&&(i()?t||e||l():t&&t.dispose())},c=r.shift();if(!c)return void a(new C("Unable to connect (no available host)",80003,404));t.host=c;const l=()=>{r.length?this.realtime.http.checkConnectivity?ne(this.realtime.http.checkConnectivity(),(s,c)=>{n===this.connectCounter&&i()&&(s?a(s):c?(t.host=z(r),this.tryATransport(t,e,o)):a(new C("Unable to connect (network unreachable)",80003,404)))}):a(new O("Internal error: Http.checkConnectivity not set",null,500)):a(new C("Unable to connect (and no more fallback hosts to try)",80003,404))};if(this.forceFallbackHost&&r.length)return this.forceFallbackHost=!1,void l();this.tryATransport(t,e,o)}closeImpl(){k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),this.pendingTransport&&(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+this.pendingTransport),this.pendingTransport.close()),this.activeProtocol&&(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})}onAuthUpdated(e,t){var s;switch(this.state.state){case"connected":{k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport");const n=null==(s=this.activeProtocol)?void 0:s.getTransport();n&&n.onAuthUpdated&&n.onAuthUpdated(e);const i=ps({action:ze.AUTH,auth:{accessToken:e.token}});this.send(i);const a=()=>{this.off(r),t(null,e)},r=e=>{"failed"===e.current&&(this.off(a),this.off(r),t(e.reason||this.getStateError()))};this.once("connectiondetails",a),this.on("connectionstate",r);break}case"connecting":k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");const s=n=>{switch(n.current){case"connected":this.off(s),t(null,e);break;case"failed":case"closed":case"suspended":this.off(s),t(n.reason||this.getStateError())}};this.on("connectionstate",s),"connecting"===this.state.state?this.startConnect():this.requestState({state:"connecting"})}}}disconnectAllTransports(){k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"),this.connectCounter++,this.pendingTransport&&(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+this.pendingTransport),this.pendingTransport.disconnect()),delete this.pendingTransport,this.proposedTransport&&(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting proposed transport: "+this.pendingTransport),this.proposedTransport.disconnect()),delete this.pendingTransport,this.activeProtocol&&(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())}send(e,t,s){s=s||Bs;const n=this.state;if(n.sendEvents)return k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.send()","sending event"),void this.sendImpl(new Es(e,s));if(!t||!n.queueEvents){const e="rejecting event, queueEvent was "+t+", state was "+n.state;return k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.send()",e),void s(this.errorReason||new C(e,9e4,400))}this.logger.shouldLog(k.LOG_MICRO)&&k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+fs(e,this.realtime._RealtimePresence,this.realtime._Annotations,this.realtime._objectsPlugin)),this.queue(e,s)}sendImpl(e){const t=e.message;e.ackRequired&&!e.sendAttempted&&(t.msgSerial=this.msgSerial++);try{this.activeProtocol.send(e)}catch(s){k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+s.stack)}}queue(e,t){k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.queue()","queueing event");const s=this.queuedMessages.last(),n=this.options.maxMessageSize;s&&!s.sendAttempted&&function(e,t,s){let n;if(e.channel!==t.channel)return!1;if((n=e.action)!==ze.PRESENCE&&n!==ze.MESSAGE)return!1;if(n!==t.action)return!1;const i=n===ze.PRESENCE?"presence":"messages",a=e[i].concat(t[i]);return!(Bt(a)>s||!$(a,"clientId")||!a.every(function(e){return!e.id})||(e[i]=a,0))}(s.message,e,n)?(s.merged||(s.callback=Ie.create(this.logger,[s.callback]),s.merged=!0),s.callback.push(t)):this.queuedMessages.push(new Es(e,t))}sendQueuedMessages(){let e;for(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");e=this.queuedMessages.shift();)this.sendImpl(e)}queuePendingMessages(e){e&&e.length&&(k.logAction(this.logger,k.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+e.length+" pending messages"),this.queuedMessages.prepend(e))}failQueuedMessages(e){const t=this.queuedMessages.count();t>0&&(k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+t+" queued messages, err = "+Q(e)),this.queuedMessages.completeAllMessages(e))}onChannelMessage(e,t){this.pendingChannelMessagesState.queue.push({message:e,transport:t}),this.pendingChannelMessagesState.isProcessing||this.processNextPendingChannelMessage()}processNextPendingChannelMessage(){if(this.pendingChannelMessagesState.queue.length>0){this.pendingChannelMessagesState.isProcessing=!0;const e=this.pendingChannelMessagesState.queue.shift();this.processChannelMessage(e.message).catch(e=>{k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.processNextPendingChannelMessage() received error ",e)}).finally(()=>{this.pendingChannelMessagesState.isProcessing=!1,this.processNextPendingChannelMessage()})}}async processChannelMessage(e){await this.realtime.channels.processChannelMessage(e)}async ping(){var e;if("connected"!==this.state.state)throw new C("Unable to ping service; not connected",4e4,400);const t=null==(e=this.activeProtocol)?void 0:e.getTransport();if(!t)throw this.getStateError();k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.ping()","transport = "+t);const s=Date.now(),n=ee();return ye(new Promise(e=>{const i=a=>{a===n&&(t.off("heartbeat",i),e(Date.now()-s))};t.on("heartbeat",i),t.ping(n)}),this.options.timeouts.realtimeRequestTimeout,"Timeout waiting for heartbeat response")}abort(e){this.activeProtocol.getTransport().fail(e)}getTransportPreference(){var e,t;return this.transportPreference||Us()&&(null==(t=null==(e=m.WebStorage)?void 0:e.get)?void 0:t.call(e,Hs))}persistTransportPreference(e){var t,s;this.transportPreference=e.shortName,Us()&&(null==(s=null==(t=m.WebStorage)?void 0:t.set)||s.call(t,Hs,e.shortName))}unpersistTransportPreference(){var e,t;this.transportPreference=null,Us()&&(null==(t=null==(e=m.WebStorage)?void 0:e.remove)||t.call(e,Hs))}actOnErrorFromAuthorize(e){if(40171===e.code)this.notifyState({state:"failed",error:e});else if(40102===e.code)this.notifyState({state:"failed",error:e});else if(e.statusCode===Ne.Forbidden){const t="Client configured authentication provider returned 403; failing the connection";k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",t),this.notifyState({state:"failed",error:new C(t,80019,403,e)})}else{const t="Client configured authentication provider request failed";k.logAction(this.logger,k.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",t),this.notifyState({state:this.state.failState,error:new C(t,80019,401,e)})}}onConnectionDetailsUpdate(e,t){if(!e)return;this.connectionDetails=e,e.maxMessageSize&&(this.options.maxMessageSize=e.maxMessageSize);const s=e.clientId;if(s){const e=this.realtime.auth._uncheckedSetClientId(s);if(e)return k.logAction(this.logger,k.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",e.message),void t.fail(e)}const n=e.connectionStateTtl;n&&(this.connectionStateTtl=n),this.maxIdleInterval=e.maxIdleInterval,this.emit("connectiondetails",e)}checkWsConnectivity(){const e=this.options.wsConnectivityCheckUrl||Te.wsConnectivityCheckUrl,t=new m.Config.WebSocket(e);return new Promise((e,s)=>{let n=!1;t.onopen=()=>{n||(n=!0,e(),t.close())},t.onclose=t.onerror=()=>{n||(n=!0,s())}})}sessionRecoveryName(){return this.options.recoveryKeyStorageName||"ably-connection-recovery"}getSessionRecoverData(){var e,t;return xs()&&(null==(t=null==(e=m.WebStorage)?void 0:e.getSession)?void 0:t.call(e,this.sessionRecoveryName()))}setSessionRecoverData(e){var t,s;return xs()&&(null==(s=null==(t=m.WebStorage)?void 0:t.setSession)?void 0:s.call(t,this.sessionRecoveryName(),e))}clearSessionRecoverData(){var e,t;return xs()&&(null==(t=null==(e=m.WebStorage)?void 0:e.removeSession)?void 0:t.call(e,this.sessionRecoveryName()))}},js=class extends We{constructor(e,t){super(e.logger),this.whenState=e=>We.prototype.whenState.call(this,e,this.state),this.ably=e,this.connectionManager=new Vs(e,t),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.errorReason=null,this.connectionManager.on("connectionstate",e=>{const t=this.state=e.current;m.Config.nextTick(()=>{this.emit(t,e)})}),this.connectionManager.on("update",e=>{m.Config.nextTick(()=>{this.emit("update",e)})})}connect(){k.logAction(this.logger,k.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})}async ping(){return k.logAction(this.logger,k.LOG_MINOR,"Connection.ping()",""),this.connectionManager.ping()}close(){k.logAction(this.logger,k.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})}get recoveryKey(){return this.logger.deprecationWarning("The `Connection.recoveryKey` attribute has been replaced by the `Connection.createRecoveryKey()` method. Replace your usage of `recoveryKey` with the return value of `createRecoveryKey()`. `recoveryKey` will be removed in a future version."),this.createRecoveryKey()}createRecoveryKey(){return this.connectionManager.createRecoveryKey()}},Fs=class e extends dt{constructor(t){var s,n,i,a;if(super(Te.objectifyOptions(t,!1,"BaseRealtime",k.defaultLogger)),k.logAction(this.logger,k.LOG_MINOR,"Realtime()",""),"string"==typeof EdgeRuntime)throw new C('Ably.Realtime instance cannot be used in Vercel Edge runtime. If you are running Vercel Edge functions, please replace your "new Ably.Realtime()" with "new Ably.Rest()" and use Ably Rest API instead of the Realtime API. If you are server-rendering your application in the Vercel Edge runtime, please use the condition "if (typeof EdgeRuntime === \'string\')" to prevent instantiating Ably.Realtime instance during SSR in the Vercel Edge runtime.',4e4,400);this._additionalTransportImplementations=e.transportImplementationsFromPlugins(this.options.plugins),this._RealtimePresence=null!=(n=null==(s=this.options.plugins)?void 0:s.RealtimePresence)?n:null,this._objectsPlugin=null!=(a=null==(i=this.options.plugins)?void 0:i.Objects)?a:null,this.connection=new js(this,this.options),this._channels=new Ws(this),!1!==this.options.autoConnect&&this.connect()}static transportImplementationsFromPlugins(e){const t={};return(null==e?void 0:e.WebSocketTransport)&&(t[Ss.WebSocket]=e.WebSocketTransport),(null==e?void 0:e.XHRPolling)&&(t[Ss.XhrPolling]=e.XHRPolling),t}get channels(){return this._channels}connect(){k.logAction(this.logger,k.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()}close(){k.logAction(this.logger,k.LOG_MINOR,"Realtime.close()",""),this.connection.close()}};Fs.EventEmitter=We;var $s=Fs,Ws=class extends We{constructor(e){super(e.logger),this.realtime=e,this.all=Object.create(null),e.connection.connectionManager.on("transport.active",()=>{this.onTransportActive()})}channelSerials(){let e={};for(const t of V(this.all,!0)){const s=this.all[t];s.properties.channelSerial&&(e[t]=s.properties.channelSerial)}return e}recoverChannels(e){for(const t of V(e,!0))this.get(t).properties.channelSerial=e[t]}async processChannelMessage(e){const t=e.channel;if(void 0===t)return void k.logAction(this.logger,k.LOG_ERROR,"Channels.processChannelMessage()","received event unspecified channel, action = "+e.action);const s=this.all[t];s?await s.processMessage(e):k.logAction(this.logger,k.LOG_ERROR,"Channels.processChannelMessage()","received event for non-existent channel: "+t)}onTransportActive(){for(const e in this.all){const t=this.all[e];"attaching"===t.state||"detaching"===t.state?t.checkPendingState():"suspended"===t.state?t._attach(!1,null):"attached"===t.state&&t.requestState("attaching")}}propogateConnectionInterruption(e,t){const s=["attaching","attached","detaching","suspended"],n={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"}[e];for(const i in this.all){const e=this.all[i];s.includes(e.state)&&e.notifyState(n,t)}}get(e,t){e=String(e);let s=this.all[e];if(s){if(t){if(s._shouldReattachToSetOptions(t,s.channelOptions))throw new C("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);s.setOptions(t)}}else s=this.all[e]=new ws(this.realtime,e,t);return s}getDerived(e,t,s){if(t.filter){const s=fe(t.filter),n=pe(e);e=`[filter=${s}${n.qualifierParam}]${n.channelName}`}return this.get(e,s)}release(e){e=String(e);const t=this.all[e];if(!t)return;const s=t.getReleaseErr();if(s)throw s;delete this.all[e]}},zs=$s;function Js(e,t){if(e.isSynthesized()||t.isSynthesized())return e.timestamp>=t.timestamp;const s=e.parseId(),n=t.parseId();return s.msgSerial===n.msgSerial?s.index>n.index:s.msgSerial>n.msgSerial}var Ks=class extends We{constructor(e,t,s=Js){super(e.logger),this.presence=e,this.map=Object.create(null),this.syncInProgress=!1,this.residualMembers=null,this.memberKey=t,this.newerThan=s}get(e){return this.map[e]}getClient(e){const t=this.map,s=[];for(const n in t){const i=t[n];i.clientId==e&&"absent"!=i.action&&s.push(i)}return s}list(e){const t=this.map,s=e&&e.clientId,n=e&&e.connectionId,i=[];for(const a in t){const e=t[a];"absent"!==e.action&&(s&&s!=e.clientId||n&&n!=e.connectionId||i.push(e))}return i}put(e){"enter"!==e.action&&"update"!==e.action||((e=It.fromValues(e)).action="present");const t=this.map,s=this.memberKey(e);this.residualMembers&&delete this.residualMembers[s];const n=t[s];return!(n&&!this.newerThan(e,n)||(t[s]=e,0))}values(){const e=this.map,t=[];for(const s in e){const n=e[s];"absent"!=n.action&&t.push(n)}return t}remove(e){const t=this.map,s=this.memberKey(e),n=t[s];return!(n&&!this.newerThan(e,n)||(this.syncInProgress?((e=It.fromValues(e)).action="absent",t[s]=e):delete t[s],!n))}startSync(){const e=this.map,t=this.syncInProgress;k.logAction(this.logger,k.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),this.syncInProgress||(this.residualMembers=A(e),this.setInProgress(!0))}endSync(){const e=this.map,t=this.syncInProgress;if(k.logAction(this.logger,k.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),t){for(const t in e)"absent"===e[t].action&&delete e[t];this.presence._synthesizeLeaves(j(this.residualMembers));for(const t in this.residualMembers)delete e[t];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")}waitSync(e){const t=this.syncInProgress;k.logAction(this.logger,k.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),t?this.once("sync",e):e()}clear(){this.map={},this.setInProgress(!1),this.residualMembers=null}setInProgress(e){k.logAction(this.logger,k.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+e),this.syncInProgress=e,this.presence.syncComplete=!e}};function Ys(e){const t=e.channel.client,s=t.auth.clientId;return(!s||"*"===s)&&"connected"===t.connection.state}var Qs=class extends We{constructor(e){super(e.logger),this.channel=e,this.syncComplete=!1,this.members=new Ks(this,e=>e.clientId+":"+e.connectionId),this._myMembers=new Ks(this,e=>e.clientId),this.subscriptions=new We(this.logger),this.pendingPresence=[]}async enter(e){if(Ys(this))throw new C("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,void 0,e,"enter")}async update(e){if(Ys(this))throw new C("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,void 0,e,"update")}async enterClient(e,t){return this._enterOrUpdateClient(void 0,e,t,"enter")}async updateClient(e,t){return this._enterOrUpdateClient(void 0,e,t,"update")}async _enterOrUpdateClient(e,t,s,n){const i=this.channel;if(!i.connectionManager.activeState())throw i.connectionManager.getError();k.logAction(this.logger,k.LOG_MICRO,"RealtimePresence."+n+"Client()","channel = "+i.name+", id = "+e+", client = "+(t||"(implicit) "+this.channel.client.auth.clientId));const a=It.fromData(s);a.action=n,e&&(a.id=e),t&&(a.clientId=t);const r=await a.encode(i.channelOptions);switch(i.state){case"attached":return i.sendPresence([r]);case"initialized":case"detached":i.attach();case"attaching":return new Promise((e,t)=>{this.pendingPresence.push({presence:r,callback:s=>s?t(s):e()})});default:{const e=new O("Unable to "+n+" presence channel while in "+i.state+" state",90001);throw e.code=90001,e}}}async leave(e){if(Ys(this))throw new C("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,e)}async leaveClient(e,t){const s=this.channel;if(!s.connectionManager.activeState())throw s.connectionManager.getError();k.logAction(this.logger,k.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+e);const n=It.fromData(t);n.action="leave",e&&(n.clientId=e);const i=await n.encode(s.channelOptions);switch(s.state){case"attached":return s.sendPresence([i]);case"attaching":return new Promise((e,t)=>{this.pendingPresence.push({presence:i,callback:s=>s?t(s):e()})});case"initialized":case"failed":throw new O("Unable to leave presence channel (incompatible state)",90001);default:throw s.invalidStateError()}}async get(e){const t=!e||!("waitForSync"in e)||e.waitForSync;return new Promise((s,n)=>{function i(t){s(e?t.list(e):t.values())}"suspended"!==this.channel.state?function(e,t,s){switch(e.state){case"attached":case"suspended":s();break;case"initialized":case"detached":case"detaching":case"attaching":ne(e.attach(),function(e){e?t(e):s()});break;default:t(C.fromValues(e.invalidStateError()))}}(this.channel,e=>n(e),()=>{const e=this.members;t?e.waitSync(function(){i(e)}):i(e)}):t?n(C.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):i(this.members)})}async history(e){k.logAction(this.logger,k.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name);const t=this.channel.client.rest.presenceMixin;if(e&&e.untilAttach){if("attached"!==this.channel.state)throw new C("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400);delete e.untilAttach,e.from_serial=this.channel.properties.attachSerial}return t.history(this,e)}setPresence(e,t,s){let n,i;k.logAction(this.logger,k.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+e.length+" participants; syncChannelSerial = "+s);const a=this.members,r=this._myMembers,o=[],c=this.channel.connectionManager.connectionId;t&&(this.members.startSync(),s&&(i=s.match(/^[\w-]+:(.*)$/))&&(n=i[1]));for(let l of e)switch(l.action){case"leave":a.remove(l)&&o.push(l),l.connectionId!==c||l.isSynthesized()||r.remove(l);break;case"enter":case"present":case"update":a.put(l)&&o.push(l),l.connectionId===c&&r.put(l)}t&&!n&&(a.endSync(),this.channel.syncChannelSerial=null);for(let l=0;l<o.length;l++){const e=o[l];this.subscriptions.emit(e.action,e)}}onAttached(e){k.logAction(this.logger,k.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+e),e?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear()),this._ensureMyMembersPresent();const t=this.pendingPresence,s=t.length;if(s){this.pendingPresence=[];const e=[],n=Ie.create(this.logger);k.logAction(this.logger,k.LOG_MICRO,"RealtimePresence.onAttached","sending "+s+" queued presence messages");for(let i=0;i<s;i++){const s=t[i];e.push(s.presence),n.push(s.callback)}this.channel.sendPresence(e).then(()=>n()).catch(e=>n(e))}}actOnChannelState(e,t,s){switch(e){case"attached":this.onAttached(t);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(s)}}failPendingPresence(e){if(this.pendingPresence.length){k.logAction(this.logger,k.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+Q(e));for(let s=0;s<this.pendingPresence.length;s++)try{this.pendingPresence[s].callback(e)}catch(t){}this.pendingPresence=[]}}_clearMyMembers(){this._myMembers.clear()}_ensureMyMembersPresent(){const e=this._myMembers,t=this.channel.connectionManager.connectionId;for(const s in e.map){const n=e.map[s];k.logAction(this.logger,k.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+n.clientId+'" into the presence set');const i=n.connectionId===t?n.id:void 0;this._enterOrUpdateClient(i,n.clientId,n.data,"enter").catch(e=>{const t=new C("Presence auto re-enter failed",91004,400,e);k.logAction(this.logger,k.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()","Presence auto re-enter failed; reason = "+Q(e));const s=new ms(this.channel.state,this.channel.state,!0,!1,t);this.channel.emit("update",s)})}}_synthesizeLeaves(e){const t=this.subscriptions;e.forEach(function(e){const s=It.fromValues({action:"leave",connectionId:e.connectionId,clientId:e.clientId,data:e.data,encoding:e.encoding,timestamp:Date.now()});t.emit("leave",s)})}async subscribe(...e){const t=ws.processListenerArgs(e),s=t[0],n=t[1],i=this.channel;if("failed"===i.state)throw C.fromValues(i.invalidStateError());this.subscriptions.on(s,n),!1!==i.channelOptions.attachOnSubscribe&&await i.attach()}unsubscribe(...e){const t=ws.processListenerArgs(e),s=t[0],n=t[1];this.subscriptions.off(s,n)}},Xs=Ss.WebSocket,Zs=class extends Ns{constructor(e,t,s){super(e,t,s),this.shortName=Xs,s.heartbeats=m.Config.useProtocolHeartbeats,this.wsHost=s.host}static isAvailable(){return!!m.Config.WebSocket}createWebSocket(e,t){return this.uri=e+J(t),new m.Config.WebSocket(this.uri)}toString(){return"WebSocketTransport; uri="+this.uri}connect(){k.logAction(this.logger,k.LOG_MINOR,"WebSocketTransport.connect()","starting"),Ns.prototype.connect.call(this);const e=this,t=this.params,s=t.options,n=(s.tls?"wss://":"ws://")+this.wsHost+":"+Te.getPort(s)+"/";k.logAction(this.logger,k.LOG_MINOR,"WebSocketTransport.connect()","uri: "+n),ne(this.auth.getAuthParams(),function(s,i){if(e.isDisposed)return;let a="";for(const e in i)a+=" "+e+": "+i[e]+";";if(k.logAction(e.logger,k.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+a+" err: "+s),s)return void e.disconnect(s);const r=t.getConnectParams(i);try{const t=e.wsConnection=e.createWebSocket(n,r);t.binaryType=m.Config.binaryType,t.onopen=function(){e.onWsOpen()},t.onclose=function(t){e.onWsClose(t)},t.onmessage=function(t){e.onWsData(t.data)},t.onerror=function(t){e.onWsError(t)},t.on&&t.on("ping",function(){e.onActivity()})}catch(o){k.logAction(e.logger,k.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(o.stack||o.message)),e.disconnect(o)}})}send(e){const t=this.wsConnection;if(t)try{t.send(ls(e,this.connectionManager.realtime._MsgPack,this.params.format))}catch(s){const e="Exception from ws connection when trying to send: "+Q(s);k.logAction(this.logger,k.LOG_ERROR,"WebSocketTransport.send()",e),this.finish("disconnected",new C(e,5e4,500))}else k.logAction(this.logger,k.LOG_ERROR,"WebSocketTransport.send()","No socket connection")}onWsData(e){k.logAction(this.logger,k.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+e.length+"; type = "+typeof e);try{this.onProtocolMessage((t=e,s=this.connectionManager.realtime._MsgPack,n=this.connectionManager.realtime._RealtimePresence,i=this.connectionManager.realtime._Annotations,a=this.connectionManager.realtime._objectsPlugin,r=this.format,ds(ie(t,s,r),n,i,a)))}catch(o){k.logAction(this.logger,k.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+o.stack)}var t,s,n,i,a,r}onWsOpen(){k.logAction(this.logger,k.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")}onWsClose(e){let t,s;if("object"==typeof e?(s=e.code,t=e.wasClean||1e3===s):(s=e,t=1e3==s),delete this.wsConnection,t){k.logAction(this.logger,k.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");const e=new C("Websocket closed",80003,400);this.finish("disconnected",e)}else{const e="Unclean disconnection of WebSocket ; code = "+s,t=new C(e,80003,400);k.logAction(this.logger,k.LOG_MINOR,"WebSocketTransport.onWsClose()",e),this.finish("disconnected",t)}this.emit("disposed")}onWsError(e){k.logAction(this.logger,k.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+e.message),m.Config.nextTick(()=>{this.disconnect(Error(e.message))})}dispose(){k.logAction(this.logger,k.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;const e=this.wsConnection;e&&(e.onmessage=function(){},delete this.wsConnection,m.Config.nextTick(()=>{if(k.logAction(this.logger,k.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!e)throw new Error("WebSocketTransport.dispose(): wsConnection is not defined");e.close()}))}},en=class{static subscribeFilter(e,t,s){const n=e=>{var n,i,a,r,o,c;const l={name:e.name,refTimeserial:null==(i=null==(n=e.extras)?void 0:n.ref)?void 0:i.timeserial,refType:null==(r=null==(a=e.extras)?void 0:a.ref)?void 0:r.type,isRef:!!(null==(c=null==(o=e.extras)?void 0:o.ref)?void 0:c.timeserial),clientId:e.clientId};Object.entries(t).find(([e,t])=>void 0!==t&&l[e]!==t)||s(e)};this.addFilteredSubscription(e,t,s,n),e.subscriptions.on(n)}static addFilteredSubscription(e,t,s,n){var i;if(e.filteredSubscriptions||(e.filteredSubscriptions=new Map),e.filteredSubscriptions.has(s)){const a=e.filteredSubscriptions.get(s);a.set(t,(null==(i=null==a?void 0:a.get(t))?void 0:i.concat(n))||[n])}else e.filteredSubscriptions.set(s,new Map([[t,[n]]]))}static getAndDeleteFilteredSubscriptions(e,t,s){if(!e.filteredSubscriptions)return[];if(!s&&t)return Array.from(e.filteredSubscriptions.entries()).map(([s,n])=>{var i;let a=n.get(t);return n.delete(t),0===n.size&&(null==(i=e.filteredSubscriptions)||i.delete(s)),a}).reduce((e,t)=>t?e.concat(...t):e,[]);if(!s||!e.filteredSubscriptions.has(s))return[];const n=e.filteredSubscriptions.get(s);if(!t){const t=Array.from(n.values()).reduce((e,t)=>e.concat(...t),[]);return e.filteredSubscriptions.delete(s),t}let i=n.get(t);return n.delete(t),i||[]}},tn=class e extends zs{constructor(t){var s;const n=e._MsgPack;if(!n)throw new Error("Expected DefaultRealtime._MsgPack to have been set");super(Te.objectifyOptions(t,!0,"Realtime",k.defaultLogger,f(p({},Kt),{Crypto:null!=(s=e.Crypto)?s:void 0,MsgPack:n,RealtimePresence:{RealtimePresence:Qs,PresenceMessage:It,WirePresenceMessage:Tt},Annotations:{Annotation:ns,WireAnnotation:ss,RealtimeAnnotations:_s,RestAnnotations:cs},WebSocketTransport:Zs,MessageInteractions:en})))}static get Crypto(){if(null===this._Crypto)throw new Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(e){this._Crypto=e}};tn.Utils=S,tn.ConnectionManager=Vs,tn.ProtocolMessage=vs,tn._Crypto=null,tn.Message=Yt,tn.PresenceMessage=Qt,tn.Annotation=is,tn._MsgPack=null,tn._Http=Fe,tn._PresenceMap=Ks,tn._MessageEncoding=rt;var sn=tn,nn=Uint8Array,an=Uint32Array,rn=Math.pow,on=new an(8),cn=[],ln=new an(64);function un(e){return(e-(0|e))*rn(2,32)|0}for(var dn,hn,pn=2,fn=0;fn<64;){for(dn=!0,hn=2;hn<=pn/2;hn++)pn%hn===0&&(dn=!1);dn&&(fn<8&&(on[fn]=un(rn(pn,.5))),cn[fn]=un(rn(pn,1/3)),fn++),pn++}var gn=!!new nn(new an([1]).buffer)[0];function vn(e){return gn?e>>>24|(e>>>16&255)<<8|(65280&e)<<8|e<<24:e}function mn(e,t){return e>>>t|e<<32-t}function yn(e){var t,s=on.slice(),n=e.length,i=8*n,a=512-(i+64)%512-1+i+65,r=new nn(a/8),o=new an(r.buffer);r.set(e,0),r[n]=128,o[o.length-1]=vn(i);for(var c=0;c<a/32;c+=16){var l=s.slice();for(t=0;t<64;t++){var u;if(t<16)u=vn(o[c+t]);else{var d=ln[t-15],h=ln[t-2];u=ln[t-7]+ln[t-16]+(mn(d,7)^mn(d,18)^d>>>3)+(mn(h,17)^mn(h,19)^h>>>10)}ln[t]=u|=0;for(var p=(mn(l[4],6)^mn(l[4],11)^mn(l[4],25))+(l[4]&l[5]^~l[4]&l[6])+l[7]+u+cn[t],f=(mn(l[0],2)^mn(l[0],13)^mn(l[0],22))+(l[0]&l[1]^l[2]&(l[0]^l[1])),g=7;g>0;g--)l[g]=l[g-1];l[0]=p+f|0,l[4]=l[4]+p|0}for(t=0;t<8;t++)s[t]=s[t]+l[t]|0}return new nn(new an(s.map(function(e){return vn(e)})).buffer)}var bn,wn=new class{constructor(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}uint8ViewToBase64(e){let t="";const s=this.base64CharSet,n=e.byteLength,i=n%3,a=n-i;let r,o,c,l,u;for(let d=0;d<a;d+=3)u=e[d]<<16|e[d+1]<<8|e[d+2],r=(16515072&u)>>18,o=(258048&u)>>12,c=(4032&u)>>6,l=63&u,t+=s[r]+s[o]+s[c]+s[l];return 1==i?(u=e[a],r=(252&u)>>2,o=(3&u)<<4,t+=s[r]+s[o]+"=="):2==i&&(u=e[a]<<8|e[a+1],r=(64512&u)>>10,o=(1008&u)>>4,c=(15&u)<<2,t+=s[r]+s[o]+s[c]+"="),t}base64ToArrayBuffer(e){const t=null==atob?void 0:atob(e),s=t.length,n=new Uint8Array(s);for(let i=0;i<s;i++){const e=t.charCodeAt(i);n[i]=e}return this.toArrayBuffer(n)}isBuffer(e){return e instanceof ArrayBuffer||ArrayBuffer.isView(e)}toBuffer(e){if(!ArrayBuffer)throw new Error("Can't convert to Buffer: browser does not support the necessary types");if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(this.toArrayBuffer(e));throw new Error("BufferUtils.toBuffer expected an ArrayBuffer or a view onto one")}toArrayBuffer(e){if(!ArrayBuffer)throw new Error("Can't convert to ArrayBuffer: browser does not support the necessary types");if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);throw new Error("BufferUtils.toArrayBuffer expected an ArrayBuffer or a view onto one")}base64Encode(e){return this.uint8ViewToBase64(this.toBuffer(e))}base64UrlEncode(e){return this.base64Encode(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}base64Decode(e){if(ArrayBuffer&&m.Config.atob)return this.base64ToArrayBuffer(e);throw new Error("Expected ArrayBuffer to exist and Platform.Config.atob to be configured")}hexEncode(e){return this.toBuffer(e).reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")}hexDecode(e){if(e.length%2!=0)throw new Error("Can't create a byte array from a hex string of odd length");const t=new Uint8Array(e.length/2);for(let s=0;s<t.length;s++)t[s]=parseInt(e.slice(2*s,2*(s+1)),16);return this.toArrayBuffer(t)}utf8Encode(e){if(m.Config.TextEncoder){const t=(new m.Config.TextEncoder).encode(e);return this.toArrayBuffer(t)}throw new Error("Expected TextEncoder to be configured")}utf8Decode(e){if(!this.isBuffer(e))throw new Error("Expected input of utf8decode to be an arraybuffer or typed array");if(TextDecoder)return(new TextDecoder).decode(e);throw new Error("Expected TextDecoder to be configured")}areBuffersEqual(e,t){if(!e||!t)return!1;const s=this.toArrayBuffer(e),n=this.toArrayBuffer(t);if(s.byteLength!=n.byteLength)return!1;const i=new Uint8Array(s),a=new Uint8Array(n);for(var r=0;r<i.length;r++)if(i[r]!=a[r])return!1;return!0}byteLength(e){return e instanceof ArrayBuffer||ArrayBuffer.isView(e)?e.byteLength:-1}arrayBufferViewToBuffer(e){return this.toArrayBuffer(e)}concat(e){const t=e.reduce((e,t)=>e+t.byteLength,0),s=new Uint8Array(t);let n=0;for(const i of e){const e=this.toBuffer(i);s.set(e,n),n+=e.byteLength}return s.buffer}sha256(e){const t=yn(this.toBuffer(e));return this.toArrayBuffer(t)}hmacSha256(e,t){const s=function(e,t){if(e.length>64&&(e=yn(e)),e.length<64){const t=new Uint8Array(64);t.set(e,0),e=t}for(var s=new Uint8Array(64),n=new Uint8Array(64),i=0;i<64;i++)s[i]=54^e[i],n[i]=92^e[i];var a=new Uint8Array(t.length+64);a.set(s,0),a.set(t,64);var r=new Uint8Array(96);return r.set(n,0),r.set(yn(a),64),yn(r)}(this.toBuffer(t),this.toBuffer(e));return this.toArrayBuffer(s)}},_n=(e=>(e[e.REQ_SEND=0]="REQ_SEND",e[e.REQ_RECV=1]="REQ_RECV",e[e.REQ_RECV_POLL=2]="REQ_RECV_POLL",e[e.REQ_RECV_STREAM=3]="REQ_RECV_STREAM",e))(_n||{}),kn=_n;function Sn(){return new C("No HTTP request plugin provided. Provide at least one of the FetchRequest or XHRRequest plugins.",400,4e4)}var Rn=((bn=class{constructor(e){var t;this.checksInProgress=null,this.checkConnectivity=void 0,this.supportsAuthHeaders=!1,this.supportsLinkHeaders=!1,this.client=null!=e?e:null;const s=(null==e?void 0:e.options.connectivityCheckUrl)||Te.connectivityCheckUrl,n=null!=(t=null==e?void 0:e.options.connectivityCheckParams)?t:null,i=!(null==e?void 0:e.options.connectivityCheckUrl),a=p(p({},Rn.bundledRequestImplementations),null==e?void 0:e._additionalHTTPRequestImplementations),r=a.XHRRequest,o=a.FetchRequest,c=!(!r&&!o);if(!c)throw Sn();m.Config.xhrSupported&&r?(this.supportsAuthHeaders=!0,this.Request=async function(t,s,n,i,a){return new Promise(o=>{var c;const l=r.createRequest(s,n,i,a,kn.REQ_SEND,null!=(c=e&&e.options.timeouts)?c:null,this.logger,t);l.once("complete",(e,t,s,n,i)=>o({error:e,body:t,headers:s,unpacked:n,statusCode:i})),l.exec()})},(null==e?void 0:e.options.disableConnectivityCheck)?this.checkConnectivity=async function(){return!0}:this.checkConnectivity=async function(){var e;k.logAction(this.logger,k.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+s);const t=await this.doUri(Pe.Get,s,null,null,n);let a=!1;var r;return a=i?!t.error&&"yes"==(null==(e=t.body)?void 0:e.replace(/\n/,"")):!t.error&&(r=t.statusCode)>=200&&r<400,k.logAction(this.logger,k.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+a),a}):m.Config.fetchSupported&&o?(this.supportsAuthHeaders=!0,this.Request=async(t,s,n,i,a)=>o(t,null!=e?e:null,s,n,i,a),(null==e?void 0:e.options.disableConnectivityCheck)?this.checkConnectivity=async function(){return!0}:this.checkConnectivity=async function(){var e;k.logAction(this.logger,k.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Sending; "+s);const t=await this.doUri(Pe.Get,s,null,null,null),n=!t.error&&"yes"==(null==(e=t.body)?void 0:e.replace(/\n/,""));return k.logAction(this.logger,k.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Result: "+n),n}):this.Request=async()=>({error:c?new O("no supported HTTP transports available",null,400):Sn()})}get logger(){var e,t;return null!=(t=null==(e=this.client)?void 0:e.logger)?t:k.defaultLogger}async doUri(e,t,s,n,i){return this.Request?this.Request(e,t,s,i,n):{error:new O("Request invoked before assigned to",null,500)}}shouldFallback(e){const t=e.statusCode;return 408===t&&!e.code||400===t&&!e.code||t>=500&&t<=504}}).methods=[Pe.Get,Pe.Delete,Pe.Post,Pe.Put,Pe.Patch],bn.methodsWithoutBody=[Pe.Get,Pe.Delete],bn.methodsWithBody=[Pe.Post,Pe.Put,Pe.Patch],bn),Cn=Rn,On="ablyjs-storage-test",En=void 0!==s?s:"undefined"!=typeof window?window:self,An=new class{constructor(){try{En.sessionStorage.setItem(On,On),En.sessionStorage.removeItem(On),this.sessionSupported=!0}catch(e){this.sessionSupported=!1}try{En.localStorage.setItem(On,On),En.localStorage.removeItem(On),this.localSupported=!0}catch(e){this.localSupported=!1}}get(e){return this._get(e,!1)}getSession(e){return this._get(e,!0)}remove(e){return this._remove(e,!1)}removeSession(e){return this._remove(e,!0)}set(e,t,s){return this._set(e,t,s,!1)}setSession(e,t,s){return this._set(e,t,s,!0)}_set(e,t,s,n){const i={value:t};return s&&(i.expires=Date.now()+s),this.storageInterface(n).setItem(e,JSON.stringify(i))}_get(e,t){if(t&&!this.sessionSupported)throw new Error("Session Storage not supported");if(!t&&!this.localSupported)throw new Error("Local Storage not supported");const s=this.storageInterface(t).getItem(e);if(!s)return null;const n=JSON.parse(s);return n.expires&&n.expires<Date.now()?(this.storageInterface(t).removeItem(e),null):n.value}_remove(e,t){return this.storageInterface(t).removeItem(e)}storageInterface(e){return e?En.sessionStorage:En.localStorage}},Tn=de(),In={agent:"browser",logTimestamps:!0,userAgent:Tn.navigator&&Tn.navigator.userAgent.toString(),currentUrl:Tn.location&&Tn.location.href,binaryType:"arraybuffer",WebSocket:Tn.WebSocket,fetchSupported:!!Tn.fetch,xhrSupported:Tn.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,allowComet:function(){const e=Tn.location;return!Tn.WebSocket||!e||!e.origin||e.origin.indexOf("http")>-1}(),useProtocolHeartbeats:!0,supportsBinary:!!Tn.TextDecoder,preferBinary:!1,ArrayBuffer:Tn.ArrayBuffer,atob:Tn.atob,nextTick:void 0!==Tn.setImmediate?Tn.setImmediate.bind(Tn):function(e){setTimeout(e,0)},addEventListener:Tn.addEventListener,inspect:JSON.stringify,stringByteSize:function(e){return Tn.TextDecoder&&(new Tn.TextEncoder).encode(e).length||e.length},TextEncoder:Tn.TextEncoder,TextDecoder:Tn.TextDecoder,getRandomArrayBuffer:async function(e){const t=new Uint8Array(e);return Tn.crypto.getRandomValues(t),t.buffer},isWebworker:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,push:{platform:"browser",formFactor:"desktop",storage:An}};function Mn(e){return function(e){const t=[80015,80017,80030];return!!e.code&&!Ge.isTokenErr(e)&&(!!t.includes(e.code)||e.code>=4e4&&e.code<5e4)}(e)?[ps({action:ze.ERROR,error:e})]:[ps({action:ze.DISCONNECTED,error:e})]}var Pn=class extends Ns{constructor(e,t,s){super(e,t,s,!0),this.onAuthUpdated=e=>{this.authParams={access_token:e.token}},this.stream=!("stream"in s)||s.stream,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}connect(){k.logAction(this.logger,k.LOG_MINOR,"CometTransport.connect()","starting"),Ns.prototype.connect.call(this);const e=this.params,t=e.options,s=Te.getHost(t,e.host),n=Te.getPort(t),i=t.tls?"https://":"http://";this.baseUri=i+s+":"+n+"/comet/";const a=this.baseUri+"connect";k.logAction(this.logger,k.LOG_MINOR,"CometTransport.connect()","uri: "+a),ne(this.auth.getAuthParams(),(e,t)=>{if(e)return void this.disconnect(e);if(this.isDisposed)return;this.authParams=t;const s=this.params.getConnectParams(t);"stream"in s&&(this.stream=s.stream),k.logAction(this.logger,k.LOG_MINOR,"CometTransport.connect()","connectParams:"+J(s));let n=!1;const i=this.recvRequest=this.createRequest(a,null,s,null,this.stream?kn.REQ_RECV_STREAM:kn.REQ_RECV);i.on("data",e=>{this.recvRequest&&(n||(n=!0,this.emit("preconnect")),this.onData(e))}),i.on("complete",e=>{this.recvRequest||(e=e||new C("Request cancelled",80003,400)),this.recvRequest=null,n||e||(n=!0,this.emit("preconnect")),this.onActivity(),e?e.code?this.onData(Mn(e)):this.disconnect(e):m.Config.nextTick(()=>{this.recv()})}),i.exec()})}requestClose(){k.logAction(this.logger,k.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)}requestDisconnect(){k.logAction(this.logger,k.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)}_requestCloseOrDisconnect(e){const t=e?this.closeUri:this.disconnectUri;if(t){const s=this.createRequest(t,null,this.authParams,null,kn.REQ_SEND);s.on("complete",t=>{t&&(k.logAction(this.logger,k.LOG_ERROR,"CometTransport.request"+(e?"Close()":"Disconnect()"),"request returned err = "+Q(t)),this.finish("disconnected",t))}),s.exec()}}dispose(){k.logAction(this.logger,k.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(k.logAction(this.logger,k.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",Ms.disconnected()),m.Config.nextTick(()=>{this.emit("disposed")}))}onConnect(e){var t;if(this.isDisposed)return;const s=null==(t=e.connectionDetails)?void 0:t.connectionKey;Ns.prototype.onConnect.call(this,e);const n=this.baseUri+s;k.logAction(this.logger,k.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+n),this.sendUri=n+"/send",this.recvUri=n+"/recv",this.closeUri=n+"/close",this.disconnectUri=n+"/disconnect"}send(e){if(this.sendRequest)return this.pendingItems=this.pendingItems||[],void this.pendingItems.push(e);const t=this.pendingItems||[];t.push(e),this.pendingItems=null,this.sendItems(t)}sendAnyPending(){const e=this.pendingItems;e&&(this.pendingItems=null,this.sendItems(e))}sendItems(e){const t=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(e),kn.REQ_SEND);t.on("complete",(e,t)=>{e&&k.logAction(this.logger,k.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+Q(e)),this.sendRequest=null,e?e.code?this.onData(Mn(e)):this.disconnect(e):(t&&this.onData(t),this.pendingItems&&m.Config.nextTick(()=>{this.sendRequest||this.sendAnyPending()}))}),t.exec()}recv(){if(this.recvRequest)return;if(!this.isConnected)return;const e=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?kn.REQ_RECV_STREAM:kn.REQ_RECV_POLL);e.on("data",e=>{this.onData(e)}),e.on("complete",e=>{this.recvRequest=null,this.onActivity(),e?e.code?this.onData(Mn(e)):this.disconnect(e):m.Config.nextTick(()=>{this.recv()})}),e.exec()}onData(e){try{const t=this.decodeResponse(e);if(t&&t.length)for(let e=0;e<t.length;e++)this.onProtocolMessage(ds(t[e],this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin))}catch(t){k.logAction(this.logger,k.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+t.stack)}}encodeRequest(e){return JSON.stringify(e)}decodeResponse(e){return"string"==typeof e?JSON.parse(e):e}};function Ln(e,t){if(function(e,t){return re(V(t)).includes("x-ably-errorcode")}(0,t))return e.error&&C.fromValues(e.error)}var Nn=function(){},Dn=0,Un={},xn=class e extends We{constructor(e,t,s,n,i,a,r,o){super(r),(s=s||{}).rnd=ee(),this.uri=e+J(s),this.headers=t||{},this.body=n,this.method=o?o.toUpperCase():P(n)?"GET":"POST",this.requestMode=i,this.timeouts=a,this.timedOut=!1,this.requestComplete=!1,this.id=String(++Dn),Un[this.id]=this}static createRequest(t,s,n,i,a,r,o,c){const l=r||Te.TIMEOUTS;return new e(t,s,A(n),i,a,l,o,c)}complete(e,t,s,n,i){this.requestComplete||(this.requestComplete=!0,!e&&t&&this.emit("data",t),this.emit("complete",e,t,s,n,i),this.dispose())}abort(){this.dispose()}exec(){let e=this.headers;const t=this.requestMode==kn.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,s=this.timer=setTimeout(()=>{this.timedOut=!0,i.abort()},t),n=this.method,i=this.xhr=new XMLHttpRequest,a=e.accept;let r=this.body,o="text";a?0===a.indexOf("application/x-msgpack")&&(o="arraybuffer"):e.accept="application/json",r&&(e["content-type"]||(e["content-type"]="application/json")).indexOf("application/json")>-1&&"string"!=typeof r&&(r=JSON.stringify(r)),i.open(n,this.uri,!0),i.responseType=o,"authorization"in e&&(i.withCredentials=!0);for(const m in e)i.setRequestHeader(m,e[m]);const c=(e,t,s,n)=>{var i;let a=t+" (event type: "+e.type+")";(null==(i=null==this?void 0:this.xhr)?void 0:i.statusText)&&(a+=", current statusText is "+this.xhr.statusText),k.logAction(this.logger,k.LOG_ERROR,"Request.on"+e.type+"()",a),this.complete(new O(a,s,n))};let l,u,d;i.onerror=function(e){c(e,"XHR error occurred",null,400)},i.onabort=e=>{this.timedOut?c(e,"Request aborted due to request timeout expiring",null,408):c(e,"Request cancelled",null,400)},i.ontimeout=function(e){c(e,"Request timed out",null,408)};let h=0,p=!1;const f=()=>{clearTimeout(s),d=u<400,204!=u?l=this.requestMode==kn.REQ_RECV_STREAM&&d&&function(e){return e.getResponseHeader&&(e.getResponseHeader("transfer-encoding")||!e.getResponseHeader("content-length"))}(i):this.complete(null,null,null,null,u)},g=()=>{let t;try{const s=function(e,t){return e.getResponseHeader&&e.getResponseHeader(t)}(i,"content-type");if(s?s.indexOf("application/json")>=0:"text"==i.responseType){const e="arraybuffer"===i.responseType?m.BufferUtils.utf8Decode(i.response):String(i.responseText);t=e.length?JSON.parse(e):e,p=!0}else t=i.response;void 0!==t.response?(u=t.statusCode,d=u<400,e=t.headers,t=t.response):e=function(e){const t=e.getAllResponseHeaders().trim().split("\r\n"),s={};for(let n=0;n<t.length;n++){const e=t[n].split(":").map(e=>e.trim());s[e[0].toLowerCase()]=e[1]}return s}(i)}catch(n){return void this.complete(new O("Malformed response body from server: "+n.message,null,400))}if(d||Array.isArray(t))return void this.complete(null,t,e,p,u);let s=Ln(t,e);s||(s=new O("Error response received from server: "+u+" body was: "+m.Config.inspect(t),null,u)),this.complete(s,t,e,p,u)};function v(){const e=i.responseText,t=e.length-1;let s,n;for(;h<t&&(s=e.indexOf("\n",h))>-1;)n=e.slice(h,s),h=s+1,y(n)}const y=e=>{try{e=JSON.parse(e)}catch(t){return void this.complete(new O("Malformed response body from server: "+t.message,null,400))}this.emit("data",e)},b=()=>{v(),this.streamComplete=!0,m.Config.nextTick(()=>{this.complete()})};i.onreadystatechange=function(){const e=i.readyState;e<3||0!==i.status&&(void 0===u&&(u=i.status,f()),3==e&&l?v():4==e&&(l?b():g()))},i.send(r)}dispose(){const e=this.xhr;if(e){e.onreadystatechange=e.onerror=e.onabort=e.ontimeout=Nn,this.xhr=null;const t=this.timer;t&&(clearTimeout(t),this.timer=null),this.requestComplete||e.abort()}delete Un[this.id]}},Bn=Ss.XhrPolling,Hn={order:["xhr_polling"],bundledImplementations:{web_socket:Zs,xhr_polling:class extends Pn{constructor(e,t,s){super(e,t,s),this.shortName=Bn,s.stream=!1,this.shortName=Bn}static isAvailable(){return!(!m.Config.xhrSupported||!m.Config.allowComet)}toString(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected}createRequest(e,t,s,n,i){return xn.createRequest(e,t,s,n,i,this.timeouts,this.logger)}}}},qn={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",wsConnectivityCheckUrl:"wss://ws-up.ably-realtime.com",defaultTransports:[Ss.XhrPolling,Ss.WebSocket]};function Gn(e,t,s){for(let n=0,i=s.length;n<i;n++){const i=s.charCodeAt(n);if(i<128)e.setUint8(t++,i>>>0&127);else if(i<2048)e.setUint8(t++,i>>>6&31|192),e.setUint8(t++,i>>>0&63|128);else if(i<65536)e.setUint8(t++,i>>>12&15|224),e.setUint8(t++,i>>>6&63|128),e.setUint8(t++,i>>>0&63|128);else{if(!(i<1114112))throw new Error("bad codepoint "+i);e.setUint8(t++,i>>>18&7|240),e.setUint8(t++,i>>>12&63|128),e.setUint8(t++,i>>>6&63|128),e.setUint8(t++,i>>>0&63|128)}}}function Vn(e,t,s){let n="";for(let i=t,a=t+s;i<a;i++){const t=e.getUint8(i);if(128&t)if(192!=(224&t))if(224!=(240&t)){if(240!=(248&t))throw new Error("Invalid byte "+t.toString(16));n+=String.fromCharCode((7&t)<<18|(63&e.getUint8(++i))<<12|(63&e.getUint8(++i))<<6|63&e.getUint8(++i))}else n+=String.fromCharCode((15&t)<<12|(63&e.getUint8(++i))<<6|63&e.getUint8(++i));else n+=String.fromCharCode((15&t)<<6|63&e.getUint8(++i));else n+=String.fromCharCode(t)}return n}function jn(e){let t=0;for(let s=0,n=e.length;s<n;s++){const n=e.charCodeAt(s);if(n<128)t+=1;else if(n<2048)t+=2;else if(n<65536)t+=3;else{if(!(n<1114112))throw new Error("bad codepoint "+n);t+=4}}return t}var Fn=4294967296,$n=1/Fn,Wn=class{constructor(e,t){this.map=e=>{const t={};for(let s=0;s<e;s++)t[this.parse()]=this.parse();return t},this.bin=e=>{const t=new ArrayBuffer(e);return new Uint8Array(t).set(new Uint8Array(this.view.buffer,this.offset,e),0),this.offset+=e,t},this.buf=this.bin,this.str=e=>{const t=Vn(this.view,this.offset,e);return this.offset+=e,t},this.array=e=>{const t=new Array(e);for(let s=0;s<e;s++)t[s]=this.parse();return t},this.ext=e=>(this.offset+=e,{type:this.view.getInt8(this.offset),data:this.buf(e)}),this.parse=()=>{const e=this.view.getUint8(this.offset);let t,s;if(!(128&e))return this.offset++,e;if(128==(240&e))return s=15&e,this.offset++,this.map(s);if(144==(240&e))return s=15&e,this.offset++,this.array(s);if(160==(224&e))return s=31&e,this.offset++,this.str(s);if(!(224&~e))return t=this.view.getInt8(this.offset),this.offset++,t;switch(e){case 192:return this.offset++,null;case 193:return void this.offset++;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return s=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(s);case 197:return s=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(s);case 198:return s=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(s);case 199:return s=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(s);case 200:return s=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(s);case 201:return s=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(s);case 202:return t=this.view.getFloat32(this.offset+1),this.offset+=5,t;case 203:return t=this.view.getFloat64(this.offset+1),this.offset+=9,t;case 204:return t=this.view.getUint8(this.offset+1),this.offset+=2,t;case 205:return t=this.view.getUint16(this.offset+1),this.offset+=3,t;case 206:return t=this.view.getUint32(this.offset+1),this.offset+=5,t;case 207:return t=function(e,t){return t=t||0,e.getUint32(t)*Fn+e.getUint32(t+4)}(this.view,this.offset+1),this.offset+=9,t;case 208:return t=this.view.getInt8(this.offset+1),this.offset+=2,t;case 209:return t=this.view.getInt16(this.offset+1),this.offset+=3,t;case 210:return t=this.view.getInt32(this.offset+1),this.offset+=5,t;case 211:return t=function(e,t){return t=t||0,e.getInt32(t)*Fn+e.getUint32(t+4)}(this.view,this.offset+1),this.offset+=9,t;case 212:return s=1,this.offset++,this.ext(s);case 213:return s=2,this.offset++,this.ext(s);case 214:return s=4,this.offset++,this.ext(s);case 215:return s=8,this.offset++,this.ext(s);case 216:return s=16,this.offset++,this.ext(s);case 217:return s=this.view.getUint8(this.offset+1),this.offset+=2,this.str(s);case 218:return s=this.view.getUint16(this.offset+1),this.offset+=3,this.str(s);case 219:return s=this.view.getUint32(this.offset+1),this.offset+=5,this.str(s);case 220:return s=this.view.getUint16(this.offset+1),this.offset+=3,this.array(s);case 221:return s=this.view.getUint32(this.offset+1),this.offset+=5,this.array(s);case 222:return s=this.view.getUint16(this.offset+1),this.offset+=3,this.map(s);case 223:return s=this.view.getUint32(this.offset+1),this.offset+=5,this.map(s)}throw new Error("Unknown type 0x"+e.toString(16))},this.offset=t||0,this.view=e}};function zn(e,t){return Object.keys(e).filter(function(s){const n=e[s];return!(t&&null==n||"function"==typeof n&&!n.toJSON)})}function Jn(e,t,s,n){const i=typeof e;if("string"==typeof e){const n=jn(e);if(n<32)return t.setUint8(s,160|n),Gn(t,s+1,e),1+n;if(n<256)return t.setUint8(s,217),t.setUint8(s+1,n),Gn(t,s+2,e),2+n;if(n<65536)return t.setUint8(s,218),t.setUint16(s+1,n),Gn(t,s+3,e),3+n;if(n<4294967296)return t.setUint8(s,219),t.setUint32(s+1,n),Gn(t,s+5,e),5+n}if(ArrayBuffer.isView&&ArrayBuffer.isView(e)&&(e=e.buffer),e instanceof ArrayBuffer){const n=e.byteLength;if(n<256)return t.setUint8(s,196),t.setUint8(s+1,n),new Uint8Array(t.buffer).set(new Uint8Array(e),s+2),2+n;if(n<65536)return t.setUint8(s,197),t.setUint16(s+1,n),new Uint8Array(t.buffer).set(new Uint8Array(e),s+3),3+n;if(n<4294967296)return t.setUint8(s,198),t.setUint32(s+1,n),new Uint8Array(t.buffer).set(new Uint8Array(e),s+5),5+n}if("number"==typeof e){if(Math.floor(e)!==e)return t.setUint8(s,203),t.setFloat64(s+1,e),9;if(e>=0){if(e<128)return t.setUint8(s,e),1;if(e<256)return t.setUint8(s,204),t.setUint8(s+1,e),2;if(e<65536)return t.setUint8(s,205),t.setUint16(s+1,e),3;if(e<4294967296)return t.setUint8(s,206),t.setUint32(s+1,e),5;if(e<0x10000000000000000)return t.setUint8(s,207),function(e,t,s){s<0x10000000000000000?(e.setUint32(t,Math.floor(s*$n)),e.setInt32(t+4,-1&s)):(e.setUint32(t,4294967295),e.setUint32(t+4,4294967295))}(t,s+1,e),9;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return t.setInt8(s,e),1;if(e>=-128)return t.setUint8(s,208),t.setInt8(s+1,e),2;if(e>=-32768)return t.setUint8(s,209),t.setInt16(s+1,e),3;if(e>=-2147483648)return t.setUint8(s,210),t.setInt32(s+1,e),5;if(e>=-0x8000000000000000)return t.setUint8(s,211),function(e,t,s){s<0x8000000000000000?(e.setInt32(t,Math.floor(s*$n)),e.setInt32(t+4,-1&s)):(e.setUint32(t,2147483647),e.setUint32(t+4,2147483647))}(t,s+1,e),9;throw new Error("Number too small -0x"+(-e).toString(16).substr(1))}if("undefined"===i)return n?0:(t.setUint8(s,212),t.setUint8(s+1,0),t.setUint8(s+2,0),3);if(null===e)return n?0:(t.setUint8(s,192),1);if("boolean"===i)return t.setUint8(s,e?195:194),1;if("function"==typeof e.toJSON)return Jn(e.toJSON(),t,s,n);if("object"===i){let i,a,r=0;const o=Array.isArray(e);if(o?i=e.length:(a=zn(e,n),i=a.length),i<16?(t.setUint8(s,i|(o?144:128)),r=1):i<65536?(t.setUint8(s,o?220:222),t.setUint16(s+1,i),r=3):i<4294967296&&(t.setUint8(s,o?221:223),t.setUint32(s+1,i),r=5),o)for(let c=0;c<i;c++)r+=Jn(e[c],t,s+r,n);else if(a)for(let c=0;c<i;c++){const i=a[c];r+=Jn(i,t,s+r),r+=Jn(e[i],t,s+r,n)}return r}if("function"===i)return 0;throw new Error("Unknown type "+i)}function Kn(e,t){const s=typeof e;if("string"===s){const t=jn(e);if(t<32)return 1+t;if(t<256)return 2+t;if(t<65536)return 3+t;if(t<4294967296)return 5+t}if(ArrayBuffer.isView&&ArrayBuffer.isView(e)&&(e=e.buffer),e instanceof ArrayBuffer){const t=e.byteLength;if(t<256)return 2+t;if(t<65536)return 3+t;if(t<4294967296)return 5+t}if("number"==typeof e){if(Math.floor(e)!==e)return 9;if(e>=0){if(e<128)return 1;if(e<256)return 2;if(e<65536)return 3;if(e<4294967296)return 5;if(e<0x10000000000000000)return 9;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return 1;if(e>=-128)return 2;if(e>=-32768)return 3;if(e>=-2147483648)return 5;if(e>=-0x8000000000000000)return 9;throw new Error("Number too small -0x"+e.toString(16).substr(1))}if("boolean"===s)return 1;if(null===e)return t?0:1;if(void 0===e)return t?0:3;if("function"==typeof e.toJSON)return Kn(e.toJSON(),t);if("object"===s){let s,n=0;if(Array.isArray(e)){s=e.length;for(let i=0;i<s;i++)n+=Kn(e[i],t)}else{const i=zn(e,t);s=i.length;for(let a=0;a<s;a++){const s=i[a];n+=Kn(s)+Kn(e[s],t)}}if(s<16)return 1+n;if(s<65536)return 3+n;if(s<4294967296)return 5+n;throw new Error("Array or object too long 0x"+s.toString(16))}if("function"===s)return 0;throw new Error("Unknown type "+s)}var Yn,Qn={encode:function(e,t){const s=Kn(e,t);if(0===s)return;const n=new ArrayBuffer(s);return Jn(e,new DataView(n),0,t),n},decode:function(e){const t=new DataView(e),s=new Wn(t),n=s.parse();if(s.offset!==e.byteLength)throw new Error(e.byteLength-s.offset+" trailing bytes");return n},inspect:function(e){if(void 0===e)return"undefined";let t,s;if(e instanceof ArrayBuffer?(s="ArrayBuffer",t=new DataView(e)):e instanceof DataView&&(s="DataView",t=e),!t)return JSON.stringify(e);const n=[];for(let i=0;i<e.byteLength;i++){if(i>20){n.push("...");break}let e=t.getUint8(i).toString(16);1===e.length&&(e="0"+e),n.push(e)}return"<"+s+" "+n.join(" ")+">"},utf8Write:Gn,utf8Read:Vn,utf8ByteCount:jn},Xn={XHRRequest:xn,FetchRequest:async function(e,t,s,n,i,a){const r=new Headers(n||{}),o=e?e.toUpperCase():P(a)?"GET":"POST",c=new AbortController;let l;const u=new Promise(e=>{l=setTimeout(()=>{c.abort(),e({error:new O("Request timed out",null,408)})},t?t.options.timeouts.httpRequestTimeout:Te.TIMEOUTS.httpRequestTimeout)}),d={method:o,headers:r,body:a,signal:c.signal};m.Config.isWebworker||(d.credentials=r.has("authorization")?"include":"same-origin");const h=(async()=>{try{const e=new URLSearchParams(i||{});e.set("rnd",ee());const t=s+"?"+e,n=await de().fetch(t,d);if(clearTimeout(l),204==n.status)return{error:null,statusCode:n.status};const a=n.headers.get("Content-Type");let r;r=a&&a.indexOf("application/x-msgpack")>-1?await n.arrayBuffer():a&&a.indexOf("application/json")>-1?await n.json():await n.text();const o=!!a&&-1===a.indexOf("application/x-msgpack"),c=function(e){const t={};return e.forEach((e,s)=>{t[s]=e}),t}(n.headers);if(n.ok)return{error:null,body:r,headers:c,unpacked:o,statusCode:n.status};{const e=function(e,t){if(function(e,t){return!!t.get("x-ably-errorcode")}(0,t))return e.error&&C.fromValues(e.error)}(r,n.headers)||new O("Error response received from server: "+n.status+" body was: "+m.Config.inspect(r),null,n.status);return{error:e,body:r,headers:c,unpacked:o,statusCode:n.status}}}catch(e){return clearTimeout(l),{error:e}}})();return Promise.race([u,h])}},Zn=function(e,t){class s{constructor(e,t,s,n){this.algorithm=e,this.keyLength=t,this.mode=s,this.key=n}}class n{static getDefaultParams(e){var n;if(!e.key)throw new Error("Crypto.getDefaultParams: a key is required");n="string"==typeof e.key?t.toArrayBuffer(t.base64Decode(e.key.replace("_","/").replace("-","+"))):e.key instanceof ArrayBuffer?e.key:t.toArrayBuffer(e.key);var i=e.algorithm||"aes",a=8*n.byteLength,r=e.mode||"cbc",o=new s(i,a,r,n);if(e.keyLength&&e.keyLength!==o.keyLength)throw new Error("Crypto.getDefaultParams: a keyLength of "+e.keyLength+" was specified, but the key actually has length "+o.keyLength);return function(e){if("aes"===e.algorithm&&"cbc"===e.mode){if(128===e.keyLength||256===e.keyLength)return;throw new Error("Unsupported key length "+e.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}}(o),o}static async generateRandomKey(t){try{return e.getRandomArrayBuffer((t||256)/8)}catch(s){throw new C("Failed to generate random key: "+s.message,400,5e4,s)}}static getCipher(e,t){var n,a=function(e){return e instanceof s}(e)?e:this.getDefaultParams(e);return{cipherParams:a,cipher:new i(a,null!=(n=e.iv)?n:null,t)}}}n.CipherParams=s;class i{constructor(e,s,n){if(this.logger=n,!crypto.subtle)throw isSecureContext?new Error("Crypto operations are not possible since the browserâs SubtleCrypto class is unavailable (reason unknown)."):new Error("Crypto operations are is not possible since the current environment is a non-secure context and hence the browserâs SubtleCrypto class is not available.");this.algorithm=e.algorithm+"-"+String(e.keyLength)+"-"+e.mode,this.webCryptoAlgorithm=e.algorithm+"-"+e.mode,this.key=t.toArrayBuffer(e.key),this.iv=s?t.toArrayBuffer(s):null}concat(e,s){const n=new ArrayBuffer(e.byteLength+s.byteLength),i=new DataView(n),a=new DataView(t.toArrayBuffer(e));for(let t=0;t<a.byteLength;t++)i.setInt8(t,a.getInt8(t));const r=new DataView(t.toArrayBuffer(s));for(let t=0;t<r.byteLength;t++)i.setInt8(a.byteLength+t,r.getInt8(t));return n}async encrypt(e){k.logAction(this.logger,k.LOG_MICRO,"CBCCipher.encrypt()","");const t=await this.getIv(),s=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["encrypt"]),n=await crypto.subtle.encrypt({name:this.webCryptoAlgorithm,iv:t},s,e);return this.concat(t,n)}async decrypt(e){k.logAction(this.logger,k.LOG_MICRO,"CBCCipher.decrypt()","");const s=t.toArrayBuffer(e),n=s.slice(0,16),i=s.slice(16),a=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["decrypt"]);return crypto.subtle.decrypt({name:this.webCryptoAlgorithm,iv:n},a,i)}async getIv(){if(this.iv){var s=this.iv;return this.iv=null,s}const n=await e.getRandomArrayBuffer(16);return t.toArrayBuffer(n)}}return n}(In,wn);m.Crypto=Zn,m.BufferUtils=wn,m.Http=Cn,m.Config=In,m.Transports=Hn,m.WebStorage=An;for(const s of[Cs,sn])s.Crypto=Zn,s._MsgPack=Qn;Cn.bundledRequestImplementations=Xn,k.initLogHandlers(),m.Defaults=(Yn=qn,Object.assign(we,Yn)),m.Config.agent&&(m.Defaults.agent+=" "+m.Config.agent);var ei={ErrorInfo:C,Rest:Cs,Realtime:sn,msgpack:Qn,makeProtocolMessageFromDeserialized:hs};return"object"==typeof n.exports&&(n.exports=((e,t,s,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let i of Object.getOwnPropertyNames(t))Object.prototype.hasOwnProperty.call(e,i)||i===s||Object.defineProperty(e,i,{get:()=>t[i],enumerable:!(n=Object.getOwnPropertyDescriptor(t,i))||n.enumerable});return e})(n.exports,t)),n.exports},ce.exports=le());let de=null;const he=i(!1),pe=i([]),fe=()=>"undefined"!=typeof window?window.location.hostname:"default",ge=async e=>{z.info("[ABLY] Connexion au service de temps rÃ©el");try{z.debug("[ABLY] Initialisation sans clientId spÃ©cifique");const t={authCallback:async(e,t)=>{z.debug("[ABLY] authCallback appelÃ© pour renouveler le token");try{t(null,await(async()=>{var e;try{const t=await F.routes.client.getRealtimeToken();if(!(null==(e=t.data)?void 0:e.token))throw new Error("Token Ably client non trouvÃ© dans la rÃ©ponse");return z.debug("[ABLY] Nouveau token client obtenu avec succÃ¨s",{client_id:t.data.client_id}),t.data.token}catch(t){throw z.error("[ABLY] Erreur lors de la rÃ©cupÃ©ration du token client",{error:t}),t}})())}catch(s){z.error("[ABLY] Erreur dans authCallback",{error:s});t({code:40170,statusCode:401,message:s instanceof Error?s.message:"Erreur de rÃ©cupÃ©ration du token",name:"TokenError"},null)}},token:e,echoMessages:!1,closeOnUnload:!1,recover:""};de=new ue.Realtime(t),de.connection.on("connected",()=>{z.info("[ABLY] ConnectÃ© au service de temps rÃ©el"),he.value=!0}),de.connection.on("disconnected",()=>{z.info("[ABLY] DÃ©connectÃ© du service de temps rÃ©el"),he.value=!1}),de.connection.on("failed",e=>{z.error("[ABLY] Ãchec de connexion",{reason:e.reason})}),de.connection.on("suspended",()=>{}),setTimeout(()=>{he.value||(z.debug("[ABLY] Tentative de connexion forcÃ©e aprÃ¨s dÃ©lai d'initialisation"),null==de||de.connect())},1e3)}catch(t){throw z.error("[ABLY] Erreur de connexion",{error:t}),t}},ve=(e,t,s)=>{if(!de)return z.error("[ABLY] Client non initialisÃ©"),()=>{};try{de.channels.get(e).subscribe(t,n=>{z.debug(`[ABLY] Message reÃ§u sur ${e}:${t}`,{message:n}),s(n.data)});return-1===pe.value.findIndex(s=>s.channel===e&&s.event===t)?(pe.value.push({channel:e,event:t,callback:s}),z.debug(`[ABLY] Abonnement ajoutÃ©: ${e}:${t}`)):z.debug(`[ABLY] Abonnement dÃ©jÃ  existant: ${e}:${t}`),()=>me(e,t)}catch(n){return z.error("[ABLY] Erreur lors de l'abonnement au canal",{channel:e,error:n}),()=>{}}},me=(e,t)=>{if(de)try{const s=de.channels.get(e);t?(s.unsubscribe(t),pe.value=pe.value.filter(s=>!(s.channel===e&&s.event===t))):(s.unsubscribe(),pe.value=pe.value.filter(t=>t.channel!==e)),ye()}catch(s){z.error("[ABLY] Erreur lors du dÃ©sabonnement du canal",{channel:e,error:s})}else z.error("[ABLY] Client non initialisÃ©")},ye=()=>{var e;const t=(()=>{if(!de)return z.error("[ABLY] Client non initialisÃ©"),[];const e=new Map;return pe.value.forEach(t=>{var s,n;e.has(t.channel)||e.set(t.channel,[]),(null==(s=e.get(t.channel))?void 0:s.includes(t.event))||null==(n=e.get(t.channel))||n.push(t.event)}),Array.from(e.entries()).map(([e,t])=>{let s="unknown";try{de&&de.channels&&(s=de.channels.get(e).state||"attached")}catch(n){}return{name:e,state:s,events:t}}).sort((e,t)=>e.name.localeCompare(t.name))})();return z.debug(`[ABLY] Nombre total d'abonnements enregistrÃ©s: ${pe.value.length}`),0===t.length?pe.value.length>0&&z.debug("[ABLY] Abonnements enregistrÃ©s mais aucun canal trouvÃ©:",pe.value.map(e=>`${e.channel}:${e.event}`)):t.forEach(e=>{e.name.includes("private-admin");e.events.length>0&&z.debug("ÃvÃ©nements:",{events:e.events.join(", ")})}),"undefined"!=typeof window&&(null==(e=window.AblyDebug)?void 0:e.isAutoDisplayActive)&&window.AblyDebug.isAutoDisplayActive(),t},be=(e,t,s)=>{const n=`${fe()}:private-client-${e}`;z.info(`[ABLY] ð ABONNEMENT CANAL PRIVÃ CLIENT: ${n}, Ã©vÃ©nement: ${t}`);return ve(n,t,e=>{z.info(`[ABLY] ð¯ MESSAGE REÃU sur ${n}:${t}`,{message:e,timestamp:(new Date).toISOString(),channelName:n,event:t}),s(e)})},we=(e,t,s)=>{const n=fe();return ve(`${n}:ticket-${e}`,t,s)},_e=n("realtime",()=>{const e=i(!1),t=i(!1),s=i(null),n=i(0),r=i(5),o=i(null),c=i(null),l=i(null),u=i(new Map),d=i(null),h=i([]),p=i(0),f=a(()=>null!==s.value),g=a(()=>n.value<r.value),v=a(()=>e.value&&t.value&&!f.value),m=a(()=>p.value>0),y=a(()=>!!d.value),b=async()=>{var i;try{z.info("[REALTIME STORE CLIENT] Initialisation du service temps rÃ©el");if(!re().isAuthenticated)throw new Error("Utilisateur non authentifiÃ©");z.debug("[REALTIME STORE CLIENT] RÃ©cupÃ©ration du token Ably");const a=null==(i=(await F.routes.realtime.getToken()).data)?void 0:i.token;if(!a)throw new Error("Token Ably non trouvÃ© dans la rÃ©ponse");z.debug("[REALTIME STORE CLIENT] Initialisation d'Ably avec le token"),await ge(a),w(),e.value=!0,t.value=!0,n.value=0,s.value=null,z.info("[REALTIME STORE CLIENT] Service de temps rÃ©el initialisÃ© avec succÃ¨s")}catch(a){z.error("[REALTIME STORE CLIENT] Erreur lors de l'initialisation",{error:a}),s.value=a,e.value=!1,t.value=!1}},w=()=>{const e=de;e&&(e.connection.on("connected",()=>{z.info("[REALTIME STORE CLIENT] Connexion Ã©tablie"),t.value=!0,s.value=null,n.value=0}),e.connection.on("disconnected",()=>{z.warn("[REALTIME STORE CLIENT] Connexion perdue"),t.value=!1}),e.connection.on("failed",e=>{var n;z.error("[REALTIME STORE CLIENT] Ãchec de connexion",{reason:e.reason}),t.value=!1,s.value=new Error((null==(n=e.reason)?void 0:n.message)||"Connexion Ã©chouÃ©e")}),e.connection.on("suspended",()=>{z.warn("[REALTIME STORE CLIENT] Connexion suspendue"),t.value=!1}))},_=e=>{if(z.info("[REALTIME STORE CLIENT] Nouvelle rÃ©ponse reÃ§ue",{data:e}),R(e.timestamp))return void z.debug("[REALTIME STORE CLIENT] ÃvÃ©nement dupliquÃ© ignorÃ©",{timestamp:e.timestamp});const t={action:"reply",ticket:e.ticket,timestamp:e.timestamp,author:e.author,data:e.reply};o.value=t,c.value=e.timestamp},k=e=>{if(z.info("[REALTIME STORE CLIENT] Changement de statut reÃ§u",{data:e}),R(e.timestamp))return void z.debug("[REALTIME STORE CLIENT] ÃvÃ©nement dupliquÃ© ignorÃ©",{timestamp:e.timestamp});const t={action:"status_change",ticket:e.ticket,timestamp:e.timestamp,author:e.author,data:{oldStatus:e.oldStatus,newStatus:e.newStatus}};o.value=t,c.value=e.timestamp},S=e=>{if(z.info("[REALTIME STORE CLIENT] Mise Ã  jour ticket reÃ§ue",{data:e}),R(e.timestamp))return void z.debug("[REALTIME STORE CLIENT] ÃvÃ©nement dupliquÃ© ignorÃ©",{timestamp:e.timestamp});const t={action:"update",ticket:e.ticket,timestamp:e.timestamp,author:e.author,data:e.changes};o.value=t,c.value=e.timestamp},R=e=>c.value===e,C=e=>{z.info("[REALTIME STORE] Nouvelle notification",{notification:e}),h.value.unshift(e),e.read||p.value++,h.value.length>50&&(h.value=h.value.slice(0,50))};return{initialized:e,connected:t,error:s,reconnectAttempts:n,maxReconnectAttempts:r,lastRealtimeEvent:o,lastEventTimestamp:c,lastDashboardEvent:l,dashboardEventHandlers:u,dashboardChannel:d,notifications:h,unreadNotificationsCount:p,hasError:f,canReconnect:g,isReady:v,hasUnreadNotifications:m,isDashboardConnected:y,init:b,disconnect:()=>{z.info("[REALTIME STORE CLIENT] DÃ©connexion du service temps rÃ©el"),z.info("[ABLY] DÃ©connexion du service de temps rÃ©el"),de&&(de.close(),de=null,he.value=!1),e.value=!1,t.value=!1,s.value=null,o.value=null,c.value=null},retry:async()=>{if(g.value){n.value++,z.info("[REALTIME STORE CLIENT] Tentative de reconnexion",{attempt:n.value});try{await b()}catch(e){z.error("[REALTIME STORE CLIENT] Ãchec de la reconnexion",{error:e})}}else z.warn("[REALTIME STORE CLIENT] Nombre maximum de tentatives de reconnexion atteint")},subscribeToTicket:e=>{if(!v.value)return z.warn("[REALTIME STORE CLIENT] Service non prÃªt pour abonnement ticket",{ticketId:e}),()=>{};z.info("[REALTIME STORE CLIENT] Abonnement aux Ã©vÃ©nements du ticket",{ticketId:e});const t=we(e,"ticket-reply",e=>{_(e)}),s=we(e,"ticket-status-change",e=>{k(e)}),n=we(e,"ticket-update",e=>{S(e)});return()=>{z.info("[REALTIME STORE CLIENT] DÃ©sabonnement des Ã©vÃ©nements du ticket",{ticketId:e}),t(),s(),n()}},subscribeToDashboardEvents:async e=>{try{if(!v.value)throw new Error("Service temps rÃ©el non initialisÃ©");if(d.value)return void z.warn("[REALTIME STORE] Abonnement dashboard dÃ©jÃ  actif",{clientId:e});z.info("[REALTIME STORE] Abonnement aux Ã©vÃ©nements dashboard sur canal privÃ© client",{clientId:e});const t=be(e,"dashboard-update",t=>{z.info("[REALTIME STORE] ÃvÃ©nement dashboard-update reÃ§u",{event:t,clientId:e});const s=t;l.value=s;const n=u.value.get(s.entity_type);n&&n(s),"notification"===s.action&&s.data.notification&&C(s.data.notification)});z.info("[REALTIME STORE] Abonnement Ã  service-update sur canal private-client-"+e);const s=be(e,"service-update",t=>{var s,n,i,a;z.info("[REALTIME STORE] ð¯ ÃVÃNEMENT SERVICE-UPDATE REÃU !",{data:t,clientId:e,timestamp:(new Date).toISOString()});const r={entity_type:"service",action:t.action||t.type,data:{service:(null==(s=t.data)?void 0:s.service)||t.service||t},timestamp:t.timestamp||(new Date).toISOString()};z.info("[REALTIME STORE] ÃvÃ©nement service normalisÃ©",{normalizedEvent:r});const o=u.value.get("service");o&&o(r);const c=u.value.get("service-page");c&&c(r);const l=(null==(i=null==(n=t.data)?void 0:n.service)?void 0:i.id)||(null==(a=t.service)?void 0:a.id);if(l){const e=`service-detail-${l}`,t=u.value.get(e);t?(z.info("[REALTIME STORE] ð¤ ENVOI VERS SERVICE DETAIL HANDLER:",{handler_key:e,handler_exists:!0,data_sent:r,service_id:l}),t(r)):z.info("[REALTIME STORE] â¹ï¸ SERVICE DETAIL HANDLER NON TROUVÃ (normal si pas sur page dÃ©tail):",{handler_key:e,service_id:l})}});z.info("[REALTIME STORE] Abonnement Ã  invoice-update sur canal private-client-"+e);const n=be(e,"invoice-update",t=>{var s,n,i,a,r,o,c;z.info("[REALTIME STORE] ð¯ ÃVÃNEMENT INVOICE-UPDATE REÃU !",{data:t,clientId:e,timestamp:(new Date).toISOString()}),z.info("[REALTIME STORE] ð ANALYSE STRUCTURE DONNÃES INVOICE:",{data_keys:Object.keys(t),"data.action":t.action,"data.entity_type":t.entity_type,"data.data_exists":!!t.data,"data.data_keys":t.data?Object.keys(t.data):null,"data.invoice_exists":!!t.invoice,"data.data.invoice_exists":t.data?!!t.data.invoice:null,structure_complete:JSON.stringify(t,null,2)});const l=u.value.get("invoice");l?(z.info("[REALTIME STORE] ð¤ ENVOI VERS DASHBOARD HANDLER:",{handler_exists:!0,data_sent:t}),l(t)):z.warn("[REALTIME STORE] â DASHBOARD HANDLER INTROUVABLE pour invoice");const d=u.value.get("invoice-page");d?(z.info("[REALTIME STORE] ð¤ ENVOI VERS PAGE HANDLER:",{handler_exists:!0,data_sent:t}),d(t)):z.warn("[REALTIME STORE] â PAGE HANDLER INTROUVABLE pour invoice-page");const h=(null==(n=null==(s=t.data)?void 0:s.invoice)?void 0:n.id)||(null==(i=t.invoice)?void 0:i.id);if(h){const e=`invoice-detail-${h}`,s=u.value.get(e);if(s){const n={entity_type:"invoice",action:t.action||t.type,data:{invoice:(null==(a=t.data)?void 0:a.invoice)||t.invoice||t},timestamp:t.timestamp||(new Date).toISOString()};z.info("[REALTIME STORE] ð¤ ENVOI VERS DETAIL HANDLER:",{handler_key:e,handler_exists:!0,data_sent:n,invoice_id:h}),s(n)}else z.info("[REALTIME STORE] â¹ï¸ DETAIL HANDLER NON TROUVÃ (normal si pas sur page dÃ©tail):",{handler_key:e,invoice_id:h})}const p=(null==(o=null==(r=t.data)?void 0:r.invoice)?void 0:o.id)||(null==(c=t.invoice)?void 0:c.id);if(p){const e=`invoice-detail-${p}`,s=u.value.get(e);s?(z.info("[REALTIME STORE] ð¤ ENVOI VERS DETAIL HANDLER:",{handler_key:e,handler_exists:!0,data_sent:t,invoice_id:p}),s(t)):z.info("[REALTIME STORE] â¹ï¸ DETAIL HANDLER NON TROUVÃ (normal si pas sur page dÃ©tail):",{handler_key:e,invoice_id:p})}}),i=be(e,"ticket-update",t=>{z.info("[REALTIME STORE] ÃvÃ©nement ticket-update reÃ§u",{data:t,clientId:e});const s=u.value.get("ticket");s&&s(t);const n=u.value.get("ticket-page");n?(z.info("[REALTIME STORE] ð¤ ENVOI VERS TICKET PAGE HANDLER:",{handler_exists:!0,data_sent:t}),n(t)):z.info("[REALTIME STORE] â¹ï¸ TICKET PAGE HANDLER NON TROUVÃ (normal si pas sur page support)")}),a=be(e,"stats-update",t=>{z.info("[REALTIME STORE] ÃvÃ©nement stats-update reÃ§u",{data:t,clientId:e});const s=u.value.get("stats");s&&s(t)});d.value={unsubscribe:()=>{t(),s(),n(),i(),a()}},z.info("[REALTIME STORE] Abonnement dashboard Ã©tabli avec succÃ¨s sur canal privÃ© client",{clientId:e})}catch(t){throw z.error("[REALTIME STORE] Erreur lors de l'abonnement dashboard",{error:t.message,clientId:e}),t}},unsubscribeFromDashboardEvents:()=>{d.value&&(z.info("[REALTIME STORE] DÃ©sabonnement des Ã©vÃ©nements dashboard"),d.value.unsubscribe(),d.value=null,u.value.clear())},registerDashboardHandler:(e,t)=>{u.value.set(e,t)},unregisterDashboardHandler:e=>{u.value.delete(e)},addNotification:C,markNotificationAsRead:e=>{const t=h.value.find(t=>t.id===e);t&&!t.read&&(t.read=!0,p.value=Math.max(0,p.value-1))},markAllNotificationsAsRead:()=>{h.value.forEach(e=>{e.read=!0}),p.value=0,z.info("[REALTIME STORE] Toutes les notifications marquÃ©es comme lues")},clearNotifications:()=>{h.value=[],p.value=0,z.info("[REALTIME STORE] Notifications effacÃ©es")}}}),ke={class:"notification-center"},Se={key:0,class:"notification-dropdown"},Re={class:"notification-header"},Ce={class:"notification-actions"},Oe=["title"],Ee=["title"],Ae={class:"notification-list"},Te={key:0,class:"no-notifications"},Ie=["onClick"],Me={class:"notification-icon"},Pe={class:"notification-content"},Le={class:"notification-title"},Ne={class:"notification-message"},De={class:"notification-time"},Ue={class:"notification-actions-item"},xe=["onClick","title"],Be=["onClick","title"],He={key:0,class:"notification-footer"},qe=(e,t)=>{const s=e.__vccOpts||e;for(const[n,i]of t)s[n]=i;return s},Ge=qe(r({__name:"NotificationCenter",props:{notifications:{default:()=>[]},maxVisible:{default:10}},emits:["notificationClick","markAsRead","markAllAsRead","clearAll","remove"],setup(e,{emit:t}){const s=e,n=t,r=o(),S=_e(),R=i(!1),C=i(!1),O=a(()=>s.notifications.slice(0,s.maxVisible)),E=a(()=>s.notifications.filter(e=>!e.read).length),A=()=>{R.value=!R.value,R.value&&(C.value=!1)},T=()=>{R.value=!1},I=e=>{S.markNotificationAsRead(e),n("markAsRead",e)},M=()=>{z.info("[NOTIFICATION CENTER] Marquer toutes comme lues"),S.markAllNotificationsAsRead(),n("markAllAsRead")},P=()=>{z.info("[NOTIFICATION CENTER] Effacer toutes les notifications"),S.clearNotifications(),n("clearAll")},L=()=>{z.info("[NOTIFICATION CENTER] Voir toutes les notifications"),r.push("/notifications"),T()},N=e=>{const t=new Date(e),s=(new Date).getTime()-t.getTime(),n=Math.floor(s/6e4),i=Math.floor(n/60),a=Math.floor(i/24);return n<1?"Ã l'instant":n<60?`Il y a ${n}min`:i<24?`Il y a ${i}h`:a<7?`Il y a ${a}j`:new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}).format(t)};c(()=>s.notifications.length,(e,t)=>{e>t&&!R.value&&(C.value=!0,setTimeout(()=>{C.value=!1},3e3))});const D=e=>{e.target.closest(".notification-center")||T()};return l(()=>{document.addEventListener("click",D)}),u(()=>{document.removeEventListener("click",D)}),(e,t)=>(h(),d("div",ke,[p("div",{class:v(["notification-trigger",{active:R.value}]),onClick:A},[t[0]||(t[0]=p("i",{class:"fas fa-bell"},null,-1)),E.value>0?(h(),d("span",{key:0,class:v(["notification-badge",{pulse:C.value}])},m(E.value>99?"99+":E.value),3)):g("",!0)],2),f(y,{name:"notification-dropdown"},{default:b(()=>[R.value?(h(),d("div",Se,[p("div",Re,[p("h4",null,m(e.$t("notifications.title")),1),p("div",Ce,[E.value>0?(h(),d("button",{key:0,onClick:M,class:"btn-mark-all-read",title:e.$t("notifications.mark_all_read")},t[1]||(t[1]=[p("i",{class:"fas fa-check-double"},null,-1)]),8,Oe)):g("",!0),p("button",{onClick:P,class:"btn-clear-all",title:e.$t("notifications.clear_all")},t[2]||(t[2]=[p("i",{class:"fas fa-trash"},null,-1)]),8,Ee)])]),p("div",Ae,[0===O.value.length?(h(),d("div",Te,[t[3]||(t[3]=p("i",{class:"fas fa-bell-slash"},null,-1)),p("p",null,m(e.$t("notifications.no_notifications")),1)])):g("",!0),(h(!0),d(w,null,_(O.value,s=>{return h(),d("div",{key:s.id,class:v(["notification-item",{unread:!s.read,clickable:!!s.action_url}]),onClick:e=>(e=>{z.info("[NOTIFICATION CENTER] Clic sur notification",{notification:e}),e.read||I(e.id),e.action_url&&(r.push(e.action_url),T()),n("notificationClick",e)})(s)},[p("div",Me,[p("i",{class:v((i=s.type,{service:"fas fa-server text-blue",invoice:"fas fa-file-invoice text-orange",ticket:"fas fa-headset text-green",system:"fas fa-cog text-gray"}[i]||"fas fa-info-circle text-blue"))},null,2)]),p("div",Pe,[p("div",Le,m(s.title),1),p("div",Ne,m(s.message),1),p("div",De,m(N(s.created_at)),1)]),p("div",Ue,[s.read?g("",!0):(h(),d("button",{key:0,onClick:k(e=>I(s.id),["stop"]),class:"btn-mark-read",title:e.$t("notifications.mark_read")},t[4]||(t[4]=[p("i",{class:"fas fa-check"},null,-1)]),8,xe)),p("button",{onClick:k(e=>{return t=s.id,void n("remove",t);var t},["stop"]),class:"btn-remove",title:e.$t("notifications.remove")},t[5]||(t[5]=[p("i",{class:"fas fa-times"},null,-1)]),8,Be)])],10,Ie);var i}),128))]),O.value.length>0?(h(),d("div",He,[p("button",{onClick:L,class:"btn-view-all"},m(e.$t("notifications.view_all")),1)])):g("",!0)])):g("",!0)]),_:1}),R.value?(h(),d("div",{key:0,class:"notification-overlay",onClick:T})):g("",!0)]))}}),[["__scopeId","data-v-8937cb6a"]]),Ve={class:"client-header"},je={class:"header-left"},Fe={class:"page-title"},$e={class:"header-right"},We={class:"search-bar"},ze={class:"current-lang"},Je={class:"menu-items"},Ke={key:0,class:"fas fa-check"},Ye={key:0,class:"fas fa-check"},Qe={class:"user-name"},Xe={key:0,class:"user-info"},Ze={class:"user-details"},et={class:"name"},tt={class:"email"},st={key:1,class:"user-info"},nt={key:2,class:"user-info"},it={class:"menu-items"},at=qe(r({__name:"AppHeader",setup(e){const t=S(),s=o(),{locale:n}=R(),r=re(),c=_e(),y=i(""),w=i(n.value||"fr"),_=i(!1),I=i(!1),M=i(),P=i(),L=a(()=>c.notifications),N=a(()=>({dashboard:"Tableau de bord",services:"Mes Services",invoices:"Factures",tickets:"Support",account:"Mon Compte"}[t.name]||"TechCMS Client")),D=()=>{},U=()=>{_.value=!_.value,I.value=!1},x=e=>{w.value=e,n.value=e,_.value=!1,localStorage.setItem("preferred-language",e)},B=()=>{I.value=!I.value,_.value=!1},H=e=>{z.info("[HEADER] Clic sur notification",{notification:e}),e.action_url&&s.push(e.action_url)},q=e=>{c.markNotificationAsRead(e)},G=()=>{z.info("[HEADER] Marquer toutes les notifications comme lues"),c.markAllNotificationsAsRead()},V=()=>{z.info("[HEADER] Effacer toutes les notifications"),c.clearNotifications()},j=async()=>{try{await r.logout(),s.push("/client/login")}catch(e){}},F=e=>{M.value&&!M.value.contains(e.target)&&(_.value=!1),P.value&&!P.value.contains(e.target)&&(I.value=!1)};return l(async()=>{document.addEventListener("click",F);const e=localStorage.getItem("preferred-language");!e||"fr"!==e&&"en"!==e||(w.value=e,n.value=e),r.initialized||await r.initialize()}),u(()=>{document.removeEventListener("click",F)}),(e,t)=>{var s;const n=C("router-link");return h(),d("div",Ve,[p("div",je,[p("h1",Fe,m(N.value),1)]),p("div",$e,[p("div",We,[t[3]||(t[3]=p("i",{class:"fas fa-search"},null,-1)),O(p("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>y.value=e),type:"text",placeholder:"Rechercher...",onInput:D},null,544),[[E,y.value]])]),p("div",{ref_key:"languageDropdown",ref:M,class:"dropdown"},[p("button",{class:"btn-icon dropdown-toggle",onClick:U},[p("span",ze,m(w.value.toUpperCase()),1)]),p("div",{class:v(["dropdown-menu",{show:_.value}])},[t[8]||(t[8]=p("div",{class:"menu-header"},[p("h3",null,"Langue")],-1)),p("div",Je,[p("a",{href:"#",class:v(["menu-item",{active:"fr"===w.value}]),onClick:t[1]||(t[1]=k(e=>x("fr"),["prevent"]))},[t[4]||(t[4]=p("span",{class:"flag"},"ð«ð·",-1)),t[5]||(t[5]=p("span",{class:"label"},"FranÃ§ais",-1)),"fr"===w.value?(h(),d("i",Ke)):g("",!0)],2),p("a",{href:"#",class:v(["menu-item",{active:"en"===w.value}]),onClick:t[2]||(t[2]=k(e=>x("en"),["prevent"]))},[t[6]||(t[6]=p("span",{class:"flag"},"ð¬ð§",-1)),t[7]||(t[7]=p("span",{class:"label"},"English",-1)),"en"===w.value?(h(),d("i",Ye)):g("",!0)],2)])],2)],512),f(Ge,{notifications:L.value,onNotificationClick:H,onMarkAsRead:q,onMarkAllAsRead:G,onClearAll:V},null,8,["notifications"]),p("div",{ref_key:"userDropdown",ref:P,class:"user-menu"},[p("button",{class:"user-btn",onClick:B},[t[9]||(t[9]=p("div",{class:"user-avatar"},[p("i",{class:"fas fa-user-circle"})],-1)),p("span",Qe,m(A(r).isAuthenticated?A(r).userFullName:A(r).loading?"Chargement...":"Non connectÃ©"),1),t[10]||(t[10]=p("i",{class:"fas fa-chevron-down"},null,-1))]),p("div",{class:v(["user-dropdown",{show:I.value}])},[A(r).isAuthenticated?(h(),d("div",Xe,[t[11]||(t[11]=p("div",{class:"user-avatar-large"},[p("i",{class:"fas fa-user-circle"})],-1)),p("div",Ze,[p("div",et,m(A(r).userFullName),1),p("div",tt,m(null==(s=A(r).user)?void 0:s.email),1)])])):A(r).loading?(h(),d("div",st,t[12]||(t[12]=[T('<div class="user-avatar-large" data-v-3abcfcae><i class="fas fa-user-circle" data-v-3abcfcae></i></div><div class="user-details" data-v-3abcfcae><div class="name" data-v-3abcfcae>Chargement...</div><div class="email" data-v-3abcfcae>---</div></div>',2)]))):(h(),d("div",nt,t[13]||(t[13]=[T('<div class="user-avatar-large" data-v-3abcfcae><i class="fas fa-user-circle" data-v-3abcfcae></i></div><div class="user-details" data-v-3abcfcae><div class="name" data-v-3abcfcae>Non connectÃ©</div><div class="email" data-v-3abcfcae>---</div></div>',2)]))),t[17]||(t[17]=p("div",{class:"menu-divider"},null,-1)),p("div",it,[f(n,{to:"/account",class:"menu-item"},{default:b(()=>t[14]||(t[14]=[p("i",{class:"fas fa-user-cog"},null,-1),p("span",null,"Mon Compte",-1)])),_:1,__:[14]}),f(n,{to:"/settings",class:"menu-item"},{default:b(()=>t[15]||(t[15]=[p("i",{class:"fas fa-cog"},null,-1),p("span",null,"ParamÃ¨tres",-1)])),_:1,__:[15]}),p("a",{href:"#",class:v(["menu-item",{disabled:A(r).loading}]),onClick:k(j,["prevent"])},t[16]||(t[16]=[p("i",{class:"fas fa-sign-out-alt"},null,-1),p("span",null,"DÃ©connexion",-1)]),2)])],2)],512)])])}}}),[["__scopeId","data-v-3abcfcae"]]),rt={class:"sidebar-header"},ot={key:0,class:"logo-text"},ct={class:"sidebar-nav"},lt={key:0},ut={key:0},dt={key:0},ht={key:0},pt={key:0},ft={key:0,class:"sidebar-footer"},gt={class:"user-info"},vt={key:0,class:"user-details"},mt={class:"user-name"},yt={class:"user-email"},bt={key:1,class:"user-details"},wt={class:"user-name"},_t={key:2,class:"user-details"},kt={class:"user-name"},St=["disabled"],Rt=qe(r({__name:"AppSidebar",props:{collapsed:{type:Boolean}},emits:["sidebar-toggle"],setup(e,{emit:t}){const s=t,n=re(),i=o(),a=()=>{s("sidebar-toggle")},r=async()=>{try{await n.logout(),i.push("/client/login")}catch(e){}};return l(async()=>{n.initialized||await n.initialize()}),(e,t)=>{var s;const i=C("router-link");return h(),d("aside",{class:v(["client-sidebar",{"sidebar-collapsed":e.collapsed}])},[p("div",rt,[f(i,{to:"/dashboard",class:"logo"},{default:b(()=>[t[0]||(t[0]=p("img",{src:"data:image/png;base64,Cg==",alt:"TechCMS",class:"logo-img"},null,-1)),e.collapsed?g("",!0):(h(),d("span",ot,"TechCMS"))]),_:1,__:[0]}),p("button",{class:"sidebar-toggle",onClick:a},t[1]||(t[1]=[p("i",{class:"fas fa-bars"},null,-1)]))]),p("nav",ct,[p("ul",null,[p("li",{class:v({active:"dashboard"===e.$route.name})},[f(i,{to:"/dashboard",class:"nav-link"},{default:b(()=>[t[2]||(t[2]=p("i",{class:"fas fa-home"},null,-1)),e.collapsed?g("",!0):(h(),d("span",lt,m(e.$t("dashboard.title")),1))]),_:1,__:[2]})],2),p("li",{class:v({active:"services"===e.$route.name})},[f(i,{to:"/services",class:"nav-link"},{default:b(()=>[t[3]||(t[3]=p("i",{class:"fas fa-server"},null,-1)),e.collapsed?g("",!0):(h(),d("span",ut,m(e.$t("services.title")),1))]),_:1,__:[3]})],2),p("li",{class:v({active:"billing"===e.$route.name})},[f(i,{to:"/billing",class:"nav-link"},{default:b(()=>[t[4]||(t[4]=p("i",{class:"fas fa-file-invoice"},null,-1)),e.collapsed?g("",!0):(h(),d("span",dt,m(e.$t("billing.title")),1))]),_:1,__:[4]})],2),p("li",{class:v({active:"support"===e.$route.name})},[f(i,{to:"/support",class:"nav-link"},{default:b(()=>[t[5]||(t[5]=p("i",{class:"fas fa-headset"},null,-1)),e.collapsed?g("",!0):(h(),d("span",ht,m(e.$t("support.title")),1))]),_:1,__:[5]})],2),p("li",{class:v({active:"account"===e.$route.name})},[f(i,{to:"/account",class:"nav-link"},{default:b(()=>[t[6]||(t[6]=p("i",{class:"fas fa-user-cog"},null,-1)),e.collapsed?g("",!0):(h(),d("span",pt,m(e.$t("account.title")),1))]),_:1,__:[6]})],2)])]),e.collapsed?g("",!0):(h(),d("div",ft,[p("div",gt,[t[9]||(t[9]=p("div",{class:"user-avatar"},[p("i",{class:"fas fa-user-circle"})],-1)),A(n).isAuthenticated?(h(),d("div",vt,[p("div",mt,m(A(n).userFullName),1),p("div",yt,m(null==(s=A(n).user)?void 0:s.email),1)])):A(n).loading?(h(),d("div",bt,[p("div",wt,m(e.$t("common.loading")),1),t[7]||(t[7]=p("div",{class:"user-email"},"---",-1))])):(h(),d("div",_t,[p("div",kt,m(e.$t("auth.not_connected")),1),t[8]||(t[8]=p("div",{class:"user-email"},"---",-1))]))]),p("button",{class:"logout-btn",onClick:r,disabled:A(n).loading},[t[10]||(t[10]=p("i",{class:"fas fa-sign-out-alt"},null,-1)),p("span",null,m(e.$t("auth.logout")),1)],8,St)]))],2)}}}),[["__scopeId","data-v-67a4dd46"]]),Ct={class:"client-app-layout"},Ot={class:"app-container"},Et=qe(r({__name:"AppLayout",setup(e){const t=i(!1),s=()=>{t.value=!t.value};return(e,n)=>(h(),d("div",Ct,[p("header",null,[f(at)]),p("div",Ot,[f(Rt,{collapsed:t.value,onSidebarToggle:s},null,8,["collapsed"]),p("main",{class:v(["app-content",{"sidebar-collapsed":t.value}])},[I(e.$slots,"default",{},void 0)],2)])]))}}),[["__scopeId","data-v-aa1a35f8"]]),At={id:"app",class:"tech-cms-client-app"},Tt={key:0,class:"auth-container"},It={key:0,class:"realtime-error-banner"},Mt=qe(r({__name:"App",setup(e){const t=re(),s=_e(),n=a(()=>s.hasError&&t.isAuthenticated);l(async()=>{z.info("TechCMS Client - Initialisation..."),await t.initialize(),t.isAuthenticated&&(z.info("TechCMS Client - Initialisation du temps rÃ©el..."),i())}),c(()=>t.isAuthenticated,e=>{e?(z.info("TechCMS Client - Utilisateur authentifiÃ©, initialisation du temps rÃ©el..."),i()):(z.info("TechCMS Client - Utilisateur dÃ©connectÃ©, dÃ©connexion du temps rÃ©el..."),s.disconnect())});const i=async()=>{try{await s.init()}catch(e){z.error("TechCMS Client - Erreur d'initialisation du temps rÃ©el:",{error:e})}},r=async()=>{z.info("TechCMS Client - Tentative de reconnexion au service temps rÃ©el..."),await s.retry()};return(e,t)=>{const s=C("router-view");return h(),d("div",At,[f(s,null,{default:b(({Component:e,route:t})=>[f(y,{name:"fade",mode:"out-in"},{default:b(()=>[t.meta.hideLayout?(h(),d("div",Tt,[(h(),M(P(e)))])):(h(),M(Et,{key:1},{default:b(()=>[(h(),M(P(e)))]),_:2},1024))]),_:2},1024)]),_:1}),n.value?(h(),d("div",It,[p("div",{class:"realtime-error-content"},[t[0]||(t[0]=p("span",null,"Connexion temps rÃ©el interrompue",-1)),p("button",{class:"retry-button",onClick:r}," RÃ©essayer ")])])):g("",!0)])}}}),[["__scopeId","data-v-11c855ca"]]),Pt={},Lt=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),i=(null==s?void 0:s.nonce)||(null==s?void 0:s.getAttribute("nonce"));n=e(t.map(e=>{if((e=function(e){return"/client/dist/"+e}(e))in Pt)return;Pt[e]=!0;const t=e.endsWith(".css"),s=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${s}`))return;const n=document.createElement("link");return n.rel=t?"stylesheet":"modulepreload",t||(n.as="script"),n.crossOrigin="",n.href=e,i&&n.setAttribute("nonce",i),document.head.appendChild(n),t?new Promise((t,s)=>{n.addEventListener("load",t),n.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function i(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then(t=>{for(const e of t||[])"rejected"===e.status&&i(e.reason);return e().catch(i)})};class Nt{static async getStats(){var e,t;try{return(await F.routes.client.dashboard.getStats()).data}catch(s){throw new Error((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la rÃ©cupÃ©ration des statistiques")}}static async getOverview(){var e,t;try{return(await F.routes.client.dashboard.getOverview()).data}catch(s){throw new Error((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la rÃ©cupÃ©ration de la vue d'ensemble")}}static async getRecentServices(){var e,t;try{return(await F.routes.client.service.getRecent()).data}catch(s){throw new Error((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la rÃ©cupÃ©ration des services rÃ©cents")}}static async getRecentInvoices(){var e,t;try{return(await F.routes.client.invoice.getRecent()).data}catch(s){throw new Error((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la rÃ©cupÃ©ration des factures rÃ©centes")}}static async getUnpaidInvoices(){var e,t;try{return(await F.routes.client.invoice.getUnpaid()).data}catch(s){throw new Error((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la rÃ©cupÃ©ration des factures impayÃ©es")}}static async getRecentTickets(){var e,t;try{return(await F.routes.client.ticket.getRecent()).data}catch(s){throw new Error((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la rÃ©cupÃ©ration des tickets rÃ©cents")}}static async getOpenTickets(){var e,t;try{return(await F.routes.client.ticket.getOpen()).data}catch(s){throw new Error((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la rÃ©cupÃ©ration des tickets ouverts")}}}const Dt=n("clientDashboard",()=>{const e=i(!1),t=i(null),s=i(null),n=i(null),r=i([]),o=i([]),c=i([]),l=i([]),u=i([]),d=i(!1),h=i(null),p=i(!1),f=a(()=>!!s.value),g=a(()=>{var e;return(null==(e=s.value)?void 0:e.services.total)||0}),v=a(()=>{var e;return(null==(e=s.value)?void 0:e.services.active)||0}),m=a(()=>{var e;return(null==(e=s.value)?void 0:e.invoices.total_due)||0}),y=a(()=>{var e,t;return((null==(e=s.value)?void 0:e.tickets.open)||0)+((null==(t=s.value)?void 0:t.tickets.in_progress)||0)}),b=async()=>{var e;try{const t=re(),s=_e();if(!t.isAuthenticated||!(null==(e=t.user)?void 0:e.id))return void z.warn("[DASHBOARD STORE] Utilisateur non authentifiÃ©, impossible d'initialiser le temps rÃ©el");if(d.value)return void z.warn("[DASHBOARD STORE] Temps rÃ©el dÃ©jÃ  initialisÃ©");const n=t.user.id;if(z.info("[DASHBOARD STORE] Initialisation des mises Ã  jour temps rÃ©el",{clientId:n}),!s.isReady)return z.warn("[DASHBOARD STORE] Service temps rÃ©el non prÃªt, tentative d'initialisation diffÃ©rÃ©e"),void setTimeout(()=>{d.value||b()},2e3);await s.subscribeToDashboardEvents(n),s.registerDashboardHandler("service",w),s.registerDashboardHandler("invoice",_),s.registerDashboardHandler("ticket",k),s.registerDashboardHandler("stats",S),d.value=!0,z.info("[DASHBOARD STORE] Temps rÃ©el initialisÃ© avec succÃ¨s")}catch(t){z.error("[DASHBOARD STORE] Erreur lors de l'initialisation du temps rÃ©el",{error:t.message}),d.value=!1}},w=async e=>{if(z.info("[DASHBOARD STORE] Mise Ã  jour service reÃ§ue",{event:e}),!e.data.service)return;p.value=!0;const t=e.data.service,n=e.action||e.data.action,i={id:t.id,client_id:t.client_id,name:t.name||t.product_name||`Service #${t.id}`,type:t.type||t.product_type||t.product_name||"Service",status:t.status||"pending",price:parseFloat(t.price||t.recurring_amount||t.product_price||0),billing_cycle:t.billing_cycle||"monthly",next_due_date:t.next_due_date,created_at:t.created_at,updated_at:t.updated_at};switch(z.info("[DASHBOARD STORE] Traitement Ã©vÃ©nement service",{action:n,serviceId:i.id,serviceName:i.name,servicePrice:i.price,serviceStatus:i.status}),n){case"service_delete":case"delete":case"deleted":z.info("[DASHBOARD STORE] Service supprimÃ© - rÃ©cupÃ©ration liste complÃ¨te prÃ©vue",{serviceId:i.id,serviceName:i.name});break;case"service_status_changed":case"status_changed":case"update":case"updated":const e=r.value.findIndex(e=>e.id===i.id);-1!==e&&(r.value[e]=i,z.info("[DASHBOARD STORE] Service mis Ã  jour",{serviceId:i.id,newStatus:i.status}));break;case"service_create":case"create":case"created":z.info("[DASHBOARD STORE] Service crÃ©Ã© - rÃ©cupÃ©ration liste complÃ¨te prÃ©vue",{serviceId:i.id,serviceName:i.name});break;default:const t=r.value.findIndex(e=>e.id===i.id);-1!==t&&(r.value[t]=i,z.info("[DASHBOARD STORE] Service mis Ã  jour (action inconnue)",{serviceId:i.id,action:n}))}if(s.value)if("service_delete"===n||"delete"===n||"deleted"===n||"service_create"===n||"create"===n||"created"===n){z.info("[DASHBOARD STORE] RÃ©cupÃ©ration des donnÃ©es aprÃ¨s modification de service",{action:n});try{const e=await Nt.getOverview();r.value=e.recent_services,o.value=e.recent_invoices,c.value=e.recent_tickets,l.value=e.unpaid_invoices,u.value=e.open_tickets;const t=await Nt.getStats();s.value=t,z.info("[DASHBOARD STORE] Toutes les donnÃ©es mises Ã  jour depuis le backend",{services:t.services,recentServicesCount:e.recent_services.length,recentInvoicesCount:e.recent_invoices.length,recentTicketsCount:e.recent_tickets.length,action:n})}catch(a){z.error("[DASHBOARD STORE] Erreur lors de la rÃ©cupÃ©ration des donnÃ©es",{error:a});const e=r.value.filter(e=>"active"===e.status).length,t=r.value.filter(e=>"suspended"===e.status).length;s.value.services.active=e,s.value.services.suspended=t}}else{const e=r.value.filter(e=>"active"===e.status).length,t=r.value.filter(e=>"suspended"===e.status).length;s.value.services.active=e,s.value.services.suspended=t,z.info("[DASHBOARD STORE] Statistiques services recalculÃ©es localement",{active:e,suspended:t,action:n})}h.value=(new Date).toISOString(),setTimeout(()=>{p.value=!1},1e3)},_=async e=>{if(z.info("[DASHBOARD STORE] Mise Ã  jour facture reÃ§ue",{event:e}),z.info("[DASHBOARD STORE] ð ANALYSE STRUCTURE EVENT REÃU:",{event_keys:Object.keys(e),"event.action":e.action,"event.entity_type":e.entity_type,"event.data_exists":!!e.data,"event.data_keys":e.data?Object.keys(e.data):null,"event.data.invoice_exists":e.data?!!e.data.invoice:null,"event.invoice_exists":!!e.invoice,structure_complete:JSON.stringify(e,null,2)}),!e.data.invoice)return void z.error("[DASHBOARD STORE] â AUCUNE DONNÃE FACTURE TROUVÃE dans event.data.invoice");p.value=!0;const t=e.data.invoice,n=e.action||e.data.action;switch(z.info("[DASHBOARD STORE] Traitement Ã©vÃ©nement facture",{action:n,invoiceId:t.id,invoiceNumber:t.number}),n){case"invoice_create":case"create":case"created":z.info("[DASHBOARD STORE] Facture crÃ©Ã©e - rÃ©cupÃ©ration liste complÃ¨te prÃ©vue",{invoiceId:t.id,invoiceNumber:t.number});break;case"invoice_update":case"update":case"updated":const e=o.value.findIndex(e=>e.id===t.id);-1!==e&&(o.value[e]={...o.value[e],...t},z.info("[DASHBOARD STORE] Facture mise Ã  jour",{invoiceId:t.id,newStatus:t.status,number:o.value[e].number}));break;default:const s=o.value.findIndex(e=>e.id===t.id);-1!==s&&(o.value[s]={...o.value[s],...t},z.info("[DASHBOARD STORE] Facture mise Ã  jour (action inconnue)",{invoiceId:t.id,action:n,number:o.value[s].number}))}if(s.value)if("invoice_create"===n||"create"===n||"created"===n){z.info("[DASHBOARD STORE] RÃ©cupÃ©ration des donnÃ©es aprÃ¨s modification de facture",{action:n});try{const e=await Nt.getOverview();r.value=e.recent_services,o.value=e.recent_invoices,c.value=e.recent_tickets,l.value=e.unpaid_invoices,u.value=e.open_tickets;const t=await Nt.getStats();s.value=t,z.info("[DASHBOARD STORE] Toutes les donnÃ©es mises Ã  jour aprÃ¨s modification facture",{services:t.services,recentInvoicesCount:e.recent_invoices.length,action:n})}catch(i){z.error("[DASHBOARD STORE] Erreur lors de la rÃ©cupÃ©ration des donnÃ©es",{error:i});const e=o.value.filter(e=>"unpaid"===e.status).length,t=o.value.filter(e=>"unpaid"===e.status).reduce((e,t)=>e+t.amount,0);s.value.invoices.unpaid=e,s.value.invoices.total_due=t}}else{const e=o.value.filter(e=>"unpaid"===e.status).length,t=o.value.filter(e=>"unpaid"===e.status).reduce((e,t)=>e+t.amount,0);s.value.invoices.unpaid=e,s.value.invoices.total_due=t,z.info("[DASHBOARD STORE] Statistiques factures recalculÃ©es localement",{unpaid:e,totalDue:t,action:n})}h.value=(new Date).toISOString(),setTimeout(()=>{p.value=!1},1e3)},k=async e=>{if(z.info("[DASHBOARD STORE] Mise Ã  jour ticket reÃ§ue",{event:e}),!e.data.ticket)return;p.value=!0;const t=e.data.ticket,n=e.action||e.data.action;switch(z.info("[DASHBOARD STORE] Traitement Ã©vÃ©nement ticket",{action:n,ticketId:t.id,ticketTitle:t.title}),n){case"ticket_create":case"create":case"created":z.info("[DASHBOARD STORE] Ticket crÃ©Ã© - rÃ©cupÃ©ration liste complÃ¨te prÃ©vue",{ticketId:t.id,ticketTitle:t.title});break;case"ticket_update":case"update":case"updated":const e=c.value.findIndex(e=>e.id===t.id);-1!==e&&(c.value[e]={...c.value[e],...t},z.info("[DASHBOARD STORE] Ticket mis Ã  jour",{ticketId:t.id,newStatus:t.status,title:c.value[e].title}));break;default:const s=c.value.findIndex(e=>e.id===t.id);-1!==s&&(c.value[s]={...c.value[s],...t},z.info("[DASHBOARD STORE] Ticket mis Ã  jour (action inconnue)",{ticketId:t.id,action:n,title:c.value[s].title}))}if(s.value)if("ticket_create"===n||"create"===n||"created"===n){z.info("[DASHBOARD STORE] RÃ©cupÃ©ration des donnÃ©es aprÃ¨s modification de ticket",{action:n});try{const e=await Nt.getOverview();r.value=e.recent_services,o.value=e.recent_invoices,c.value=e.recent_tickets,l.value=e.unpaid_invoices,u.value=e.open_tickets;const t=await Nt.getStats();s.value=t,z.info("[DASHBOARD STORE] Toutes les donnÃ©es mises Ã  jour aprÃ¨s modification ticket",{services:t.services,recentTicketsCount:e.recent_tickets.length,action:n})}catch(i){z.error("[DASHBOARD STORE] Erreur lors de la rÃ©cupÃ©ration des donnÃ©es",{error:i});const e=c.value.filter(e=>"open"===e.status).length,t=c.value.filter(e=>"answered"===e.status).length;s.value.tickets.open=e,s.value.tickets.in_progress=t}}else{const e=c.value.filter(e=>"open"===e.status).length,t=c.value.filter(e=>"answered"===e.status).length;s.value.tickets.open=e,s.value.tickets.in_progress=t,z.info("[DASHBOARD STORE] Statistiques tickets recalculÃ©es localement",{open:e,inProgress:t,action:n})}h.value=(new Date).toISOString(),setTimeout(()=>{p.value=!1},1e3)},S=e=>{z.info("[DASHBOARD STORE] Mise Ã  jour statistiques reÃ§ue",{event:e}),e.data.stats&&(p.value=!0,s.value=e.data.stats,h.value=(new Date).toISOString(),setTimeout(()=>{p.value=!1},1e3))};return{loading:e,error:t,stats:s,overview:n,recentServices:r,recentInvoices:o,recentTickets:c,unpaidInvoices:l,openTickets:u,realtimeInitialized:d,lastUpdate:h,isUpdating:p,hasData:f,totalServices:g,activeServices:v,totalUnpaidAmount:m,openTicketsCount:y,fetchStats:async()=>{e.value=!0,t.value=null;try{s.value=await Nt.getStats()}catch(n){throw t.value=n.message||"Erreur lors de la rÃ©cupÃ©ration des statistiques",n}finally{e.value=!1}},fetchOverview:async()=>{e.value=!0,t.value=null;try{n.value=await Nt.getOverview(),r.value=n.value.recent_services,o.value=n.value.recent_invoices,c.value=n.value.recent_tickets,l.value=n.value.unpaid_invoices,u.value=n.value.open_tickets}catch(s){throw t.value=s.message||"Erreur lors de la rÃ©cupÃ©ration de la vue d'ensemble",s}finally{e.value=!1}},fetchDashboardData:async()=>{e.value=!0,t.value=null;try{const[e,t]=await Promise.all([Nt.getStats(),Nt.getOverview()]);s.value=e,n.value=t,r.value=t.recent_services,o.value=t.recent_invoices,c.value=t.recent_tickets,l.value=t.unpaid_invoices,u.value=t.open_tickets}catch(i){throw t.value=i.message||"Erreur lors de la rÃ©cupÃ©ration des donnÃ©es du dashboard",i}finally{e.value=!1}},fetchRecentServices:async()=>{try{r.value=await Nt.getRecentServices()}catch(e){throw t.value=e.message||"Erreur lors de la rÃ©cupÃ©ration des services rÃ©cents",e}},fetchRecentInvoices:async()=>{try{o.value=await Nt.getRecentInvoices()}catch(e){throw t.value=e.message||"Erreur lors de la rÃ©cupÃ©ration des factures rÃ©centes",e}},fetchRecentTickets:async()=>{try{c.value=await Nt.getRecentTickets()}catch(e){throw t.value=e.message||"Erreur lors de la rÃ©cupÃ©ration des tickets rÃ©cents",e}},clearError:()=>{t.value=null},resetData:()=>{s.value=null,n.value=null,r.value=[],o.value=[],c.value=[],l.value=[],u.value=[],t.value=null,e.value=!1,d.value=!1,h.value=null,p.value=!1},initRealtimeUpdates:b,stopRealtimeUpdates:()=>{const e=_e();z.info("[DASHBOARD STORE] ArrÃªt des mises Ã  jour temps rÃ©el"),e.unsubscribeFromDashboardEvents(),e.unregisterDashboardHandler("service"),e.unregisterDashboardHandler("invoice"),e.unregisterDashboardHandler("ticket"),e.unregisterDashboardHandler("stats"),d.value=!1},handleServiceUpdate:w,handleInvoiceUpdate:_,handleTicketUpdate:k,handleStatsUpdate:S}}),Ut={id:"client-dashboard"},xt={class:"header-box"},Bt={class:"stats-grid box-grid"},Ht={class:"stat-card card-box"},qt={class:"stat-number"},Gt={class:"stat-label"},Vt={class:"stat-card card-box"},jt={class:"stat-number"},Ft={class:"stat-label"},$t={class:"stat-card card-box"},Wt={class:"stat-number"},zt={class:"stat-label"},Jt={class:"stat-card card-box"},Kt={class:"stat-number"},Yt={class:"stat-label"},Qt={class:"dashboard-grid box-grid"},Xt={class:"card card-box"},Zt={class:"card-header"},es={class:"card-title"},ts={class:"card-body"},ss={key:0,class:"loading-state"},ns={key:1,class:"service-list"},is={class:"service-info"},as={class:"service-icon"},rs={class:"service-details"},os={class:"service-name"},cs=["onClick"],ls={class:"service-type"},us={class:"service-meta"},ds={class:"service-price"},hs={class:"service-status"},ps={key:0,class:"no-data"},fs={class:"card card-box"},gs={class:"card-header"},vs={class:"card-title"},ms={class:"card-body"},ys={key:0,class:"loading-state"},bs={key:1,class:"invoice-list"},ws={class:"invoice-info"},_s={class:"invoice-details"},ks={class:"invoice-number"},Ss=["onClick"],Rs={class:"invoice-date"},Cs={class:"invoice-meta"},Os={class:"invoice-amount"},Es={class:"invoice-status"},As={key:0,class:"no-data"},Ts={class:"card card-box"},Is={class:"card-header"},Ms={class:"card-title"},Ps={class:"card-body"},Ls={key:0,class:"loading-state"},Ns={key:1,class:"ticket-list"},Ds={class:"ticket-info"},Us={class:"ticket-details"},xs={class:"ticket-title"},Bs=["onClick"],Hs={class:"ticket-id"},qs={class:"ticket-meta"},Gs={class:"ticket-date"},Vs={class:"ticket-status"},js={key:0,class:"no-data"},Fs=r({__name:"DashboardView",setup(e){const t=o(),s=Dt(),n=_e(),i=re();function a(e){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(e)}function r(e){const t=new Date(e);return new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"}).format(t)}function c(e){return{active:"status-badge status-success",suspended:"status-badge status-danger",paid:"status-badge status-success",unpaid:"status-badge status-warning",open:"status-badge status-info",in_progress:"status-badge status-warning",resolved:"status-badge status-success",closed:"status-badge status-secondary"}[e]||"status-badge status-default"}function f(){t.push("/services")}function y(){t.push("/billing")}function b(){t.push("/support")}return l(async()=>{try{z.info("[DASHBOARD] Chargement des donnÃ©es du dashboard"),await s.fetchDashboardData(),z.info("[DASHBOARD] DonnÃ©es du dashboard chargÃ©es avec succÃ¨s"),i.isAuthenticated&&!n.initialized&&(await n.init(),z.info("[DASHBOARD] Service temps rÃ©el initialisÃ©")),i.isAuthenticated&&!s.realtimeInitialized&&(await s.initRealtimeUpdates(),z.info("[DASHBOARD] Temps rÃ©el dashboard initialisÃ© avec succÃ¨s"))}catch(e){z.error("[DASHBOARD] Erreur lors du chargement des donnÃ©es",{error:e})}}),u(()=>{s.realtimeInitialized&&(s.stopRealtimeUpdates(),z.info("[DASHBOARD] Nettoyage du composant dashboard"))}),(e,n)=>{var i;return h(),d("div",Ut,[p("div",xt,[p("h1",null,m(e.$t("dashboard.title")),1)]),p("div",Bt,[p("div",Ht,[n[0]||(n[0]=p("div",{class:"stat-icon"},[p("i",{class:"fas fa-server"})],-1)),p("div",qt,m(A(s).totalServices),1),p("div",Gt,m(e.$t("dashboard.my_services")),1)]),p("div",Vt,[n[1]||(n[1]=p("div",{class:"stat-icon"},[p("i",{class:"fas fa-file-invoice"})],-1)),p("div",jt,m((null==(i=A(s).stats)?void 0:i.invoices.unpaid)||0),1),p("div",Ft,m(e.$t("dashboard.unpaid_invoices")),1)]),p("div",$t,[n[2]||(n[2]=p("div",{class:"stat-icon"},[p("i",{class:"fas fa-headset"})],-1)),p("div",Wt,m(A(s).openTicketsCount),1),p("div",zt,m(e.$t("dashboard.open_tickets")),1)]),p("div",Jt,[n[3]||(n[3]=p("div",{class:"stat-icon"},[p("i",{class:"fas fa-credit-card"})],-1)),p("div",Kt,m(a(A(s).totalUnpaidAmount)),1),p("div",Yt,m(e.$t("dashboard.total_due")),1)])]),p("div",Qt,[p("div",Xt,[p("div",Zt,[p("h3",es,[n[4]||(n[4]=p("i",{class:"fas fa-server"},null,-1)),L(" "+m(e.$t("dashboard.my_services")),1)]),p("button",{onClick:f,class:"btn btn-sm btn-outline"},m(e.$t("dashboard.view_all")),1)]),p("div",ts,[A(s).loading?(h(),d("div",ss,n[5]||(n[5]=[p("i",{class:"fas fa-spinner fa-spin"},null,-1)]))):(h(),d("div",ns,[(h(!0),d(w,null,_(A(s).recentServices,s=>{return h(),d("div",{key:s.id,class:"service-item"},[p("div",is,[p("div",as,[p("i",{class:v((n=s.type,{"HÃ©bergement Web":"fas fa-globe","Serveur Virtuel":"fas fa-server","Nom de Domaine":"fas fa-link",Email:"fas fa-envelope"}[n]||"fas fa-cog"))},null,2)]),p("div",rs,[p("div",os,[p("a",{onClick:k(e=>{return n=s.id,void t.push(`/services/${n}`);var n},["prevent"]),href:"#",class:"service-link"},m(s.name),9,cs)]),p("div",ls,m(s.type),1)])]),p("div",us,[p("div",ds,m(a(s.price))+"/"+m(e.$t("common.month")),1),p("div",hs,[p("span",{class:v(c(s.status))},m(e.$t("status."+s.status)),3)])])]);var n}),128)),0===A(s).recentServices.length?(h(),d("div",ps,m(e.$t("services.no_services")),1)):g("",!0)]))])]),p("div",fs,[p("div",gs,[p("h3",vs,[n[6]||(n[6]=p("i",{class:"fas fa-file-invoice"},null,-1)),L(" "+m(e.$t("dashboard.recent_invoices")),1)]),p("button",{onClick:y,class:"btn btn-sm btn-outline"},m(e.$t("dashboard.view_all")),1)]),p("div",ms,[A(s).loading?(h(),d("div",ys,n[7]||(n[7]=[p("i",{class:"fas fa-spinner fa-spin"},null,-1)]))):(h(),d("div",bs,[(h(!0),d(w,null,_(A(s).recentInvoices,s=>(h(),d("div",{key:s.id,class:"invoice-item"},[p("div",ws,[n[8]||(n[8]=p("div",{class:"invoice-icon"},[p("i",{class:"fas fa-file-invoice"})],-1)),p("div",_s,[p("div",ks,[p("a",{onClick:k(e=>{return n=s.id,void t.push(`/billing/invoice/${n}`);var n},["prevent"]),href:"#",class:"invoice-link"},m(e.$t("billing.invoice_number"))+" #"+m(s.number),9,Ss)]),p("div",Rs,m(r(s.created_at)),1)])]),p("div",Cs,[p("div",Os,m(a(s.amount)),1),p("div",Es,[p("span",{class:v(c(s.status))},m(e.$t("status."+s.status)),3)])])]))),128)),0===A(s).recentInvoices.length?(h(),d("div",As,m(e.$t("billing.no_invoices")),1)):g("",!0)]))])])]),p("div",Ts,[p("div",Is,[p("h3",Ms,[n[9]||(n[9]=p("i",{class:"fas fa-headset"},null,-1)),L(" "+m(e.$t("dashboard.recent_tickets")),1)]),p("button",{onClick:b,class:"btn btn-sm btn-outline"},m(e.$t("dashboard.view_all")),1)]),p("div",Ps,[A(s).loading?(h(),d("div",Ls,n[10]||(n[10]=[p("i",{class:"fas fa-spinner fa-spin"},null,-1)]))):(h(),d("div",Ns,[(h(!0),d(w,null,_(A(s).recentTickets,s=>(h(),d("div",{key:s.id,class:"ticket-item"},[p("div",Ds,[n[11]||(n[11]=p("div",{class:"ticket-icon"},[p("i",{class:"fas fa-headset"})],-1)),p("div",Us,[p("div",xs,[p("a",{onClick:k(e=>{return n=s.id,void t.push(`/support/ticket/${n}`);var n},["prevent"]),href:"#",class:"ticket-link"},m(s.title),9,Bs)]),p("div",Hs," #"+m(s.id),1)])]),p("div",qs,[p("div",Gs,m(r(s.created_at)),1),p("div",Vs,[p("span",{class:v(c(s.status))},m(e.$t("status."+s.status)),3)])])]))),128)),0===A(s).recentTickets.length?(h(),d("div",js,m(e.$t("support.no_tickets")),1)):g("",!0)]))])])])}}}),$s=qe(Fs,[["__scopeId","data-v-4be950b1"]]),Ws=n("services",()=>{const e=i([]),t=i(!1),s=i(null),n=i(null),r=i(!1),o=a(()=>t=>e.value.find(e=>e.id===t)||null),c=a(()=>t=>e.value.filter(e=>e.status===t)),l=a(()=>e.value.filter(e=>"active"===e.status)),u=a(()=>e.value.filter(e=>"suspended"===e.status)),d=a(()=>e.value.filter(e=>"pending"===e.status)),h=async()=>{var i,a;t.value=!0,s.value=null;try{const t=await F.routes.client.service.list();return e.value=t.data,n.value=(new Date).toISOString(),z.info("[SERVICES STORE] Services chargÃ©s",{count:e.value.length,active:l.value.length,suspended:u.value.length,pending:d.value.length}),t.data}catch(r){throw z.error("[SERVICES STORE] Erreur lors du chargement des services",{error:r}),s.value=(null==(a=null==(i=r.response)?void 0:i.data)?void 0:a.message)||"Erreur lors du chargement des services",r}finally{t.value=!1}};return{services:e,loading:t,error:s,lastUpdate:n,isUpdating:r,getServiceById:o,getServicesByStatus:c,activeServices:l,suspendedServices:u,pendingServices:d,fetchServices:h,refreshServices:async()=>(z.info("[SERVICES STORE] Actualisation des services"),await h()),handleServiceUpdate:async t=>{if(z.info("[SERVICES STORE] Mise Ã  jour service reÃ§ue",{event:t}),!t.data.service)return;r.value=!0;const s=t.data.service,i=t.action||t.data.action,a={id:s.id,client_id:s.client_id,product_id:s.product_id||0,name:s.name||s.product_name||`Service #${s.id}`,type:s.type||s.product_name||"Service",status:s.status||"pending",recurring_amount:parseFloat(s.price||s.recurring_amount||0),setup_fee:parseFloat(s.setup_fee||0),billing_cycle:s.billing_cycle||"monthly",next_due_date:s.next_due_date,created_at:s.created_at,updated_at:s.updated_at,notes:s.notes||""};switch(z.info("[SERVICES STORE] Traitement Ã©vÃ©nement service",{action:i,serviceId:a.id,serviceName:a.name,serviceStatus:a.status}),i){case"service_delete":case"delete":case"deleted":z.info("[SERVICES STORE] Service supprimÃ© - rÃ©cupÃ©ration liste complÃ¨te prÃ©vue",{serviceId:a.id,serviceName:a.name});try{await h(),z.info("[SERVICES STORE] Liste des services mise Ã  jour aprÃ¨s suppression")}catch(o){z.error("[SERVICES STORE] Erreur lors de la rÃ©cupÃ©ration aprÃ¨s suppression",{error:o});const t=e.value.findIndex(e=>e.id===a.id);-1!==t&&e.value.splice(t,1)}break;case"service_status_changed":case"status_changed":const t=e.value.findIndex(e=>e.id===a.id);if(-1!==t){const s=e.value[t].status;e.value[t]={...e.value[t],...a},z.info("[SERVICES STORE] Statut service mis Ã  jour",{serviceId:a.id,oldStatus:s,newStatus:a.status,serviceName:e.value[t].name})}break;case"service_create":case"create":case"created":z.info("[SERVICES STORE] Service crÃ©Ã© - rÃ©cupÃ©ration liste complÃ¨te prÃ©vue",{serviceId:a.id,serviceName:a.name});try{await h(),z.info("[SERVICES STORE] Liste des services mise Ã  jour aprÃ¨s crÃ©ation")}catch(o){z.error("[SERVICES STORE] Erreur lors de la rÃ©cupÃ©ration aprÃ¨s crÃ©ation",{error:o});-1===e.value.findIndex(e=>e.id===a.id)&&e.value.unshift(a)}break;default:const s=e.value.findIndex(e=>e.id===a.id);-1!==s&&(e.value[s]={...e.value[s],...a},z.info("[SERVICES STORE] Service mis Ã  jour (action inconnue)",{serviceId:a.id,action:i,serviceName:e.value[s].name}))}n.value=(new Date).toISOString(),setTimeout(()=>{r.value=!1},1e3)},clearError:()=>{s.value=null},reset:()=>{e.value=[],t.value=!1,s.value=null,n.value=null,r.value=!1}}}),zs=e=>{if(!e)return!1;if("string"==typeof e&&""===e.trim())return!1;const t=new Date(e);return!isNaN(t.getTime())},Js=e=>{if(!zs(e))return"Date non dÃ©finie";try{const t=new Date(e);return new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"short",year:"numeric",timeZone:"Europe/Paris"}).format(t)}catch(t){return z.warn("[DATE_UTILS] Erreur lors du formatage de la date (court)",{date:e,error:t}),"Date invalide"}},Ks=e=>{if(!zs(e))return"Date non dÃ©finie";try{const t=new Date(e);return new Intl.DateTimeFormat("fr-FR",{day:"numeric",month:"long",year:"numeric",timeZone:"Europe/Paris"}).format(t)}catch(t){return z.warn("[DATE_UTILS] Erreur lors du formatage de la date (long)",{date:e,error:t}),"Date invalide"}},Ys=(e,t=!0)=>{if(!(e=>{if(null==e)return!1;if("string"==typeof e&&""===e.trim())return!1;const t=Number(e);return!isNaN(t)&&isFinite(t)})(e))return t?"Gratuit":"0,00 â¬";try{const s=Number(e);return 0===s&&t?"Gratuit":new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(s)}catch(s){return z.warn("[DATE_UTILS] Erreur lors du formatage du prix",{value:e,error:s}),t?"Gratuit":"0,00 â¬"}},Qs={id:"client-services"},Xs={class:"services-header"},Zs={class:"services-actions"},en={class:"btn btn-outline btn-sm"},tn={class:"btn btn-primary btn-sm"},sn={class:"services-filters"},nn={class:"filter-group"},an={class:"filter-label"},rn={value:""},on={value:"active"},cn={value:"suspended"},ln={value:"pending"},un={value:"expired"},dn={class:"filter-group"},hn={class:"filter-label"},pn={value:""},fn={value:"HÃ©bergement Web"},gn={value:"Serveur Virtuel"},vn={value:"Nom de Domaine"},mn={value:"Email"},yn={value:"SSL"},bn={class:"filter-group"},wn={class:"filter-label"},_n=["placeholder"],kn={key:0,class:"loading-state"},Sn={key:1,class:"error-state"},Rn={key:2,class:"empty-state"},Cn={class:"btn btn-primary"},On={key:3,class:"services-grid"},En={class:"service-header"},An={class:"service-info"},Tn={class:"service-icon"},In={class:"service-details"},Mn={class:"service-name"},Pn={class:"service-type"},Ln={class:"service-description"},Nn={class:"service-status"},Dn={class:"service-meta"},Un={class:"service-pricing"},xn={class:"service-price"},Bn={class:"service-period"},Hn={class:"service-dates"},qn={class:"service-date-label"},Gn={class:"service-date-value"},Vn={class:"service-actions"},jn=["onClick"],Fn={class:"btn btn-outline btn-sm"},$n={key:0,class:"btn btn-outline btn-sm"},Wn=qe(r({__name:"ServicesView",setup(e){const t=o(),s=Ws(),n=_e(),r=re(),c=i(""),f=i(""),y=i(""),b=a(()=>s.loading),k=a(()=>s.error),S=a(()=>s.services),R=async()=>{try{await s.fetchServices(),z.info("[SERVICES VIEW] Services chargÃ©s depuis le store",{count:S.value.length})}catch(e){z.error("[SERVICES VIEW] Erreur lors du chargement des services",{error:e})}},C=a(()=>{let e=S.value;if(c.value&&(e=e.filter(e=>e.status===c.value)),f.value&&(e=e.filter(e=>e.type===f.value)),y.value){const t=y.value.toLowerCase();e=e.filter(e=>e.name&&e.name.toLowerCase().includes(t)||e.type&&e.type.toLowerCase().includes(t)||e.notes&&e.notes.toLowerCase().includes(t))}return e}),T=()=>{},I=Ys,M=Ks,P=e=>({active:"Actif",suspended:"Suspendu",pending:"En attente",cancelled:"AnnulÃ©",terminated:"RÃ©siliÃ©",fraud:"Fraude"}[e]||e),D=e=>{if(!e)return"fas fa-cog";return{"HÃ©bergement Web":"fas fa-globe","Serveur Virtuel":"fas fa-server","Nom de Domaine":"fas fa-link",Email:"fas fa-envelope",SSL:"fas fa-shield-alt"}[e]||"fas fa-cog"};return l(async()=>{var e;await R();const t=null==(e=r.user)?void 0:e.id;if(t)if(n.initialized)await n.subscribeToDashboardEvents(t),n.registerDashboardHandler("service-page",s.handleServiceUpdate),z.info("[SERVICES VIEW] Handler temps rÃ©el enregistrÃ© avec clÃ© service-page",{clientId:t});else{const e=n.$subscribe((i,a)=>{a.initialized&&(n.subscribeToDashboardEvents(t).then(()=>{n.registerDashboardHandler("service-page",s.handleServiceUpdate),z.info("[SERVICES VIEW] Handler temps rÃ©el enregistrÃ© (aprÃ¨s initialisation) avec clÃ© service-page",{clientId:t})}),e())})}else z.error("[SERVICES VIEW] ID client manquant - abandon initialisation temps rÃ©el",{user:r.user})}),u(()=>{n.unregisterDashboardHandler("service-page"),z.info("[SERVICES VIEW] Handler temps rÃ©el supprimÃ© pour clÃ© service-page")}),(e,s)=>(h(),d("div",Qs,[p("div",Xs,[p("h1",null,[s[4]||(s[4]=p("i",{class:"fas fa-server"},null,-1)),L(" "+m(e.$t("services.title")),1)]),p("div",Zs,[p("button",en,[s[5]||(s[5]=p("i",{class:"fas fa-download"},null,-1)),L(" "+m(e.$t("common.export")),1)]),p("button",tn,[s[6]||(s[6]=p("i",{class:"fas fa-plus"},null,-1)),L(" "+m(e.$t("services.new_service")),1)])])]),p("div",sn,[p("div",nn,[p("label",an,m(e.$t("common.status")),1),O(p("select",{"onUpdate:modelValue":s[0]||(s[0]=e=>c.value=e),class:"filter-select",onChange:T},[p("option",rn,m(e.$t("services.all_statuses")),1),p("option",on,m(e.$t("status.active")),1),p("option",cn,m(e.$t("status.suspended")),1),p("option",ln,m(e.$t("status.pending")),1),p("option",un,m(e.$t("status.expired")),1)],544),[[N,c.value]])]),p("div",dn,[p("label",hn,m(e.$t("services.type")),1),O(p("select",{"onUpdate:modelValue":s[1]||(s[1]=e=>f.value=e),class:"filter-select",onChange:T},[p("option",pn,m(e.$t("services.all_types")),1),p("option",fn,m(e.$t("services.web_hosting")),1),p("option",gn,m(e.$t("services.vps")),1),p("option",vn,m(e.$t("services.domain")),1),p("option",mn,m(e.$t("services.email")),1),p("option",yn,m(e.$t("services.ssl")),1)],544),[[N,f.value]])]),p("div",bn,[p("label",wn,m(e.$t("common.search")),1),O(p("input",{"onUpdate:modelValue":s[2]||(s[2]=e=>y.value=e),type:"text",class:"filter-select",placeholder:e.$t("services.search_placeholder"),onInput:T},null,40,_n),[[E,y.value]])])]),b.value?(h(),d("div",kn,[s[7]||(s[7]=p("i",{class:"fas fa-spinner fa-spin"},null,-1)),p("p",null,m(e.$t("services.loading_services")),1)])):k.value?(h(),d("div",Sn,[s[9]||(s[9]=p("i",{class:"fas fa-exclamation-triangle"},null,-1)),p("h3",null,m(e.$t("common.error")),1),p("p",null,m(k.value),1),p("button",{class:"btn btn-primary",onClick:s[3]||(s[3]=e=>R())},[s[8]||(s[8]=p("i",{class:"fas fa-redo"},null,-1)),L(" "+m(e.$t("common.retry")),1)])])):0===C.value.length?(h(),d("div",Rn,[s[11]||(s[11]=p("i",{class:"fas fa-server"},null,-1)),p("h3",null,m(e.$t("services.no_services")),1),p("p",null,m(y.value||c.value||f.value?e.$t("services.no_results"):e.$t("services.no_active_services")),1),p("button",Cn,[s[10]||(s[10]=p("i",{class:"fas fa-plus"},null,-1)),L(" "+m(e.$t("services.order_service")),1)])])):(h(),d("div",On,[(h(!0),d(w,null,_(C.value,n=>{return h(),d("div",{key:n.id,class:"service-card"},[p("div",En,[p("div",An,[p("div",Tn,[p("i",{class:v(D(n.type))},null,2)]),p("div",In,[p("div",Mn,m(n.name),1),p("div",Pn,m(n.type),1),p("div",Ln,m(n.notes||"Service "+n.name),1)])]),p("div",Nn,[p("span",{class:v((i=n.status,{active:"status-badge status-active",suspended:"status-badge status-suspended",pending:"status-badge status-pending",cancelled:"status-badge status-cancelled",terminated:"status-badge status-terminated",fraud:"status-badge status-fraud"}[i]||"status-badge"))},m(P(n.status)),3)])]),p("div",Dn,[p("div",Un,[p("div",xn,m(A(I)(n.recurring_amount)),1),p("div",Bn,m(n.billing_cycle),1)]),p("div",Hn,[p("div",qn,m(e.$t("services.expires_on")),1),p("div",Gn,m(A(M)(n.next_due_date)),1)])]),p("div",Vn,[p("button",{class:"btn btn-primary btn-sm",onClick:e=>{return s=n.id,void t.push(`/services/${s}`);var s}},[s[12]||(s[12]=p("i",{class:"fas fa-cog"},null,-1)),L(" "+m(e.$t("services.manage")),1)],8,jn),p("button",Fn,[s[13]||(s[13]=p("i",{class:"fas fa-chart-line"},null,-1)),L(" "+m(e.$t("services.statistics")),1)]),"active"===n.status?(h(),d("button",$n,[s[14]||(s[14]=p("i",{class:"fas fa-sync"},null,-1)),L(" "+m(e.$t("services.renew")),1)])):g("",!0)])]);var i}),128))]))]))}}),[["__scopeId","data-v-1f37a9c8"]]),zn=n("invoices",()=>{const e=i([]),t=i(!1),s=i(null),n=i(null),r=i(!1),o=a(()=>t=>e.value.find(e=>e.id===t)||null),c=a(()=>t=>e.value.filter(e=>e.status===t)),l=a(()=>e.value.filter(e=>"unpaid"===e.status)),u=a(()=>e.value.filter(e=>"paid"===e.status)),d=a(()=>e.value.filter(e=>"overdue"===e.status)),h=a(()=>l.value.reduce((e,t)=>e+t.amount,0)),p=a(()=>u.value.reduce((e,t)=>e+t.amount,0)),f=a(()=>e.value.length),g=async()=>{var i,a;t.value=!0,s.value=null;try{const t=await F.routes.client.invoice.list();return e.value=t.data,n.value=(new Date).toISOString(),z.info("[INVOICES STORE] Factures chargÃ©es",{count:e.value.length,unpaid:l.value.length,paid:u.value.length,overdue:d.value.length,totalDue:h.value}),t.data}catch(r){throw z.error("[INVOICES STORE] Erreur lors du chargement des factures",{error:r}),s.value=(null==(a=null==(i=r.response)?void 0:i.data)?void 0:a.message)||"Erreur lors du chargement des factures",r}finally{t.value=!1}};return{invoices:e,loading:t,error:s,lastUpdate:n,isUpdating:r,getInvoiceById:o,getInvoicesByStatus:c,unpaidInvoices:l,paidInvoices:u,overdueInvoices:d,totalDue:h,totalPaid:p,totalInvoices:f,fetchInvoices:g,refreshInvoices:async()=>(z.info("[INVOICES STORE] Actualisation des factures"),await g()),handleInvoiceUpdate:async t=>{if(z.info("[INVOICES STORE] Mise Ã  jour facture reÃ§ue",{event:t}),z.info("[INVOICES STORE] ð ANALYSE STRUCTURE EVENT REÃU:",{event_keys:Object.keys(t),"event.action":t.action,"event.entity_type":t.entity_type,"event.data_exists":!!t.data,"event.data_keys":t.data?Object.keys(t.data):null,"event.data.invoice_exists":t.data?!!t.data.invoice:null,"event.invoice_exists":!!t.invoice,structure_complete:JSON.stringify(t,null,2)}),!t.data.invoice)return void z.error("[INVOICES STORE] â AUCUNE DONNÃE FACTURE TROUVÃE dans event.data.invoice");r.value=!0;const s=t.data.invoice,i=t.action||t.data.action,a={id:s.id,client_id:s.client_id,number:s.number||`INV-${s.id}`,amount:parseFloat(s.amount||0),status:s.status||"unpaid",created_at:s.created_at,due_date:s.due_date,notes:s.notes||"",updated_at:s.updated_at};switch(z.info("[INVOICES STORE] Traitement Ã©vÃ©nement facture",{action:i,invoiceId:a.id,invoiceNumber:a.number,invoiceStatus:a.status,invoiceAmount:a.amount}),i){case"invoice_create":case"create":case"created":z.info("[INVOICES STORE] Facture crÃ©Ã©e - rÃ©cupÃ©ration liste complÃ¨te prÃ©vue",{invoiceId:a.id,invoiceNumber:a.number});try{await g(),z.info("[INVOICES STORE] Liste des factures mise Ã  jour aprÃ¨s crÃ©ation")}catch(o){z.error("[INVOICES STORE] Erreur lors de la rÃ©cupÃ©ration aprÃ¨s crÃ©ation",{error:o});-1===e.value.findIndex(e=>e.id===a.id)&&e.value.unshift(a)}break;case"invoice_update":case"update":case"updated":const t=e.value.findIndex(e=>e.id===a.id);if(-1!==t){const s=e.value[t].status;e.value[t]={...e.value[t],...a},z.info("[INVOICES STORE] Facture mise Ã  jour",{invoiceId:a.id,oldStatus:s,newStatus:a.status,invoiceNumber:e.value[t].number})}break;default:const s=e.value.findIndex(e=>e.id===a.id);-1!==s&&(e.value[s]={...e.value[s],...a},z.info("[INVOICES STORE] Facture mise Ã  jour (action inconnue)",{invoiceId:a.id,action:i,invoiceNumber:e.value[s].number}))}n.value=(new Date).toISOString(),setTimeout(()=>{r.value=!1},1e3)},clearError:()=>{s.value=null},reset:()=>{e.value=[],t.value=!1,s.value=null,n.value=null,r.value=!1}}}),Jn={id:"client-billing"},Kn={class:"billing-header"},Yn={class:"billing-actions"},Qn={class:"btn btn-outline btn-sm"},Xn={class:"btn btn-primary btn-sm"},Zn={class:"billing-summary"},ei={class:"summary-card"},ti={class:"summary-value"},si={class:"summary-label"},ni={class:"summary-card"},ii={class:"summary-value"},ai={class:"summary-label"},ri={class:"summary-card"},oi={class:"summary-value"},ci={class:"summary-label"},li={class:"summary-card"},ui={class:"summary-value"},di={class:"summary-label"},hi={class:"billing-filters"},pi={class:"filter-group"},fi={class:"filter-label"},gi={value:""},vi={value:"paid"},mi={value:"unpaid"},yi={value:"overdue"},bi={value:"draft"},wi={class:"filter-group"},_i={class:"filter-label"},ki={value:""},Si={value:"current-month"},Ri={value:"last-month"},Ci={value:"current-year"},Oi={value:"last-year"},Ei={class:"filter-group"},Ai={class:"filter-label"},Ti=["placeholder"],Ii={class:"invoices-table-container"},Mi={key:0,class:"loading-state"},Pi={key:1,class:"error-state"},Li={key:2,class:"empty-state"},Ni={key:3,class:"invoices-table"},Di=["onClick"],Ui={class:"invoice-actions"},xi=["onClick"],Bi=["onClick"],Hi=["onClick"],qi=r({__name:"BillingView",setup(e){const t=o(),s=zn(),n=_e(),r=re(),c=i(""),f=i(""),y=i(""),b=a(()=>s.loading),S=a(()=>s.error),R=a(()=>s.invoices),C=async()=>{try{await s.fetchInvoices(),z.info("[BILLING VIEW] Factures chargÃ©es depuis le store",{count:R.value.length})}catch(e){z.error("[BILLING VIEW] Erreur lors du chargement des factures",{error:e})}},I=a(()=>s.totalInvoices),M=a(()=>s.unpaidInvoices),P=a(()=>s.totalDue),D=a(()=>s.totalPaid),U=a(()=>{let e=R.value;if(c.value&&(e=e.filter(e=>e.status===c.value)),f.value){const t=new Date;e=e.filter(e=>{const s=new Date(e.created_at);switch(f.value){case"current-month":return s.getMonth()===t.getMonth()&&s.getFullYear()===t.getFullYear();case"last-month":const e=new Date(t.getFullYear(),t.getMonth()-1);return s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear();case"current-year":return s.getFullYear()===t.getFullYear();case"last-year":return s.getFullYear()===t.getFullYear()-1;default:return!0}})}if(y.value){const t=y.value.toLowerCase();e=e.filter(e=>e.number.toLowerCase().includes(t)||e.notes&&e.notes.toLowerCase().includes(t))}return e.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime())}),x=()=>{},B=e=>Ys(e,!1),H=Js,q=e=>({paid:"status-badge status-paid",unpaid:"status-badge status-unpaid",draft:"status-badge status-draft",cancelled:"status-badge status-cancelled"}[e]||"status-badge"),G=e=>({paid:"PayÃ©e",unpaid:"ImpayÃ©e",draft:"Brouillon",cancelled:"AnnulÃ©e"}[e]||e),V=e=>{t.push(`/billing/invoice/${e}`)};return l(async()=>{var e;await C();const t=null==(e=r.user)?void 0:e.id;if(t)if(n.initialized)await n.subscribeToDashboardEvents(t),n.registerDashboardHandler("invoice-page",s.handleInvoiceUpdate),z.info("[BILLING VIEW] Handler temps rÃ©el enregistrÃ© avec clÃ© invoice-page",{clientId:t});else{const e=n.$subscribe((i,a)=>{a.initialized&&(n.subscribeToDashboardEvents(t).then(()=>{n.registerDashboardHandler("invoice-page",s.handleInvoiceUpdate),z.info("[BILLING VIEW] Handler temps rÃ©el enregistrÃ© (aprÃ¨s initialisation) avec clÃ© invoice-page",{clientId:t})}),e())})}else z.error("[BILLING VIEW] ID client manquant - abandon initialisation temps rÃ©el",{user:r.user})}),u(()=>{n.unregisterDashboardHandler("invoice-page"),z.info("[BILLING VIEW] Handler temps rÃ©el supprimÃ© pour clÃ© invoice-page")}),(e,t)=>(h(),d("div",Jn,[p("div",Kn,[p("h1",null,[t[4]||(t[4]=p("i",{class:"fas fa-file-invoice"},null,-1)),L(" "+m(e.$t("billing.title")),1)]),p("div",Yn,[p("button",Qn,[t[5]||(t[5]=p("i",{class:"fas fa-download"},null,-1)),L(" "+m(e.$t("common.export")),1)]),p("button",Xn,[t[6]||(t[6]=p("i",{class:"fas fa-credit-card"},null,-1)),L(" "+m(e.$t("billing.pay_unpaid")),1)])])]),p("div",Zn,[p("div",ei,[t[7]||(t[7]=p("div",{class:"summary-icon"},[p("i",{class:"fas fa-file-invoice"})],-1)),p("div",ti,m(I.value),1),p("div",si,m(e.$t("billing.total_invoices")),1)]),p("div",ni,[t[8]||(t[8]=p("div",{class:"summary-icon"},[p("i",{class:"fas fa-exclamation-triangle"})],-1)),p("div",ii,m(M.value.length),1),p("div",ai,m(e.$t("billing.unpaid_invoices")),1)]),p("div",ri,[t[9]||(t[9]=p("div",{class:"summary-icon"},[p("i",{class:"fas fa-euro-sign"})],-1)),p("div",oi,m(B(P.value)),1),p("div",ci,m(e.$t("billing.amount_due")),1)]),p("div",li,[t[10]||(t[10]=p("div",{class:"summary-icon"},[p("i",{class:"fas fa-chart-line"})],-1)),p("div",ui,m(B(D.value)),1),p("div",di,m(e.$t("billing.total_paid")),1)])]),p("div",hi,[p("div",pi,[p("label",fi,m(e.$t("common.status")),1),O(p("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>c.value=e),class:"filter-select",onChange:x},[p("option",gi,m(e.$t("billing.all_statuses")),1),p("option",vi,m(e.$t("status.paid")),1),p("option",mi,m(e.$t("status.unpaid")),1),p("option",yi,m(e.$t("status.overdue")),1),p("option",bi,m(e.$t("billing.draft")),1)],544),[[N,c.value]])]),p("div",wi,[p("label",_i,m(e.$t("billing.period")),1),O(p("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>f.value=e),class:"filter-select",onChange:x},[p("option",ki,m(e.$t("billing.all_periods")),1),p("option",Si,m(e.$t("billing.current_month")),1),p("option",Ri,m(e.$t("billing.last_month")),1),p("option",Ci,m(e.$t("billing.current_year")),1),p("option",Oi,m(e.$t("billing.last_year")),1)],544),[[N,f.value]])]),p("div",Ei,[p("label",Ai,m(e.$t("common.search")),1),O(p("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>y.value=e),type:"text",class:"filter-select",placeholder:e.$t("billing.search_placeholder"),onInput:x},null,40,Ti),[[E,y.value]])])]),p("div",Ii,[t[21]||(t[21]=T('<div class="table-header" data-v-fe32b381><h3 class="table-title" data-v-fe32b381><i class="fas fa-list" data-v-fe32b381></i> Historique des Factures </h3><div class="billing-actions" data-v-fe32b381><button class="btn btn-outline btn-sm" data-v-fe32b381><i class="fas fa-filter" data-v-fe32b381></i> Filtres avancÃ©s </button></div></div>',1)),b.value?(h(),d("div",Mi,t[11]||(t[11]=[p("i",{class:"fas fa-spinner fa-spin"},null,-1),p("p",null,"Chargement de vos factures...",-1)]))):S.value?(h(),d("div",Pi,[t[13]||(t[13]=p("i",{class:"fas fa-exclamation-triangle"},null,-1)),t[14]||(t[14]=p("h3",null,"Erreur de chargement",-1)),p("p",null,m(S.value),1),p("button",{class:"btn btn-primary",onClick:t[3]||(t[3]=e=>C())},t[12]||(t[12]=[p("i",{class:"fas fa-redo"},null,-1),L(" RÃ©essayer ")]))])):0===U.value.length?(h(),d("div",Li,[t[15]||(t[15]=p("i",{class:"fas fa-file-invoice"},null,-1)),t[16]||(t[16]=p("h3",null,"Aucune facture trouvÃ©e",-1)),p("p",null,m(y.value||c.value||f.value?"Aucune facture ne correspond Ã  vos critÃ¨res de recherche.":"Vous n'avez pas encore de factures."),1)])):(h(),d("table",Ni,[t[20]||(t[20]=p("thead",null,[p("tr",null,[p("th",null,"NumÃ©ro"),p("th",null,"Date"),p("th",null,"Description"),p("th",null,"Montant"),p("th",null,"Statut"),p("th",null,"ÃchÃ©ance"),p("th",null,"Actions")])],-1)),p("tbody",null,[(h(!0),d(w,null,_(U.value,e=>{return h(),d("tr",{key:e.id},[p("td",null,[p("a",{href:"#",class:"invoice-number",onClick:k(t=>V(e.id),["prevent"])}," #"+m(e.number),9,Di)]),p("td",null,m(A(H)(e.created_at)),1),p("td",null,m(e.notes||"Facture #"+e.number),1),p("td",null,[p("span",{class:v(["invoice-amount",(s=e.status,"unpaid"===s?"unpaid":"paid"===s?"paid":"cancelled"===s?"cancelled":"")])},m(B(e.amount)),3)]),p("td",null,[p("span",{class:v(q(e.status))},m(G(e.status)),3)]),p("td",null,m(A(H)(e.due_date)),1),p("td",null,[p("div",Ui,[p("button",{class:"btn btn-outline btn-sm",onClick:t=>V(e.id)},t[17]||(t[17]=[p("i",{class:"fas fa-eye"},null,-1),L(" Voir ")]),8,xi),p("button",{class:"btn btn-outline btn-sm",onClick:t=>{return s=e.id,void z.info("[BILLING] TÃ©lÃ©chargement facture demandÃ©",{invoiceId:s});var s}},t[18]||(t[18]=[p("i",{class:"fas fa-download"},null,-1),L(" PDF ")]),8,Bi),"unpaid"===e.status?(h(),d("button",{key:0,class:"btn btn-success btn-sm",onClick:t=>{return s=e.id,void z.info("[BILLING] Paiement facture demandÃ©",{invoiceId:s});var s}},t[19]||(t[19]=[p("i",{class:"fas fa-credit-card"},null,-1),L(" Payer ")]),8,Hi)):g("",!0)])])]);var s}),128))])]))])]))}}),Gi=qe(qi,[["__scopeId","data-v-fe32b381"]]),Vi=n("tickets",()=>{const e=i([]),t=i(!1),s=i(null),n=i(null),r=i(!1),o=a(()=>t=>e.value.find(e=>e.id===t)||null),c=a(()=>t=>e.value.filter(e=>e.status===t)),l=a(()=>e.value.filter(e=>"open"===e.status)),u=a(()=>e.value.filter(e=>"in-progress"===e.status)),d=a(()=>e.value.filter(e=>"resolved"===e.status)),h=a(()=>e.value.filter(e=>"closed"===e.status)),p=async()=>{var i,a;t.value=!0,s.value=null;try{const t=await F.routes.client.ticket.list();return e.value=t.data.map(e=>({...e,id:parseInt(String(e.id)),client_id:parseInt(String(e.client_id)),title:e.subject||e.title})),n.value=(new Date).toISOString(),z.info("[TICKETS STORE] Tickets chargÃ©s avec conversion IDs",{count:e.value.length,ticketIds:e.value.map(e=>({id:e.id,title:e.title})),open:l.value.length,inProgress:u.value.length,resolved:d.value.length,closed:h.value.length}),e.value}catch(r){throw z.error("[TICKETS STORE] Erreur lors du chargement des tickets",{error:r}),s.value=(null==(a=null==(i=r.response)?void 0:i.data)?void 0:a.message)||"Erreur lors du chargement des tickets",r}finally{t.value=!1}};return{tickets:e,loading:t,error:s,lastUpdate:n,isUpdating:r,getTicketById:o,getTicketsByStatus:c,openTickets:l,inProgressTickets:u,resolvedTickets:d,closedTickets:h,fetchTickets:p,refreshTickets:async()=>(z.info("[TICKETS STORE] Actualisation des tickets"),await p()),handleTicketUpdate:async t=>{if(z.info("[TICKETS STORE] Mise Ã  jour ticket reÃ§ue",{event:t}),!t.data.ticket)return void z.error("[TICKETS STORE] â AUCUNE DONNÃE TICKET TROUVÃE dans event.data.ticket");const s=t.data.ticket,i=t.action||t.data.action;z.info("[TICKETS STORE] Traitement Ã©vÃ©nement ticket",{action:i,ticketId:s.id,ticketTitle:s.title||s.subject,currentTicketsCount:e.value.length});const a={id:parseInt(String(s.id)),title:s.subject||s.title,status:s.status,priority:s.priority,department_name:s.department_name,created_at:s.created_at,updated_at:s.updated_at,last_reply_at:s.last_reply_at,client_id:parseInt(String(s.client_id))};switch(z.info("[TICKETS STORE] Ticket converti",{originalId:s.id,convertedId:a.id,title:a.title,status:a.status}),i){case"ticket_create":case"create":case"created":-1===e.value.findIndex(e=>e.id===a.id)&&(e.value.unshift(a),z.info("[TICKETS STORE] Nouveau ticket ajoutÃ©",{ticketId:a.id,ticketTitle:a.title}));break;case"ticket_update":case"update":case"updated":z.info("[TICKETS STORE] Recherche ticket Ã  mettre Ã  jour",{searchId:a.id,currentTickets:e.value.map(e=>({id:e.id,title:e.title}))});const t=e.value.findIndex(e=>e.id===a.id);if(-1!==t){const s={...e.value[t]};e.value[t]={...e.value[t],...a},z.info("[TICKETS STORE] â Ticket mis Ã  jour avec succÃ¨s",{ticketId:a.id,oldTitle:s.title,newTitle:e.value[t].title,oldStatus:s.status,newStatus:e.value[t].status,updateIndex:t})}else z.error("[TICKETS STORE] â Ticket non trouvÃ© pour mise Ã  jour",{searchId:a.id,availableIds:e.value.map(e=>e.id)});break;case"ticket_delete":case"delete":case"deleted":const s=e.value.findIndex(e=>e.id===a.id);-1!==s&&(e.value.splice(s,1),z.info("[TICKETS STORE] Ticket supprimÃ©",{ticketId:a.id,ticketTitle:a.title}));break;default:z.warn("[TICKETS STORE] Action non reconnue",{action:i})}n.value=(new Date).toISOString()}}}),ji={id:"client-support"},Fi={class:"support-header"},$i={class:"support-actions"},Wi={class:"quick-actions"},zi={class:"action-title"},Ji={class:"action-description"},Ki={class:"action-card"},Yi={class:"action-title"},Qi={class:"action-description"},Xi={class:"action-card"},Zi={class:"action-title"},ea={class:"action-description"},ta={class:"action-card"},sa={class:"action-title"},na={class:"action-description"},ia={class:"tickets-section"},aa={class:"tickets-container"},ra={class:"tickets-header"},oa={class:"tickets-filters"},ca={key:0,class:"loading-state"},la={key:1,class:"error-state"},ua={key:2,class:"empty-state"},da={key:3,class:"tickets-list"},ha={class:"ticket-info"},pa={class:"ticket-icon"},fa={class:"ticket-details"},ga={class:"ticket-title"},va=["onClick"],ma={class:"ticket-id"},ya={class:"ticket-meta"},ba={class:"ticket-date"},wa={class:"ticket-status"},_a={class:"form-group"},ka={class:"form-group"},Sa=["value"],Ra={class:"form-group"},Ca={class:"form-group"},Oa=qe(r({__name:"SupportView",setup(e){const t=o(),s=Vi(),n=_e(),r=re(),c=i([]),f=i(""),g=i(""),y=i(""),b=i(!1),S=i(!1),R=i(""),C=i(null),I=i({subject:"",department_id:"",priority:"medium",message:""}),M=async()=>{var e,t;try{C.value=null,await s.fetchTickets(),z.info("[SUPPORT] Tickets chargÃ©s depuis le store",{count:s.tickets.length})}catch(n){z.error("[SUPPORT] Erreur lors du chargement des tickets",{error:n}),C.value=(null==(t=null==(e=n.response)?void 0:e.data)?void 0:t.message)||"Erreur lors du chargement des tickets"}},P=async()=>{try{const e=await F.routes.client.department.list();c.value=e.data,z.info("[SUPPORT] DÃ©partements chargÃ©s",{count:c.value.length})}catch(e){z.error("[SUPPORT] Erreur lors du chargement des dÃ©partements",{error:e}),c.value=[{id:1,name:"Support Technique",description:"ProblÃ¨mes techniques",email:"tech@tech-tik.com",active:!0,created_at:"",updated_at:""},{id:2,name:"Facturation",description:"Questions de facturation",email:"billing@tech-tik.com",active:!0,created_at:"",updated_at:""},{id:3,name:"Commercial",description:"Questions commerciales",email:"sales@tech-tik.com",active:!0,created_at:"",updated_at:""}]}},D=a(()=>{let e=s.tickets;return f.value&&(e=e.filter(e=>e.status===f.value)),g.value&&(e=e.filter(e=>e.priority===g.value)),e.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime())}),U=()=>{},x=e=>({open:"Ouvert",answered:"RÃ©pondu","customer-reply":"En attente",closed:"FermÃ©"}[e]||e),B=Js,H=e=>{if(!e)return"fas fa-ticket-alt";return{"Support Technique":"fas fa-cog",Technique:"fas fa-cog",Facturation:"fas fa-euro-sign",Commercial:"fas fa-handshake","GÃ©nÃ©ral":"fas fa-question-circle",Demande:"fas fa-hand-paper"}[e]||"fas fa-ticket-alt"},q=()=>{b.value=!1,R.value="",C.value=null,I.value={subject:"",department_id:"",priority:"medium",message:""}},G=async()=>{var e,t;if(I.value.subject&&I.value.message)try{S.value=!0,C.value=null,z.info("[SUPPORT] CrÃ©ation du ticket",{subject:I.value.subject,priority:I.value.priority});const e={subject:I.value.subject,message:I.value.message,priority:I.value.priority,department_id:I.value.department_id?parseInt(I.value.department_id):void 0};await F.routes.client.ticket.create(e),R.value="Ticket crÃ©Ã© avec succÃ¨s",q(),await s.refreshTickets()}catch(n){z.error("[SUPPORT] Erreur lors de la crÃ©ation du ticket",{error:n,ticketData:I.value}),C.value=(null==(t=null==(e=n.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la crÃ©ation du ticket"}finally{S.value=!1}else C.value="Veuillez remplir tous les champs obligatoires"};return l(async()=>{await Promise.all([M(),P()]),await(async()=>{var e;const t=null==(e=r.user)?void 0:e.id;if(t)if(n.initialized)await n.subscribeToDashboardEvents(t),n.registerDashboardHandler("ticket-page",s.handleTicketUpdate),z.info("[SUPPORT VIEW] Handler temps rÃ©el enregistrÃ© avec clÃ© ticket-page",{clientId:t});else{const e=n.$subscribe((i,a)=>{a.initialized&&(n.subscribeToDashboardEvents(t).then(()=>{n.registerDashboardHandler("ticket-page",s.handleTicketUpdate),z.info("[SUPPORT VIEW] Handler temps rÃ©el enregistrÃ© (aprÃ¨s initialisation) avec clÃ© ticket-page",{clientId:t})}),e())})}else z.error("[SUPPORT VIEW] ID client manquant - abandon initialisation temps rÃ©el",{user:r.user})})()}),u(()=>{n.unregisterDashboardHandler("ticket-page"),z.info("[SUPPORT VIEW] Handler temps rÃ©el supprimÃ© avec clÃ© ticket-page")}),(e,n)=>(h(),d("div",ji,[p("div",Fi,[p("h1",null,[n[11]||(n[11]=p("i",{class:"fas fa-headset"},null,-1)),L(" "+m(e.$t("support.title")),1)]),p("div",$i,[n[13]||(n[13]=p("button",{class:"btn btn-outline btn-sm"},[p("i",{class:"fas fa-book"}),L(" Base de connaissances ")],-1)),p("button",{class:"btn btn-primary btn-sm",onClick:n[0]||(n[0]=e=>b.value=!0)},[n[12]||(n[12]=p("i",{class:"fas fa-plus"},null,-1)),L(" "+m(e.$t("support.new_ticket")),1)])])]),p("div",Wi,[p("div",{class:"action-card",onClick:n[1]||(n[1]=e=>b.value=!0)},[n[14]||(n[14]=p("div",{class:"action-icon"},[p("i",{class:"fas fa-plus"})],-1)),p("div",zi,m(e.$t("support.create_ticket")),1),p("div",Ji,m(e.$t("support.create_ticket_desc")),1)]),p("div",Ki,[n[15]||(n[15]=p("div",{class:"action-icon"},[p("i",{class:"fas fa-book"})],-1)),p("div",Yi,m(e.$t("support.knowledge_base")),1),p("div",Qi,m(e.$t("support.knowledge_base_desc")),1)]),p("div",Xi,[n[16]||(n[16]=p("div",{class:"action-icon"},[p("i",{class:"fas fa-comments"})],-1)),p("div",Zi,m(e.$t("support.live_chat")),1),p("div",ea,m(e.$t("support.live_chat_desc")),1)]),p("div",ta,[n[17]||(n[17]=p("div",{class:"action-icon"},[p("i",{class:"fas fa-phone"})],-1)),p("div",sa,m(e.$t("support.phone_support")),1),p("div",na,m(e.$t("support.phone_support_desc")),1)])]),p("div",ia,[p("div",aa,[p("div",ra,[n[20]||(n[20]=p("h3",{class:"tickets-title"},[p("i",{class:"fas fa-ticket-alt"}),L(" Mes Tickets de Support ")],-1)),p("div",oa,[O(p("select",{"onUpdate:modelValue":n[2]||(n[2]=e=>f.value=e),class:"filter-select",onChange:U},n[18]||(n[18]=[T('<option value="" data-v-df8ea63a>Tous les statuts</option><option value="open" data-v-df8ea63a>Ouvert</option><option value="in-progress" data-v-df8ea63a>En cours</option><option value="resolved" data-v-df8ea63a>RÃ©solu</option><option value="closed" data-v-df8ea63a>FermÃ©</option>',5)]),544),[[N,f.value]]),O(p("select",{"onUpdate:modelValue":n[3]||(n[3]=e=>g.value=e),class:"filter-select",onChange:U},n[19]||(n[19]=[T('<option value="" data-v-df8ea63a>Toutes les prioritÃ©s</option><option value="low" data-v-df8ea63a>Faible</option><option value="medium" data-v-df8ea63a>Moyenne</option><option value="high" data-v-df8ea63a>Haute</option><option value="urgent" data-v-df8ea63a>Urgente</option>',5)]),544),[[N,g.value]])])]),A(s).loading?(h(),d("div",ca,n[21]||(n[21]=[p("i",{class:"fas fa-spinner fa-spin"},null,-1),p("p",null,"Chargement de vos tickets...",-1)]))):C.value?(h(),d("div",la,[n[23]||(n[23]=p("i",{class:"fas fa-exclamation-triangle"},null,-1)),n[24]||(n[24]=p("h3",null,"Erreur de chargement",-1)),p("p",null,m(C.value),1),p("button",{class:"btn btn-primary",onClick:n[4]||(n[4]=e=>M())},n[22]||(n[22]=[p("i",{class:"fas fa-redo"},null,-1),L(" RÃ©essayer ")]))])):0===D.value.length?(h(),d("div",ua,[n[26]||(n[26]=p("i",{class:"fas fa-ticket-alt"},null,-1)),n[27]||(n[27]=p("h3",null,"Aucun ticket trouvÃ©",-1)),p("p",null,m(y.value||f.value||g.value?"Aucun ticket ne correspond Ã  vos critÃ¨res.":"Vous n'avez pas encore de tickets de support."),1),p("button",{class:"btn btn-primary",onClick:n[5]||(n[5]=e=>b.value=!0)},n[25]||(n[25]=[p("i",{class:"fas fa-plus"},null,-1),L(" CrÃ©er votre premier ticket ")]))])):(h(),d("div",da,[(h(!0),d(w,null,_(D.value,e=>{return h(),d("div",{key:e.id,class:"ticket-item"},[p("div",ha,[p("div",pa,[p("i",{class:v(H(e.department_name))},null,2)]),p("div",fa,[p("div",ga,[p("a",{href:"#",onClick:k(s=>{return n=e.id,void t.push(`/support/ticket/${n}`);var n},["prevent"])},m(e.title),9,va)]),p("div",ma," #"+m(e.id)+" â¢ "+m(e.department_name||"GÃ©nÃ©ral"),1)])]),p("div",ya,[p("div",ba,m(A(B)(e.created_at)),1),p("div",wa,[p("span",{class:v((s=e.status,{open:"status-badge status-open","in-progress":"status-badge status-in-progress",resolved:"status-badge status-resolved",closed:"status-badge status-closed"}[s]||"status-badge"))},m(x(e.status)),3)])])]);var s}),128))]))])]),p("div",{class:v(["modal-overlay",{show:b.value}]),onClick:q},[p("div",{class:"modal-content",onClick:n[10]||(n[10]=k(()=>{},["stop"]))},[p("div",{class:"modal-header"},[n[29]||(n[29]=p("h3",{class:"modal-title"},"CrÃ©er un Nouveau Ticket",-1)),p("button",{class:"modal-close",onClick:q},n[28]||(n[28]=[p("i",{class:"fas fa-times"},null,-1)]))]),p("form",{onSubmit:k(G,["prevent"])},[p("div",_a,[n[30]||(n[30]=p("label",{class:"form-label"},"Sujet",-1)),O(p("input",{"onUpdate:modelValue":n[6]||(n[6]=e=>I.value.subject=e),type:"text",class:"form-input",placeholder:"DÃ©crivez briÃ¨vement votre problÃ¨me...",required:""},null,512),[[E,I.value.subject]])]),p("div",ka,[n[32]||(n[32]=p("label",{class:"form-label"},"DÃ©partement",-1)),O(p("select",{"onUpdate:modelValue":n[7]||(n[7]=e=>I.value.department_id=e),class:"form-select",required:""},[n[31]||(n[31]=p("option",{value:""},"SÃ©lectionnez un dÃ©partement",-1)),(h(!0),d(w,null,_(c.value,e=>(h(),d("option",{key:e.id,value:e.id.toString()},m(e.name),9,Sa))),128))],512),[[N,I.value.department_id]])]),p("div",Ra,[n[34]||(n[34]=p("label",{class:"form-label"},"PrioritÃ©",-1)),O(p("select",{"onUpdate:modelValue":n[8]||(n[8]=e=>I.value.priority=e),class:"form-select",required:""},n[33]||(n[33]=[T('<option value="" data-v-df8ea63a>SÃ©lectionnez une prioritÃ©</option><option value="low" data-v-df8ea63a>Faible</option><option value="medium" data-v-df8ea63a>Moyenne</option><option value="high" data-v-df8ea63a>Haute</option><option value="urgent" data-v-df8ea63a>Urgente</option>',5)]),512),[[N,I.value.priority]])]),p("div",Ca,[n[35]||(n[35]=p("label",{class:"form-label"},"Description",-1)),O(p("textarea",{"onUpdate:modelValue":n[9]||(n[9]=e=>I.value.message=e),class:"form-textarea",placeholder:"DÃ©crivez votre problÃ¨me en dÃ©tail...",required:""},null,512),[[E,I.value.message]])]),p("div",{class:"modal-actions"},[p("button",{type:"button",class:"btn btn-outline",onClick:q}," Annuler "),n[36]||(n[36]=p("button",{type:"submit",class:"btn btn-primary"},[p("i",{class:"fas fa-paper-plane"}),L(" CrÃ©er le Ticket ")],-1))])],32)])],2)]))}}),[["__scopeId","data-v-df8ea63a"]]),Ea={id:"client-account"},Aa={class:"account-header"},Ta={class:"account-actions"},Ia={class:"btn btn-outline btn-sm"},Ma={key:0,class:"success-message"},Pa={key:1,class:"error-message"},La={class:"account-grid"},Na={class:"account-card"},Da={class:"card-header"},Ua={class:"card-title"},xa={class:"card-body"},Ba={class:"profile-avatar"},Ha={class:"avatar-container"},qa={key:0,class:"avatar-upload"},Ga={class:"profile-info"},Va={class:"form-row"},ja={class:"form-group"},Fa=["disabled"],$a={class:"form-group"},Wa=["disabled"],za={class:"form-group"},Ja=["disabled"],Ka={class:"form-row"},Ya={class:"form-group"},Qa=["disabled"],Xa={class:"form-group"},Za=["disabled"],er={class:"form-group"},tr=["disabled"],sr={class:"form-row"},nr={class:"form-group"},ir=["disabled"],ar={class:"form-group"},rr=["disabled"],or={class:"form-group"},cr=["disabled"],lr={key:0,class:"form-actions"},ur=["disabled"],dr={key:0,class:"fas fa-spinner fa-spin"},hr={key:1,class:"fas fa-save"},pr={class:"account-card"},fr={class:"card-body"},gr={class:"security-item"},vr={class:"security-status"},mr={class:"account-card"},yr={class:"card-body"},br={class:"notification-item"},wr={class:"notification-item"},_r={class:"notification-item"},kr={class:"notification-item"},Sr={class:"modal-header"},Rr={class:"modal-body"},Cr={class:"form-group"},Or={class:"form-group"},Er={class:"form-group"},Ar={class:"modal-actions"},Tr=["disabled"],Ir={key:0,class:"fas fa-spinner fa-spin"},Mr={key:1,class:"fas fa-save"},Pr=qe(r({__name:"AccountView",setup(e){const t=i(!0),s=i(!1),n=i(!1),a=i(!1),r=i(""),o=i(""),c=i({current_password:"",new_password:"",confirm_password:""}),u=D({firstName:"",lastName:"",email:"",phone:"",company:"",address:"",city:"",zipCode:"",country:"",createdAt:""}),f=i({...u}),y=D({email:!0,billing:!0,services:!0,marketing:!1}),b=Ks,w=e=>{const t={FR:"France",BE:"Belgique",CH:"Suisse",CA:"Canada",US:"Ãtats-Unis",LU:"Luxembourg",MC:"Monaco"};return t[e]?t[e]:e},_=async()=>{var e,t;if(s.value){n.value=!0,o.value="";try{const e={firstname:u.firstName,lastname:u.lastName,email:u.email,phone:u.phone,company:u.company,address:u.address,city:u.city,postal_code:u.zipCode,country:u.country};await F.routes.client.profile.update(e),f.value={...u},s.value=!1,r.value="Profil mis Ã  jour avec succÃ¨s !",setTimeout(()=>{r.value=""},3e3)}catch(i){o.value=(null==(t=null==(e=i.response)?void 0:e.data)?void 0:t.message)||"Erreur lors de la sauvegarde. Veuillez rÃ©essayer.",setTimeout(()=>{o.value=""},5e3)}finally{n.value=!1}}},S=()=>{Object.assign(u,f.value),s.value=!1,o.value=""},R=async()=>{var e,t;if(c.value.new_password===c.value.confirm_password)if(c.value.new_password.length<8)o.value="Le mot de passe doit contenir au moins 8 caractÃ¨res";else{n.value=!0,r.value="",o.value="";try{await F.routes.client.profile.changePassword({current_password:c.value.current_password,new_password:c.value.new_password}),r.value="Mot de passe changÃ© avec succÃ¨s",a.value=!1,c.value={current_password:"",new_password:"",confirm_password:""},setTimeout(()=>{r.value=""},3e3)}catch(s){o.value=(null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||"Erreur lors du changement de mot de passe"}finally{n.value=!1}}else o.value="Les mots de passe ne correspondent pas"},C=e=>{y[e]=!y[e],r.value="PrÃ©fÃ©rences de notification mises Ã  jour",setTimeout(()=>{r.value=""},2e3)},I=()=>{const e=JSON.stringify(u,null,2),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="mon-profil.json",n.click(),URL.revokeObjectURL(s)};return l(()=>{(async()=>{var e,s;try{t.value=!0,o.value="";const e=(await F.routes.client.profile.get()).data;u.firstName=e.firstname,u.lastName=e.lastname,u.email=e.email,u.phone=e.phone||"",u.company=e.company||"",u.address=e.address||"",u.city=e.city||"",u.zipCode=e.postal_code||"",u.country=w(e.country||""),u.createdAt=e.created_at,f.value={...u}}catch(n){o.value=(null==(s=null==(e=n.response)?void 0:e.data)?void 0:s.message)||"Erreur lors du chargement du profil"}finally{t.value=!1}})()}),(e,t)=>(h(),d("div",Ea,[p("div",Aa,[p("h1",null,[t[22]||(t[22]=p("i",{class:"fas fa-user-cog"},null,-1)),L(" "+m(e.$t("account.title")),1)]),p("div",Ta,[p("button",Ia,[t[23]||(t[23]=p("i",{class:"fas fa-download"},null,-1)),L(" "+m(e.$t("common.export"))+" mes donnÃ©es ",1)]),p("button",{class:"btn btn-primary btn-sm",onClick:_},[t[24]||(t[24]=p("i",{class:"fas fa-save"},null,-1)),L(" "+m(e.$t("common.save")),1)])])]),r.value?(h(),d("div",Ma,[t[25]||(t[25]=p("i",{class:"fas fa-check-circle"},null,-1)),L(" "+m(r.value),1)])):g("",!0),o.value?(h(),d("div",Pa,[t[26]||(t[26]=p("i",{class:"fas fa-exclamation-triangle"},null,-1)),L(" "+m(o.value),1)])):g("",!0),p("div",La,[p("div",Na,[p("div",Da,[p("h3",Ua,[t[27]||(t[27]=p("i",{class:"fas fa-user"},null,-1)),L(" "+m(e.$t("account.personal_info")),1)]),p("button",{class:"btn btn-outline btn-sm",onClick:t[0]||(t[0]=e=>s.value=!s.value)},[p("i",{class:v(s.value?"fas fa-times":"fas fa-edit")},null,2),L(" "+m(s.value?e.$t("common.cancel"):e.$t("common.edit")),1)])]),p("div",xa,[p("div",Ba,[p("div",Ha,[t[29]||(t[29]=p("div",{class:"avatar-image"},[p("i",{class:"fas fa-user"})],-1)),s.value?(h(),d("div",qa,t[28]||(t[28]=[p("i",{class:"fas fa-camera"},null,-1)]))):g("",!0)]),p("div",Ga,[p("h3",null,m(u.firstName)+" "+m(u.lastName),1),p("p",null,m(e.$t("account.member_since"))+" "+m(A(b)(u.createdAt)),1)])]),p("form",{onSubmit:k(_,["prevent"])},[p("div",Va,[p("div",ja,[t[30]||(t[30]=p("label",{class:"form-label"},"PrÃ©nom",-1)),O(p("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>u.firstName=e),type:"text",class:"form-input",disabled:!s.value,required:""},null,8,Fa),[[E,u.firstName]])]),p("div",$a,[t[31]||(t[31]=p("label",{class:"form-label"},"Nom",-1)),O(p("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>u.lastName=e),type:"text",class:"form-input",disabled:!s.value,required:""},null,8,Wa),[[E,u.lastName]])])]),p("div",za,[t[32]||(t[32]=p("label",{class:"form-label"},"Email",-1)),O(p("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>u.email=e),type:"email",class:"form-input",disabled:!s.value,required:""},null,8,Ja),[[E,u.email]])]),p("div",Ka,[p("div",Ya,[t[33]||(t[33]=p("label",{class:"form-label"},"TÃ©lÃ©phone",-1)),O(p("input",{"onUpdate:modelValue":t[4]||(t[4]=e=>u.phone=e),type:"tel",class:"form-input",disabled:!s.value},null,8,Qa),[[E,u.phone]])]),p("div",Xa,[t[34]||(t[34]=p("label",{class:"form-label"},"SociÃ©tÃ©",-1)),O(p("input",{"onUpdate:modelValue":t[5]||(t[5]=e=>u.company=e),type:"text",class:"form-input",disabled:!s.value},null,8,Za),[[E,u.company]])])]),p("div",er,[t[35]||(t[35]=p("label",{class:"form-label"},"Adresse",-1)),O(p("input",{"onUpdate:modelValue":t[6]||(t[6]=e=>u.address=e),type:"text",class:"form-input",disabled:!s.value},null,8,tr),[[E,u.address]])]),p("div",sr,[p("div",nr,[t[36]||(t[36]=p("label",{class:"form-label"},"Ville",-1)),O(p("input",{"onUpdate:modelValue":t[7]||(t[7]=e=>u.city=e),type:"text",class:"form-input",disabled:!s.value},null,8,ir),[[E,u.city]])]),p("div",ar,[t[37]||(t[37]=p("label",{class:"form-label"},"Code Postal",-1)),O(p("input",{"onUpdate:modelValue":t[8]||(t[8]=e=>u.zipCode=e),type:"text",class:"form-input",disabled:!s.value},null,8,rr),[[E,u.zipCode]])])]),p("div",or,[t[39]||(t[39]=p("label",{class:"form-label"},"Pays",-1)),O(p("select",{"onUpdate:modelValue":t[9]||(t[9]=e=>u.country=e),class:"form-select",disabled:!s.value},t[38]||(t[38]=[T('<option value="" data-v-bf9f5224>SÃ©lectionnez un pays</option><option value="France" data-v-bf9f5224>France</option><option value="Belgique" data-v-bf9f5224>Belgique</option><option value="Suisse" data-v-bf9f5224>Suisse</option><option value="Canada" data-v-bf9f5224>Canada</option><option value="Ãtats-Unis" data-v-bf9f5224>Ãtats-Unis</option><option value="Luxembourg" data-v-bf9f5224>Luxembourg</option><option value="Monaco" data-v-bf9f5224>Monaco</option>',8)]),8,cr),[[N,u.country]])]),s.value?(h(),d("div",lr,[p("button",{type:"button",class:"btn btn-outline",onClick:S}," Annuler "),p("button",{type:"submit",class:"btn btn-primary",disabled:n.value},[n.value?(h(),d("i",dr)):(h(),d("i",hr)),L(" "+m(n.value?"Sauvegarde...":"Sauvegarder"),1)],8,ur)])):g("",!0)],32)])]),p("div",pr,[t[43]||(t[43]=p("div",{class:"card-header"},[p("h3",{class:"card-title"},[p("i",{class:"fas fa-shield-alt"}),L(" SÃ©curitÃ© ")])],-1)),p("div",fr,[p("div",gr,[t[41]||(t[41]=p("div",{class:"security-info"},[p("div",{class:"security-icon"},[p("i",{class:"fas fa-key"})]),p("div",{class:"security-details"},[p("h4",null,"Mot de passe"),p("p",null,"DerniÃ¨re modification il y a 3 mois")])],-1)),p("div",vr,[t[40]||(t[40]=p("div",{class:"status-indicator status-warning"},null,-1)),p("button",{class:"btn btn-outline btn-sm",onClick:t[10]||(t[10]=e=>a.value=!0)}," Modifier ")])]),t[42]||(t[42]=T('<div class="security-item" data-v-bf9f5224><div class="security-info" data-v-bf9f5224><div class="security-icon" data-v-bf9f5224><i class="fas fa-mobile-alt" data-v-bf9f5224></i></div><div class="security-details" data-v-bf9f5224><h4 data-v-bf9f5224>Authentification Ã  deux facteurs</h4><p data-v-bf9f5224>Protection supplÃ©mentaire de votre compte</p></div></div><div class="security-status" data-v-bf9f5224><div class="status-indicator status-inactive" data-v-bf9f5224></div><button class="btn btn-primary btn-sm" data-v-bf9f5224> Activer </button></div></div><div class="security-item" data-v-bf9f5224><div class="security-info" data-v-bf9f5224><div class="security-icon" data-v-bf9f5224><i class="fas fa-history" data-v-bf9f5224></i></div><div class="security-details" data-v-bf9f5224><h4 data-v-bf9f5224>Historique de connexion</h4><p data-v-bf9f5224>DerniÃ¨re connexion: Aujourd&#39;hui Ã  14:30</p></div></div><div class="security-status" data-v-bf9f5224><div class="status-indicator status-active" data-v-bf9f5224></div><button class="btn btn-outline btn-sm" data-v-bf9f5224> Voir l&#39;historique </button></div></div>',2))])])]),p("div",mr,[t[48]||(t[48]=p("div",{class:"card-header"},[p("h3",{class:"card-title"},[p("i",{class:"fas fa-bell"}),L(" PrÃ©fÃ©rences de Notification ")])],-1)),p("div",yr,[p("div",br,[t[44]||(t[44]=p("div",{class:"notification-info"},[p("div",{class:"notification-title"},"Notifications par email"),p("div",{class:"notification-description"},"Recevoir les notifications importantes par email")],-1)),p("div",{class:v(["toggle-switch",{active:y.email}]),onClick:t[11]||(t[11]=e=>C("email"))},null,2)]),p("div",wr,[t[45]||(t[45]=p("div",{class:"notification-info"},[p("div",{class:"notification-title"},"Alertes de facturation"),p("div",{class:"notification-description"},"Ãtre notifiÃ© des nouvelles factures et Ã©chÃ©ances")],-1)),p("div",{class:v(["toggle-switch",{active:y.billing}]),onClick:t[12]||(t[12]=e=>C("billing"))},null,2)]),p("div",_r,[t[46]||(t[46]=p("div",{class:"notification-info"},[p("div",{class:"notification-title"},"Mises Ã  jour de services"),p("div",{class:"notification-description"},"Recevoir les informations sur vos services")],-1)),p("div",{class:v(["toggle-switch",{active:y.services}]),onClick:t[13]||(t[13]=e=>C("services"))},null,2)]),p("div",kr,[t[47]||(t[47]=p("div",{class:"notification-info"},[p("div",{class:"notification-title"},"Newsletter marketing"),p("div",{class:"notification-description"},"Recevoir nos offres et actualitÃ©s")],-1)),p("div",{class:v(["toggle-switch",{active:y.marketing}]),onClick:t[14]||(t[14]=e=>C("marketing"))},null,2)])])]),p("div",{class:"account-card"},[t[52]||(t[52]=p("div",{class:"card-header"},[p("h3",{class:"card-title"},[p("i",{class:"fas fa-exclamation-triangle"}),L(" Zone de Danger ")])],-1)),p("div",{class:"card-body"},[t[51]||(t[51]=p("p",{style:{color:"var(--text-muted)","margin-bottom":"1rem"}}," Ces actions sont irrÃ©versibles. ProcÃ©dez avec prudence. ",-1)),p("div",{style:{display:"flex",gap:"1rem","flex-wrap":"wrap"}},[p("button",{class:"btn btn-outline btn-sm",onClick:I},t[49]||(t[49]=[p("i",{class:"fas fa-download"},null,-1),L(" Exporter toutes mes donnÃ©es ")])),t[50]||(t[50]=p("button",{class:"btn btn-danger btn-sm"},[p("i",{class:"fas fa-user-times"}),L(" Supprimer mon compte ")],-1))])])]),a.value?(h(),d("div",{key:2,class:"modal show",onClick:t[21]||(t[21]=e=>a.value=!1)},[t[59]||(t[59]=p("div",{class:"modal-backdrop"},null,-1)),p("div",{class:"modal-content",onClick:t[20]||(t[20]=k(()=>{},["stop"]))},[p("div",Sr,[t[54]||(t[54]=p("h3",null,[p("i",{class:"fas fa-key"}),L(" Changer le mot de passe ")],-1)),p("button",{class:"modal-close",onClick:t[15]||(t[15]=e=>a.value=!1)},t[53]||(t[53]=[p("i",{class:"fas fa-times"},null,-1)]))]),p("div",Rr,[p("form",{onSubmit:k(R,["prevent"])},[p("div",Cr,[t[55]||(t[55]=p("label",{for:"current_password"},"Mot de passe actuel",-1)),O(p("input",{id:"current_password","onUpdate:modelValue":t[16]||(t[16]=e=>c.value.current_password=e),type:"password",class:"form-input",required:"",autocomplete:"current-password"},null,512),[[E,c.value.current_password]])]),p("div",Or,[t[56]||(t[56]=p("label",{for:"new_password"},"Nouveau mot de passe",-1)),O(p("input",{id:"new_password","onUpdate:modelValue":t[17]||(t[17]=e=>c.value.new_password=e),type:"password",class:"form-input",required:"",minlength:"8",autocomplete:"new-password"},null,512),[[E,c.value.new_password]]),t[57]||(t[57]=p("small",{class:"form-help"},"Minimum 8 caractÃ¨res",-1))]),p("div",Er,[t[58]||(t[58]=p("label",{for:"confirm_password"},"Confirmer le nouveau mot de passe",-1)),O(p("input",{id:"confirm_password","onUpdate:modelValue":t[18]||(t[18]=e=>c.value.confirm_password=e),type:"password",class:"form-input",required:"",autocomplete:"new-password"},null,512),[[E,c.value.confirm_password]])]),p("div",Ar,[p("button",{type:"button",class:"btn btn-outline",onClick:t[19]||(t[19]=e=>a.value=!1)}," Annuler "),p("button",{type:"submit",class:"btn btn-primary",disabled:n.value},[n.value?(h(),d("i",Ir)):(h(),d("i",Mr)),L(" "+m(n.value?"Sauvegarde...":"Changer le mot de passe"),1)],8,Tr)])],32)])])])):g("",!0)]))}}),[["__scopeId","data-v-bf9f5224"]]),Lr={class:"auth-container"},Nr={class:"auth-card"},Dr={key:0,class:"form-error"},Ur={key:0,class:"form-error"},xr={class:"auth-options"},Br={class:"remember-me"},Hr={key:0,class:"form-error"},qr=["disabled"],Gr={key:0,class:"loading-spinner"},Vr={class:"auth-links"},jr=r({__name:"LoginView",setup(e){const t=o(),s=re(),n=i(!1),r=i({email:"",password:"",remember:!1}),c=i({email:"",password:"",general:""}),u=a(()=>r.value.email&&r.value.password&&!c.value.email&&!c.value.password),y=()=>{r.value.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.value.email)?c.value.email="":c.value.email="Format d'email invalide":c.value.email="L'adresse email est requise"},w=()=>{r.value.password?r.value.password.length<6?c.value.password="Le mot de passe doit contenir au moins 6 caractÃ¨res":c.value.password="":c.value.password="Le mot de passe est requis"},_=e=>{c.value[e]&&(c.value[e]=""),c.value.general&&(c.value.general="")},S=async()=>{var e,i,a;if(y(),w(),u.value){n.value=!0,c.value.general="";try{await s.login(r.value.email,r.value.password,r.value.remember);const e=t.currentRoute.value.query.redirect||"/dashboard";await t.push(e)}catch(o){z.error("[AUTH] Erreur de connexion",{error:o,email:r.value.email}),401===(null==(e=o.response)?void 0:e.status)?c.value.general="Email ou mot de passe incorrect":403===(null==(i=o.response)?void 0:i.status)?c.value.general="Compte suspendu ou inactif":(null==(a=o.response)?void 0:a.status)>=500?c.value.general="Erreur serveur. Veuillez rÃ©essayer plus tard.":c.value.general=o.message||"Une erreur est survenue lors de la connexion"}finally{n.value=!1}}};return l(async()=>{s.isAuthenticated&&await t.push("/dashboard")}),(e,t)=>{const s=C("router-link");return h(),d("div",Lr,[p("div",Nr,[t[14]||(t[14]=T('<div class="auth-header"><div class="auth-logo"><i class="fas fa-user-circle"></i></div><h1 class="auth-title">Connexion Client</h1><p class="auth-subtitle">AccÃ©dez Ã  votre espace client TechCMS</p></div>',1)),p("form",{onSubmit:k(S,["prevent"]),class:"auth-form"},[p("div",{class:v(["form-group",{error:c.value.email,valid:!c.value.email&&r.value.email}])},[t[6]||(t[6]=p("label",{for:"email",class:"form-label"},[p("i",{class:"fas fa-envelope"}),L(" Adresse email ")],-1)),O(p("input",{id:"email","onUpdate:modelValue":t[0]||(t[0]=e=>r.value.email=e),type:"email",class:v(["form-input",{error:c.value.email}]),placeholder:"votre@email.com",required:"",autocomplete:"email",onBlur:y,onInput:t[1]||(t[1]=e=>_("email"))},null,34),[[E,r.value.email]]),c.value.email?(h(),d("div",Dr,[t[5]||(t[5]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(c.value.email),1)])):g("",!0)],2),p("div",{class:v(["form-group",{error:c.value.password,valid:!c.value.password&&r.value.password}])},[t[8]||(t[8]=p("label",{for:"password",class:"form-label"},[p("i",{class:"fas fa-lock"}),L(" Mot de passe ")],-1)),O(p("input",{id:"password","onUpdate:modelValue":t[2]||(t[2]=e=>r.value.password=e),type:"password",class:v(["form-input",{error:c.value.password}]),placeholder:"Votre mot de passe",required:"",autocomplete:"current-password",onBlur:w,onInput:t[3]||(t[3]=e=>_("password"))},null,34),[[E,r.value.password]]),c.value.password?(h(),d("div",Ur,[t[7]||(t[7]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(c.value.password),1)])):g("",!0)],2),p("div",xr,[p("label",Br,[O(p("input",{"onUpdate:modelValue":t[4]||(t[4]=e=>r.value.remember=e),type:"checkbox"},null,512),[[U,r.value.remember]]),t[9]||(t[9]=L(" Se souvenir de moi "))]),f(s,{to:"/forgot-password",class:"forgot-password"},{default:b(()=>t[10]||(t[10]=[L(" Mot de passe oubliÃ© ? ")])),_:1,__:[10]})]),c.value.general?(h(),d("div",Hr,[t[11]||(t[11]=p("i",{class:"fas fa-exclamation-triangle"},null,-1)),L(" "+m(c.value.general),1)])):g("",!0),p("button",{type:"submit",class:v(["auth-button",{loading:n.value}]),disabled:n.value||!u.value},[n.value?(h(),d("span",Gr)):g("",!0),L(" "+m(n.value?"Connexion...":"Se connecter"),1)],10,qr)],32),p("div",Vr,[p("p",null,[t[13]||(t[13]=L(" Pas encore de compte ? ")),f(s,{to:"/register",class:"auth-link"},{default:b(()=>t[12]||(t[12]=[L(" CrÃ©er un compte ")])),_:1,__:[12]})])])])])}}}),Fr={class:"auth-container"},$r={class:"auth-card"},Wr={class:"form-row"},zr={key:0,class:"form-error"},Jr={key:0,class:"form-error"},Kr={key:0,class:"form-error"},Yr={class:"form-row"},Qr={key:0,class:"form-error"},Xr={key:0,class:"form-error"},Zr={class:"form-row"},eo={key:0,class:"form-error"},to={key:0,class:"form-error"},so={key:0,class:"form-error"},no={class:"form-row"},io={key:0,class:"form-error"},ao={key:0,class:"form-error"},ro={class:"remember-me"},oo={key:0,class:"form-error"},co={key:0,class:"form-error"},lo={key:1,class:"form-success"},uo=["disabled"],ho={key:0,class:"loading-spinner"},po={class:"auth-links"},fo=r({__name:"RegisterView",setup(e){const t=o(),s=re(),n=i(!1),r=i(""),c=i({firstname:"",lastname:"",email:"",company:"",phone:"",address:"",postal_code:"",city:"",country:"",password:"",passwordConfirmation:"",acceptTerms:!1}),l=i({firstname:"",lastname:"",email:"",company:"",phone:"",address:"",postal_code:"",city:"",country:"",password:"",passwordConfirmation:"",terms:"",general:""}),u=a(()=>c.value.firstname&&c.value.lastname&&c.value.email&&c.value.phone&&c.value.address&&c.value.postal_code&&c.value.city&&c.value.country&&c.value.password&&c.value.passwordConfirmation&&c.value.acceptTerms&&!Object.values(l.value).some(e=>""!==e)),y=()=>{c.value.firstname.trim()?c.value.firstname.trim().length<2?l.value.firstname="Le prÃ©nom doit contenir au moins 2 caractÃ¨res":l.value.firstname="":l.value.firstname="Le prÃ©nom est requis"},w=()=>{c.value.lastname.trim()?c.value.lastname.trim().length<2?l.value.lastname="Le nom doit contenir au moins 2 caractÃ¨res":l.value.lastname="":l.value.lastname="Le nom est requis"},_=()=>{c.value.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c.value.email)?l.value.email="":l.value.email="Format d'email invalide":l.value.email="L'adresse email est requise"},S=()=>{if(c.value.phone.trim()){/^[\+]?[0-9\s\-\(\)]{10,}$/.test(c.value.phone)?l.value.phone="":l.value.phone="Format de tÃ©lÃ©phone invalide"}else l.value.phone="Le numÃ©ro de tÃ©lÃ©phone est requis"},R=()=>{c.value.address.trim()?c.value.address.trim().length<5?l.value.address="L'adresse doit contenir au moins 5 caractÃ¨res":l.value.address="":l.value.address="L'adresse est requise"},A=()=>{c.value.postal_code.trim()?/^[0-9]{5}$/.test(c.value.postal_code.trim())?l.value.postal_code="":l.value.postal_code="Le code postal doit contenir 5 chiffres":l.value.postal_code="Le code postal est requis"},I=()=>{c.value.city.trim()?c.value.city.trim().length<2?l.value.city="La ville doit contenir au moins 2 caractÃ¨res":l.value.city="":l.value.city="La ville est requise"},M=()=>{c.value.country?l.value.country="":l.value.country="Le pays est requis"},P=()=>{c.value.password?c.value.password.length<8?l.value.password="Le mot de passe doit contenir au moins 8 caractÃ¨res":/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(c.value.password)?l.value.password="":l.value.password="Le mot de passe doit contenir au moins une minuscule, une majuscule et un chiffre":l.value.password="Le mot de passe est requis",c.value.passwordConfirmation&&D()},D=()=>{c.value.passwordConfirmation?c.value.password!==c.value.passwordConfirmation?l.value.passwordConfirmation="Les mots de passe ne correspondent pas":l.value.passwordConfirmation="":l.value.passwordConfirmation="La confirmation du mot de passe est requise"},x=e=>{l.value[e]&&(l.value[e]=""),l.value.general&&(l.value.general="")},B=async()=>{var e,i;if(y(),w(),_(),S(),R(),A(),I(),M(),P(),D(),c.value.acceptTerms?l.value.terms="":l.value.terms="Vous devez accepter les conditions d'utilisation",u.value){n.value=!0,l.value.general="",r.value="";try{z.info("[AUTH] DÃ©but inscription",{email:c.value.email,firstName:c.value.firstName}),await s.register(c.value),z.info("[AUTH] Inscription rÃ©ussie",{email:c.value.email}),r.value="Compte crÃ©Ã© avec succÃ¨s ! Redirection vers la connexion...",setTimeout(()=>{t.push("/client/login")},2e3)}catch(a){z.error("[AUTH] Erreur inscription",{error:a,email:c.value.email}),409===(null==(e=a.response)?void 0:e.status)?l.value.email="Cette adresse email est dÃ©jÃ  utilisÃ©e":(null==(i=a.response)?void 0:i.status)>=500?l.value.general="Erreur serveur. Veuillez rÃ©essayer plus tard.":l.value.general=a.message||"Une erreur est survenue lors de l'inscription"}finally{n.value=!1}}};return(e,t)=>{const s=C("router-link");return h(),d("div",Fr,[p("div",$r,[t[53]||(t[53]=T('<div class="auth-header"><div class="auth-logo"><i class="fas fa-user-plus"></i></div><h1 class="auth-title">CrÃ©er un compte</h1><p class="auth-subtitle">Rejoignez TechCMS et accÃ©dez Ã  nos services</p></div>',1)),p("form",{onSubmit:k(B,["prevent"]),class:"auth-form"},[p("div",Wr,[p("div",{class:v(["form-group",{error:l.value.firstname,valid:!l.value.firstname&&c.value.firstname}])},[t[23]||(t[23]=p("label",{for:"firstname",class:"form-label"},[p("i",{class:"fas fa-user"}),L(" PrÃ©nom ")],-1)),O(p("input",{id:"firstname","onUpdate:modelValue":t[0]||(t[0]=e=>c.value.firstname=e),type:"text",class:v(["form-input",{error:l.value.firstname}]),placeholder:"Votre prÃ©nom",required:"",autocomplete:"given-name",onBlur:y,onInput:t[1]||(t[1]=e=>x("firstname"))},null,34),[[E,c.value.firstname]]),l.value.firstname?(h(),d("div",zr,[t[22]||(t[22]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.firstname),1)])):g("",!0)],2),p("div",{class:v(["form-group",{error:l.value.lastname,valid:!l.value.lastname&&c.value.lastname}])},[t[25]||(t[25]=p("label",{for:"lastname",class:"form-label"},[p("i",{class:"fas fa-user"}),L(" Nom ")],-1)),O(p("input",{id:"lastname","onUpdate:modelValue":t[2]||(t[2]=e=>c.value.lastname=e),type:"text",class:v(["form-input",{error:l.value.lastname}]),placeholder:"Votre nom",required:"",autocomplete:"family-name",onBlur:w,onInput:t[3]||(t[3]=e=>x("lastname"))},null,34),[[E,c.value.lastname]]),l.value.lastname?(h(),d("div",Jr,[t[24]||(t[24]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.lastname),1)])):g("",!0)],2)]),p("div",{class:v(["form-group",{error:l.value.email,valid:!l.value.email&&c.value.email}])},[t[27]||(t[27]=p("label",{for:"email",class:"form-label"},[p("i",{class:"fas fa-envelope"}),L(" Adresse email ")],-1)),O(p("input",{id:"email","onUpdate:modelValue":t[4]||(t[4]=e=>c.value.email=e),type:"email",class:v(["form-input",{error:l.value.email}]),placeholder:"votre@email.com",required:"",autocomplete:"email",onBlur:_,onInput:t[5]||(t[5]=e=>x("email"))},null,34),[[E,c.value.email]]),l.value.email?(h(),d("div",Kr,[t[26]||(t[26]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.email),1)])):g("",!0)],2),p("div",Yr,[p("div",{class:v(["form-group",{error:l.value.phone,valid:!l.value.phone&&c.value.phone}])},[t[29]||(t[29]=p("label",{for:"phone",class:"form-label"},[p("i",{class:"fas fa-phone"}),L(" TÃ©lÃ©phone ")],-1)),O(p("input",{id:"phone","onUpdate:modelValue":t[6]||(t[6]=e=>c.value.phone=e),type:"tel",class:v(["form-input",{error:l.value.phone}]),placeholder:"+33 1 23 45 67 89",required:"",autocomplete:"tel",onBlur:S,onInput:t[7]||(t[7]=e=>x("phone"))},null,34),[[E,c.value.phone]]),l.value.phone?(h(),d("div",Qr,[t[28]||(t[28]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.phone),1)])):g("",!0)],2),p("div",{class:v(["form-group",{error:l.value.company}])},[t[30]||(t[30]=p("label",{for:"company",class:"form-label"},[p("i",{class:"fas fa-building"}),L(" Entreprise (optionnel) ")],-1)),O(p("input",{id:"company","onUpdate:modelValue":t[8]||(t[8]=e=>c.value.company=e),type:"text",class:"form-input",placeholder:"Nom de votre entreprise",autocomplete:"organization"},null,512),[[E,c.value.company]])],2)]),p("div",{class:v(["form-group",{error:l.value.address,valid:!l.value.address&&c.value.address}])},[t[32]||(t[32]=p("label",{for:"address",class:"form-label"},[p("i",{class:"fas fa-map-marker-alt"}),L(" Adresse ")],-1)),O(p("input",{id:"address","onUpdate:modelValue":t[9]||(t[9]=e=>c.value.address=e),type:"text",class:v(["form-input",{error:l.value.address}]),placeholder:"123 Rue de la Paix",required:"",autocomplete:"street-address",onBlur:R,onInput:t[10]||(t[10]=e=>x("address"))},null,34),[[E,c.value.address]]),l.value.address?(h(),d("div",Xr,[t[31]||(t[31]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.address),1)])):g("",!0)],2),p("div",Zr,[p("div",{class:v(["form-group",{error:l.value.postal_code,valid:!l.value.postal_code&&c.value.postal_code}])},[t[34]||(t[34]=p("label",{for:"postal_code",class:"form-label"},[p("i",{class:"fas fa-mail-bulk"}),L(" Code postal ")],-1)),O(p("input",{id:"postal_code","onUpdate:modelValue":t[11]||(t[11]=e=>c.value.postal_code=e),type:"text",class:v(["form-input",{error:l.value.postal_code}]),placeholder:"75001",required:"",autocomplete:"postal-code",onBlur:A,onInput:t[12]||(t[12]=e=>x("postal_code"))},null,34),[[E,c.value.postal_code]]),l.value.postal_code?(h(),d("div",eo,[t[33]||(t[33]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.postal_code),1)])):g("",!0)],2),p("div",{class:v(["form-group",{error:l.value.city,valid:!l.value.city&&c.value.city}])},[t[36]||(t[36]=p("label",{for:"city",class:"form-label"},[p("i",{class:"fas fa-city"}),L(" Ville ")],-1)),O(p("input",{id:"city","onUpdate:modelValue":t[13]||(t[13]=e=>c.value.city=e),type:"text",class:v(["form-input",{error:l.value.city}]),placeholder:"Paris",required:"",autocomplete:"address-level2",onBlur:I,onInput:t[14]||(t[14]=e=>x("city"))},null,34),[[E,c.value.city]]),l.value.city?(h(),d("div",to,[t[35]||(t[35]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.city),1)])):g("",!0)],2)]),p("div",{class:v(["form-group",{error:l.value.country,valid:!l.value.country&&c.value.country}])},[t[39]||(t[39]=p("label",{for:"country",class:"form-label"},[p("i",{class:"fas fa-globe"}),L(" Pays ")],-1)),O(p("select",{id:"country","onUpdate:modelValue":t[15]||(t[15]=e=>c.value.country=e),class:v(["form-input",{error:l.value.country}]),required:"",autocomplete:"country",onBlur:M,onChange:t[16]||(t[16]=e=>x("country"))},t[37]||(t[37]=[T('<option value="">SÃ©lectionnez un pays</option><option value="FR">France</option><option value="BE">Belgique</option><option value="CH">Suisse</option><option value="CA">Canada</option><option value="US">Ãtats-Unis</option><option value="GB">Royaume-Uni</option><option value="DE">Allemagne</option><option value="ES">Espagne</option><option value="IT">Italie</option><option value="NL">Pays-Bas</option>',11)]),34),[[N,c.value.country]]),l.value.country?(h(),d("div",so,[t[38]||(t[38]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.country),1)])):g("",!0)],2),p("div",no,[p("div",{class:v(["form-group",{error:l.value.password,valid:!l.value.password&&c.value.password}])},[t[41]||(t[41]=p("label",{for:"password",class:"form-label"},[p("i",{class:"fas fa-lock"}),L(" Mot de passe ")],-1)),O(p("input",{id:"password","onUpdate:modelValue":t[17]||(t[17]=e=>c.value.password=e),type:"password",class:v(["form-input",{error:l.value.password}]),placeholder:"Choisissez un mot de passe sÃ©curisÃ©",required:"",autocomplete:"new-password",onBlur:P,onInput:t[18]||(t[18]=e=>x("password"))},null,34),[[E,c.value.password]]),l.value.password?(h(),d("div",io,[t[40]||(t[40]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.password),1)])):g("",!0)],2),p("div",{class:v(["form-group",{error:l.value.passwordConfirmation,valid:!l.value.passwordConfirmation&&c.value.passwordConfirmation}])},[t[43]||(t[43]=p("label",{for:"passwordConfirmation",class:"form-label"},[p("i",{class:"fas fa-lock"}),L(" Confirmer le mot de passe ")],-1)),O(p("input",{id:"passwordConfirmation","onUpdate:modelValue":t[19]||(t[19]=e=>c.value.passwordConfirmation=e),type:"password",class:v(["form-input",{error:l.value.passwordConfirmation}]),placeholder:"Confirmez votre mot de passe",required:"",autocomplete:"new-password",onBlur:D,onInput:t[20]||(t[20]=e=>x("passwordConfirmation"))},null,34),[[E,c.value.passwordConfirmation]]),l.value.passwordConfirmation?(h(),d("div",ao,[t[42]||(t[42]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.passwordConfirmation),1)])):g("",!0)],2)]),p("div",{class:v(["form-group",{error:l.value.terms}])},[p("label",ro,[O(p("input",{"onUpdate:modelValue":t[21]||(t[21]=e=>c.value.acceptTerms=e),type:"checkbox",required:""},null,512),[[U,c.value.acceptTerms]]),t[44]||(t[44]=L(" J'accepte les ")),t[45]||(t[45]=p("a",{href:"/terms",target:"_blank",class:"auth-link"},"conditions d'utilisation",-1)),t[46]||(t[46]=L(" et la ")),t[47]||(t[47]=p("a",{href:"/privacy",target:"_blank",class:"auth-link"},"politique de confidentialitÃ©",-1))]),l.value.terms?(h(),d("div",oo,[t[48]||(t[48]=p("i",{class:"fas fa-exclamation-circle"},null,-1)),L(" "+m(l.value.terms),1)])):g("",!0)],2),l.value.general?(h(),d("div",co,[t[49]||(t[49]=p("i",{class:"fas fa-exclamation-triangle"},null,-1)),L(" "+m(l.value.general),1)])):g("",!0),r.value?(h(),d("div",lo,[t[50]||(t[50]=p("i",{class:"fas fa-check-circle"},null,-1)),L(" "+m(r.value),1)])):g("",!0),p("button",{type:"submit",class:v(["auth-button",{loading:n.value}]),disabled:n.value||!u.value},[n.value?(h(),d("span",ho)):g("",!0),L(" "+m(n.value?"CrÃ©ation...":"CrÃ©er mon compte"),1)],10,uo)],32),p("div",po,[p("p",null,[t[52]||(t[52]=L(" DÃ©jÃ  un compte ? ")),f(s,{to:"/auth/login",class:"auth-link"},{default:b(()=>t[51]||(t[51]=[L(" Se connecter ")])),_:1,__:[51]})])])])])}}}),go=x({history:B("/client"),routes:[{path:"/",redirect:"/dashboard"},{path:"/login",name:"login",component:jr,meta:{public:!0,requiresAuth:!1,hideForAuthenticated:!0,hideLayout:!0}},{path:"/register",name:"register",component:fo,meta:{public:!0,requiresAuth:!1,hideForAuthenticated:!0,hideLayout:!0}},{path:"/dashboard",name:"dashboard",component:$s,meta:{public:!1,requiresAuth:!0}},{path:"/services",name:"services",component:Wn,meta:{public:!1,requiresAuth:!0}},{path:"/billing",name:"billing",component:Gi,meta:{public:!1,requiresAuth:!0}},{path:"/support",name:"support",component:Oa,meta:{public:!1,requiresAuth:!0}},{path:"/account",name:"account",component:Pr,meta:{public:!1,requiresAuth:!0}},{path:"/services/:id",name:"service-detail",component:()=>Lt(()=>import("./ServiceDetailView-cq1kZPKg.js"),__vite__mapDeps([0,1,2,3])),meta:{public:!1,requiresAuth:!0}},{path:"/billing/invoice/:id",name:"invoice-detail",component:()=>Lt(()=>import("./InvoiceDetailView-6VX8o2RO.js"),__vite__mapDeps([4,1,2,5])),meta:{public:!1,requiresAuth:!0}},{path:"/support/ticket/:id",name:"ticket-detail",component:()=>Lt(()=>import("./TicketDetailView-6k66qKkC.js"),__vite__mapDeps([6,1,2,7])),meta:{public:!1,requiresAuth:!0}},{path:"/:pathMatch(.*)*",name:"not-found",redirect:"/dashboard"}]});go.beforeEach(async(e,t,s)=>{z.debug("[ROUTER] Navigation",{from:t.path,to:e.path,name:e.name});const n=re();n.initialized||await n.initialize();const i=n.isAuthenticated,a=e.meta.requiresAuth,r=e.meta.hideForAuthenticated;z.debug("[ROUTER] Ãtat d'authentification",{isAuthenticated:i,requiresAuth:a,hideForAuthenticated:r,path:e.path}),!a||i?i&&r?s({name:"dashboard"}):(z.debug("[ROUTER] Navigation autorisÃ©e vers",{path:e.path}),s()):s({name:"login",query:{redirect:e.fullPath}})});const vo={common:{loading:"Chargement...",error:"Une erreur est survenue",save:"Enregistrer",cancel:"Annuler",edit:"Modifier",delete:"Supprimer",view:"Voir",export:"Exporter",search:"Rechercher...",filter:"Filtrer",all:"Toutes",active:"Actif",inactive:"Inactif",status:"Statut",date:"Date",amount:"Montant",back:"Retour",refresh:"Actualiser",download:"TÃ©lÃ©charger",close:"Fermer",open:"Ouvrir",retry:"RÃ©essayer",send:"Envoyer",reply:"RÃ©pondre",month:"mois",year:"annÃ©e",day:"jour",hour:"heure",minute:"minute",second:"seconde"},dashboard:{title:"Tableau de bord",client_interface:"Interface Client",my_services:"Mes Services",unpaid_invoices:"Factures ImpayÃ©es",open_tickets:"Tickets Ouverts",total_due:"Montant DÃ»",recent_services:"Services RÃ©cents",recent_invoices:"Factures RÃ©centes",recent_tickets:"Tickets RÃ©cents",view_all:"Voir tout",no_data:"Aucune donnÃ©e disponible"},notifications:{title:"Notifications",no_notifications:"Aucune notification",mark_read:"Marquer comme lu",mark_all_read:"Tout marquer comme lu",clear_all:"Tout effacer",remove:"Supprimer",view_all:"Voir toutes les notifications",new_service:"Nouveau service activÃ©",service_suspended:"Service suspendu",service_renewed:"Service renouvelÃ©",new_invoice:"Nouvelle facture gÃ©nÃ©rÃ©e",invoice_paid:"Facture payÃ©e",invoice_overdue:"Facture en retard",new_ticket_reply:"Nouvelle rÃ©ponse Ã  votre ticket",ticket_status_changed:"Statut du ticket modifiÃ©",system_maintenance:"Maintenance systÃ¨me programmÃ©e"},services:{title:"Mes Services",new_service:"Nouveau Service",manage:"GÃ©rer",filter_by_status:"Filtrer par statut",no_services:"Aucun service trouvÃ©",service_name:"Nom du service",service_type:"Type de service",created_date:"Date de crÃ©ation",last_update:"DerniÃ¨re mise Ã  jour",monthly_price:"Prix mensuel",next_billing:"Prochaine facturation",billing_cycle:"Cycle de facturation",configuration:"Configuration",hostname:"Nom d'hÃ´te",username:"Nom d'utilisateur",port:"Port",database:"Base de donnÃ©es",general_info:"Informations gÃ©nÃ©rales",recent_history:"Historique rÃ©cent",no_history:"Aucun historique disponible",back_to_services:"Retour aux services",manage_service:"GÃ©rer le service",all_statuses:"Tous les statuts",all_types:"Tous les types",type:"Type",web_hosting:"HÃ©bergement Web",vps:"Serveur Virtuel",domain:"Nom de Domaine",email:"Email",ssl:"Certificat SSL",search_placeholder:"Rechercher un service...",loading_services:"Chargement de vos services...",no_results:"Aucun service ne correspond Ã  vos critÃ¨res de recherche.",no_active_services:"Vous n'avez pas encore de services actifs.",order_service:"Commander un service",expires_on:"Expire le",statistics:"Statistiques",renew:"Renouveler"},billing:{title:"Facturation",pay_unpaid:"Payer les impayÃ©es",unpaid:"ImpayÃ©es",paid:"PayÃ©es",cancelled:"AnnulÃ©es",overdue:"En retard",download:"TÃ©lÃ©charger",pay:"Payer",pay_now:"Payer maintenant",invoice_number:"NumÃ©ro de facture",issue_date:"Date d'Ã©mission",due_date:"Date d'Ã©chÃ©ance",payment_date:"Date de paiement",total_amount:"Montant total",subtotal:"Sous-total",tax:"TVA",invoice_summary:"RÃ©sumÃ© de la facture",service_details:"DÃ©tail des services",payment_history:"Historique des paiements",description:"Description",period:"PÃ©riode",quantity:"QuantitÃ©",unit_price:"Prix unitaire",total:"Total",download_pdf:"TÃ©lÃ©charger PDF",back_to_billing:"Retour Ã  la facturation",payment_method:"MÃ©thode de paiement",payment_status:"Statut du paiement",no_invoices:"Aucune facture rÃ©cente",total_invoices:"Total Factures",unpaid_invoices:"Factures ImpayÃ©es",amount_due:"Montant DÃ»",total_paid:"Total PayÃ©",all_statuses:"Tous les statuts",draft:"Brouillon",all_periods:"Toutes les pÃ©riodes",current_month:"Ce mois",last_month:"Mois dernier",current_year:"Cette annÃ©e",last_year:"AnnÃ©e derniÃ¨re",search_placeholder:"NumÃ©ro de facture..."},support:{title:"Support",new_ticket:"Nouveau Ticket",my_tickets:"Mes Tickets",priority:"PrioritÃ©",open:"Ouvert",closed:"FermÃ©",pending:"En attente",reply:"RÃ©pondre",subject:"Sujet",message:"Message",department:"DÃ©partement",assigned_to:"AssignÃ© Ã ",ticket_info:"Informations du ticket",conversation:"Conversation",add_reply:"Ajouter une rÃ©ponse",your_message:"Votre message",attachments:"PiÃ¨ces jointes",attachments_optional:"PiÃ¨ces jointes (optionnel)",file_formats:"Formats acceptÃ©s: PDF, DOC, DOCX, TXT, JPG, PNG, GIF (max 10MB par fichier)",selected_files:"Fichiers sÃ©lectionnÃ©s:",send_reply:"Envoyer la rÃ©ponse",sending:"Envoi...",close_ticket:"Fermer le ticket",reopen_ticket:"Rouvrir le ticket",ticket_closed:"Ticket fermÃ©",ticket_closed_message:"Ce ticket a Ã©tÃ© fermÃ©. Pour ajouter une rÃ©ponse, vous devez d'abord le rouvrir.",back_to_support:"Retour au support",you:"Vous",support_team:"Support",priority_low:"Faible",priority_medium:"Moyenne",priority_high:"ÃlevÃ©e",priority_urgent:"Urgente",no_tickets:"Aucun ticket de support",create_ticket:"CrÃ©er un Ticket",create_ticket_desc:"Signaler un problÃ¨me ou demander de l'aide",knowledge_base:"Base de Connaissances",knowledge_base_desc:"Consultez nos guides et tutoriels",live_chat:"Chat en Direct",live_chat_desc:"Discutez avec notre Ã©quipe support",phone_support:"Support TÃ©lÃ©phonique",phone_support_desc:"Appelez-nous au +33 1 23 45 67 89"},account:{title:"Mon Compte",personal_info:"Informations personnelles",security:"SÃ©curitÃ©",change_password:"Changer le mot de passe",current_password:"Mot de passe actuel",new_password:"Nouveau mot de passe",confirm_password:"Confirmer le mot de passe",first_name:"PrÃ©nom",last_name:"Nom",email:"Email",company:"Entreprise",phone:"TÃ©lÃ©phone",address:"Adresse",city:"Ville",postal_code:"Code postal",country:"Pays",last_login:"DerniÃ¨re connexion",member_since:"Membre depuis",password_strength:"Force du mot de passe",last_password_change:"DerniÃ¨re modification",two_factor_auth:"Authentification Ã  deux facteurs",login_history:"Historique de connexion",edit_profile:"Modifier le profil",save_changes:"Enregistrer les modifications"},auth:{login:"Connexion",register:"Inscription",logout:"DÃ©connexion",email:"Email",password:"Mot de passe",remember_me:"Se souvenir de moi",forgot_password:"Mot de passe oubliÃ© ?",no_account:"Pas de compte ?",already_account:"DÃ©jÃ  un compte ?",sign_in:"Se connecter",sign_up:"S'inscrire",welcome_back:"Bon retour !",create_account:"CrÃ©er un compte",not_connected:"Non connectÃ©"},status:{active:"Actif",inactive:"Inactif",suspended:"Suspendu",terminated:"TerminÃ©",pending:"En attente",paid:"PayÃ©e",unpaid:"ImpayÃ©e",cancelled:"AnnulÃ©e",overdue:"En retard",open:"Ouvert",closed:"FermÃ©",completed:"TerminÃ©",failed:"ÃchouÃ©",expired:"ExpirÃ©"}},mo={common:{loading:"Loading...",error:"An error occurred",save:"Save",cancel:"Cancel",edit:"Edit",delete:"Delete",view:"View",export:"Export",search:"Search...",filter:"Filter",all:"All",active:"Active",inactive:"Inactive",status:"Status",date:"Date",amount:"Amount",back:"Back",refresh:"Refresh",download:"Download",close:"Close",open:"Open",retry:"Retry",send:"Send",reply:"Reply",month:"month",year:"year",day:"day",hour:"hour",minute:"minute",second:"second"},dashboard:{title:"Dashboard",client_interface:"Client Interface",my_services:"My Services",unpaid_invoices:"Unpaid Invoices",open_tickets:"Open Tickets",total_due:"Total Due",recent_services:"Recent Services",recent_invoices:"Recent Invoices",recent_tickets:"Recent Tickets",view_all:"View All",no_data:"No data available"},services:{title:"My Services",new_service:"New Service",manage:"Manage",filter_by_status:"Filter by status",no_services:"No services found",service_name:"Service name",service_type:"Service type",created_date:"Created date",last_update:"Last update",monthly_price:"Monthly price",next_billing:"Next billing",billing_cycle:"Billing cycle",configuration:"Configuration",hostname:"Hostname",username:"Username",port:"Port",database:"Database",general_info:"General information",recent_history:"Recent history",no_history:"No history available",back_to_services:"Back to services",manage_service:"Manage service",all_statuses:"All statuses",all_types:"All types",type:"Type",web_hosting:"Web Hosting",vps:"Virtual Server",domain:"Domain Name",email:"Email",ssl:"SSL Certificate",search_placeholder:"Search for a service...",loading_services:"Loading your services...",no_results:"No services match your search criteria.",no_active_services:"You don't have any active services yet.",order_service:"Order a service",expires_on:"Expires on",statistics:"Statistics",renew:"Renew"},billing:{title:"Billing",pay_unpaid:"Pay Unpaid",unpaid:"Unpaid",paid:"Paid",cancelled:"Cancelled",overdue:"Overdue",download:"Download",pay:"Pay",pay_now:"Pay now",invoice_number:"Invoice number",issue_date:"Issue date",due_date:"Due date",payment_date:"Payment date",total_amount:"Total amount",subtotal:"Subtotal",tax:"Tax",invoice_summary:"Invoice summary",service_details:"Service details",payment_history:"Payment history",description:"Description",period:"Period",quantity:"Quantity",unit_price:"Unit price",total:"Total",download_pdf:"Download PDF",back_to_billing:"Back to billing",payment_method:"Payment method",payment_status:"Payment status",no_invoices:"No recent invoices",total_invoices:"Total Invoices",unpaid_invoices:"Unpaid Invoices",amount_due:"Amount Due",total_paid:"Total Paid",all_statuses:"All statuses",draft:"Draft",all_periods:"All periods",current_month:"This month",last_month:"Last month",current_year:"This year",last_year:"Last year",search_placeholder:"Invoice number..."},support:{title:"Support",new_ticket:"New Ticket",my_tickets:"My Tickets",priority:"Priority",open:"Open",closed:"Closed",pending:"Pending",reply:"Reply",subject:"Subject",message:"Message",department:"Department",assigned_to:"Assigned to",ticket_info:"Ticket information",conversation:"Conversation",add_reply:"Add reply",your_message:"Your message",attachments:"Attachments",attachments_optional:"Attachments (optional)",file_formats:"Accepted formats: PDF, DOC, DOCX, TXT, JPG, PNG, GIF (max 10MB per file)",selected_files:"Selected files:",send_reply:"Send reply",sending:"Sending...",close_ticket:"Close ticket",reopen_ticket:"Reopen ticket",ticket_closed:"Ticket closed",ticket_closed_message:"This ticket has been closed. To add a reply, you must first reopen it.",back_to_support:"Back to support",you:"You",support_team:"Support",priority_low:"Low",priority_medium:"Medium",priority_high:"High",priority_urgent:"Urgent",no_tickets:"No support tickets",create_ticket:"Create Ticket",create_ticket_desc:"Report an issue or request help",knowledge_base:"Knowledge Base",knowledge_base_desc:"Browse our guides and tutorials",live_chat:"Live Chat",live_chat_desc:"Chat with our support team",phone_support:"Phone Support",phone_support_desc:"Call us at +33 1 23 45 67 89"},account:{title:"My Account",personal_info:"Personal information",security:"Security",change_password:"Change password",current_password:"Current password",new_password:"New password",confirm_password:"Confirm password",first_name:"First name",last_name:"Last name",email:"Email",company:"Company",phone:"Phone",address:"Address",city:"City",postal_code:"Postal code",country:"Country",last_login:"Last login",member_since:"Member since",password_strength:"Password strength",last_password_change:"Last password change",two_factor_auth:"Two-factor authentication",login_history:"Login history",edit_profile:"Edit profile",save_changes:"Save changes"},auth:{login:"Login",register:"Register",logout:"Logout",email:"Email",password:"Password",remember_me:"Remember me",forgot_password:"Forgot password?",no_account:"No account?",already_account:"Already have an account?",sign_in:"Sign in",sign_up:"Sign up",welcome_back:"Welcome back!",create_account:"Create account",not_connected:"Not connected"},status:{active:"Active",inactive:"Inactive",suspended:"Suspended",terminated:"Terminated",pending:"Pending",paid:"Paid",unpaid:"Unpaid",cancelled:"Cancelled",overdue:"Overdue",open:"Open",closed:"Closed",completed:"Completed",failed:"Failed",expired:"Expired"}},yo=H({legacy:!1,locale:localStorage.getItem("language")||"fr",fallbackLocale:"en",messages:{fr:vo,en:mo}});z.info("DÃ©marrage de l'application"),z.info("CrÃ©ation de l'application Vue");const bo=q(Mt);bo.config.errorHandler=(e,t,s)=>{const n=t?t.$.type.name:"UnknownComponent";z.error(`Erreur non capturÃ©e dans le composant: ${n}`,{error:e.toString(),stack:e.stack,info:s})},z.info("Initialisation de Pinia");const wo=G();wo.use(ae),bo.use(wo),z.info("Initialisation du Router"),bo.use(go),z.info("Initialisation de i18n"),bo.use(yo),z.info("FormKit a Ã©tÃ© retirÃ© car nous utilisons maintenant des composants standard"),z.info("Montage de l'application"),bo.mount("#vue-app"),z.info("Application montÃ©e avec succÃ¨s");export{F as A,qe as _,re as a,z as l,_e as u};
